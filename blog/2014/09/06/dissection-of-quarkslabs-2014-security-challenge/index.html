
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Dissection of Quarkslab's 2014 security challenge - Diary of a reverse-engineer</title>
  <meta name="author" content="Axel Souchet, Jonathan Salwan, Jérémy Fetiveau">

  
  <meta name="description" content="Introduction As the blog was a bit silent for quite some time, I figured it would be cool to put together a post ; so here it is folks, dig in! The &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://doar-e.github.io/blog/2014/09/06/dissection-of-quarkslabs-2014-security-challenge">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Diary of a reverse-engineer" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <script src="/javascripts/jquery.tableofcontents.min.js" type="text/javascript"></script>
  <script src="/javascripts/generate-toc.js" type="text/javascript"></script>

  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="https://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-43481215-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>



  <style>
    p { text-align: justify; }
  </style>

</head>
<body   class="collapse-sidebar sidebar-footer" >
  <header role="banner"><img src="/images/sigle-blanc-250px.jpg"></img>

	<div class="header-title"><a href="/">Diary of a reverse-engineer</a></div>


	<br><div class="header-subtitle">Because we like to play with weird things.</div>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:doar-e.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About</a></li>
  <li><a href="/presentations">Presentations</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
  
    
      <h1 class="entry-title">Dissection of Quarkslab's 2014 Security Challenge</h1>
    
  
    
      <p class="meta">
        








  


<time datetime="2014-09-06T20:37:00+01:00" pubdate data-updated="true">Sep 6<span>th</span>, 2014</time>
        
      </p>
    
  </header>


<div class="entry-content"><h1>Introduction</h1>

<p>As the blog was a bit silent for quite some time, I figured it would be cool to put together a post ; so here it is folks, dig in!</p>

<p>The French company <a href="http://blog.quarkslab.com/you-like-python-security-challenge-and-traveling-win-a-free-ticket-to-hitb-kul.html">Quarkslab</a> <a href="https://twitter.com/quarkslab/status/507457671386394624">recently</a> <a href="https://twitter.com/HITBSecConf/status/507458788522094592">released</a> a security challenge to win a free entrance to attend the upcoming <a href="https://conference.hitb.org/hitbsecconf2014kul/">HITBSecConf</a> conference in Kuala Lumpur from the 13th of October until the 16th.</p>

<p>The challenge has been written by <a href="http://blog.quarkslab.com/author/serge-guelton.html">Serge Guelton</a>, a R&amp;D engineer specialized in compilers/parallel computations. At the time of writing, already eight different people manage to solve the challenge, and one of the ticket seems to have been won by <code>hackedd</code>, so congrats to him!</p>

<p><img class="center" src="/images/dissection_of_quarkslab_s_2014_security_challenge/woot.png"></p>

<p>According to the description of the challenge Python is heavily involved, which is a good thing for at least two reasons:</p>

<ul>
<li>first because I already had <a href="https://doar-e.github.io/blog/2014/04/17/deep-dive-into-pythons-vm-story-of-load_const-bug/">the occasion</a> to look at its source code in the past,</li>
<li>and because I so am a <a href="https://github.com/0vercl0k/stuffz/tree/master/Python's%20internals">big fan of Python</a>.</li>
</ul>


<p>In this post I will describe how I tackled this problem, how I managed to solve it. And to make up for me being slow at solving it I tried to make it fairly detailed.</p>

<p>At first it was supposed to be quite short though, but well..I decided to analyze fully the challenge even if it wasn&rsquo;t needed to find the key unfortunately, so it is a bit longer than expected :&ndash;).</p>

<p>Anyway, sit down, make yourself at home and let me pour you a cup of tea before we begin :&ndash;).</p>

<div class='entry-content-toc'></div>




<!--more-->


<h1>Finding the URL of the challenge</h1>

<h2>Very one-liner, much lambdas, such a pain</h2>

<p>The first part of the challenge is to retrieve an url hidden in the following Python one-liner:</p>

<figure class='code'><figcaption><span>Very one-liner, much lambdas</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="p">(</span><span class="k">lambda</span> <span class="n">g</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="p">(</span><span class="n">_</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="s">&#39;$&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([(</span><span class="n">_</span><span class="p">[</span><span class="s">&#39;chr&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;chr&#39;</span>
</span><span class='line'><span class="ow">in</span> <span class="n">_</span><span class="p">)</span> <span class="k">else</span> <span class="nb">chr</span><span class="p">)((</span><span class="n">_</span><span class="p">[</span><span class="s">&#39;_&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;_&#39;</span> <span class="ow">in</span> <span class="n">_</span><span class="p">)</span> <span class="k">else</span> <span class="n">_</span><span class="p">))</span> <span class="k">for</span> <span class="n">_</span><span class="p">[</span><span class="s">&#39;_&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="n">_</span><span class="p">[</span><span class="s">&#39;s&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;s&#39;</span>
</span><span class='line'><span class="ow">in</span> <span class="n">_</span><span class="p">)</span> <span class="k">else</span> <span class="n">s</span><span class="p">)[::(</span><span class="o">-</span><span class="mi">1</span><span class="p">)]])),</span> <span class="n">_</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])(</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">f</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="n">f</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">_</span><span class="p">))((</span><span class="k">lambda</span>
</span><span class='line'><span class="n">__</span><span class="p">,</span><span class="n">_</span><span class="p">:</span> <span class="p">((</span><span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">__</span><span class="p">(</span><span class="n">__</span><span class="p">,</span> <span class="n">_</span><span class="p">))((</span><span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="p">(</span><span class="n">_</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="s">&#39;i&#39;</span><span class="p">,</span> <span class="p">((</span><span class="n">_</span><span class="p">[</span><span class="s">&#39;i&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;i&#39;</span>
</span><span class='line'><span class="ow">in</span> <span class="n">_</span><span class="p">)</span> <span class="k">else</span> <span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)),</span><span class="n">_</span><span class="p">)[(</span><span class="o">-</span><span class="mi">1</span><span class="p">)])((</span><span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="p">(</span><span class="n">_</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="s">&#39;s&#39;</span><span class="p">,((</span><span class="n">_</span><span class="p">[</span><span class="s">&#39;s&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;s&#39;</span>
</span><span class='line'><span class="ow">in</span> <span class="n">_</span><span class="p">)</span> <span class="k">else</span> <span class="n">s</span><span class="p">)</span> <span class="o">+</span> <span class="p">[((</span><span class="n">_</span><span class="p">[</span><span class="s">&#39;l&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;l&#39;</span> <span class="ow">in</span> <span class="n">_</span><span class="p">)</span> <span class="k">else</span> <span class="n">l</span><span class="p">)[(</span><span class="n">_</span><span class="p">[</span><span class="s">&#39;i&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;i&#39;</span> <span class="ow">in</span> <span class="n">_</span><span class="p">)</span> <span class="k">else</span> <span class="n">i</span>
</span><span class='line'><span class="p">)]</span> <span class="o">^</span> <span class="p">(</span><span class="n">_</span><span class="p">[</span><span class="s">&#39;c&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;c&#39;</span> <span class="ow">in</span> <span class="n">_</span><span class="p">)</span> <span class="k">else</span> <span class="n">c</span><span class="p">))])),</span> <span class="n">_</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])(</span><span class="n">_</span><span class="p">)))</span> <span class="k">if</span> <span class="p">(((</span><span class="n">_</span><span class="p">[</span><span class="s">&#39;g&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;g&#39;</span> <span class="ow">in</span>
</span><span class='line'><span class="n">_</span><span class="p">)</span> <span class="k">else</span> <span class="n">g</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="ow">and</span> <span class="p">((</span><span class="n">_</span><span class="p">[</span><span class="s">&#39;i&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;i&#39;</span> <span class="ow">in</span> <span class="n">_</span><span class="p">)</span> <span class="k">else</span> <span class="n">i</span><span class="p">)</span><span class="o">&lt;</span> <span class="p">(</span><span class="n">_</span><span class="p">[</span><span class="s">&#39;len&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;len&#39;</span> <span class="ow">in</span> <span class="n">_</span>
</span><span class='line'><span class="p">)</span> <span class="k">else</span> <span class="nb">len</span><span class="p">)((</span><span class="n">_</span><span class="p">[</span><span class="s">&#39;l&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;l&#39;</span> <span class="ow">in</span> <span class="n">_</span><span class="p">)</span> <span class="k">else</span> <span class="n">l</span><span class="p">))))</span> <span class="k">else</span> <span class="n">_</span><span class="p">)),</span> <span class="n">_</span><span class="p">)</span> <span class="p">)</span> <span class="p">(</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="p">(</span><span class="n">_</span><span class="o">.</span>
</span><span class='line'><span class="n">__setitem__</span><span class="p">(</span><span class="s">&#39;!&#39;</span><span class="p">,</span> <span class="p">[]),</span> <span class="n">_</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="s">&#39;s&#39;</span><span class="p">,</span> <span class="n">_</span><span class="p">[</span><span class="s">&#39;!&#39;</span><span class="p">]),</span> <span class="n">_</span><span class="p">)[(</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="p">)</span> <span class="p">((</span><span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="p">(</span><span class="n">_</span><span class="o">.</span>
</span><span class='line'><span class="n">__setitem__</span><span class="p">(</span><span class="s">&#39;!&#39;</span><span class="p">,</span> <span class="p">((</span><span class="n">_</span><span class="p">[</span><span class="s">&#39;d&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;d&#39;</span> <span class="ow">in</span> <span class="n">_</span><span class="p">)</span> <span class="k">else</span> <span class="n">d</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">_</span><span class="p">[</span><span class="s">&#39;d&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;d&#39;</span> <span class="ow">in</span> <span class="n">_</span><span class="p">)</span> <span class="k">else</span>
</span><span class='line'><span class="n">d</span><span class="p">))),</span> <span class="n">_</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="s">&#39;i&#39;</span><span class="p">,</span> <span class="n">_</span><span class="p">[</span><span class="s">&#39;!&#39;</span><span class="p">]),</span> <span class="n">_</span><span class="p">)[(</span><span class="o">-</span><span class="mi">1</span><span class="p">)])((</span><span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="p">(</span><span class="n">_</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="s">&#39;!&#39;</span><span class="p">,</span> <span class="p">[</span>
</span><span class='line'><span class="p">(</span><span class="n">_</span><span class="p">[</span><span class="s">&#39;j&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;j&#39;</span> <span class="ow">in</span> <span class="n">_</span><span class="p">)</span> <span class="k">else</span> <span class="n">j</span><span class="p">)</span> <span class="k">for</span>  <span class="n">_</span><span class="p">[</span> <span class="s">&#39;i&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="n">_</span><span class="p">[</span><span class="s">&#39;zip&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;zip&#39;</span> <span class="ow">in</span> <span class="n">_</span><span class="p">)</span> <span class="k">else</span>
</span><span class='line'><span class="nb">zip</span><span class="p">)((</span><span class="n">_</span><span class="p">[</span><span class="s">&#39;l0&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;l0&#39;</span> <span class="ow">in</span> <span class="n">_</span><span class="p">)</span> <span class="k">else</span> <span class="n">l0</span><span class="p">),</span> <span class="p">(</span><span class="n">_</span><span class="p">[</span><span class="s">&#39;l1&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;l1&#39;</span> <span class="ow">in</span> <span class="n">_</span><span class="p">)</span> <span class="k">else</span> <span class="n">l1</span><span class="p">))</span> <span class="k">for</span>
</span><span class='line'><span class="n">_</span><span class="p">[</span><span class="s">&#39;j&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="n">_</span><span class="p">[</span><span class="s">&#39;i&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;i&#39;</span> <span class="ow">in</span> <span class="n">_</span><span class="p">)</span> <span class="k">else</span> <span class="n">i</span><span class="p">)]),</span> <span class="n">_</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="s">&#39;l&#39;</span><span class="p">,</span> <span class="n">_</span><span class="p">[</span><span class="s">&#39;!&#39;</span><span class="p">]),</span> <span class="n">_</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span>
</span><span class='line'><span class="p">])((</span><span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="p">(</span><span class="n">_</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="s">&#39;!&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1373</span><span class="p">,</span> <span class="mi">1281</span><span class="p">,</span> <span class="mi">1288</span><span class="p">,</span> <span class="mi">1373</span><span class="p">,</span> <span class="mi">1290</span><span class="p">,</span> <span class="mi">1294</span><span class="p">,</span> <span class="mi">1375</span><span class="p">,</span>
</span><span class='line'><span class="mi">1371</span><span class="p">,</span><span class="mi">1289</span><span class="p">,</span> <span class="mi">1281</span><span class="p">,</span> <span class="mi">1280</span><span class="p">,</span> <span class="mi">1293</span><span class="p">,</span> <span class="mi">1289</span><span class="p">,</span> <span class="mi">1280</span><span class="p">,</span> <span class="mi">1373</span><span class="p">,</span> <span class="mi">1294</span><span class="p">,</span> <span class="mi">1289</span><span class="p">,</span> <span class="mi">1280</span><span class="p">,</span> <span class="mi">1372</span><span class="p">,</span> <span class="mi">1288</span><span class="p">,</span>
</span><span class='line'><span class="mi">1375</span><span class="p">,</span><span class="mi">1375</span><span class="p">,</span> <span class="mi">1289</span><span class="p">,</span> <span class="mi">1373</span><span class="p">,</span> <span class="mi">1290</span><span class="p">,</span> <span class="mi">1281</span><span class="p">,</span> <span class="mi">1294</span><span class="p">,</span> <span class="mi">1302</span><span class="p">,</span> <span class="mi">1372</span><span class="p">,</span> <span class="mi">1355</span><span class="p">,</span> <span class="mi">1366</span><span class="p">,</span> <span class="mi">1372</span><span class="p">,</span> <span class="mi">1302</span><span class="p">,</span>
</span><span class='line'><span class="mi">1360</span><span class="p">,</span> <span class="mi">1368</span><span class="p">,</span> <span class="mi">1354</span><span class="p">,</span> <span class="mi">1364</span><span class="p">,</span> <span class="mi">1370</span><span class="p">,</span> <span class="mi">1371</span><span class="p">,</span> <span class="mi">1365</span><span class="p">,</span> <span class="mi">1362</span><span class="p">,</span> <span class="mi">1368</span><span class="p">,</span> <span class="mi">1352</span><span class="p">,</span> <span class="mi">1374</span><span class="p">,</span> <span class="mi">1365</span><span class="p">,</span> <span class="mi">1302</span>
</span><span class='line'><span class="p">]),</span> <span class="n">_</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="s">&#39;l1&#39;</span><span class="p">,</span><span class="n">_</span><span class="p">[</span><span class="s">&#39;!&#39;</span><span class="p">]),</span> <span class="n">_</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])((</span><span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="p">(</span><span class="n">_</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="s">&#39;!&#39;</span><span class="p">,[</span><span class="mi">1375</span><span class="p">,</span>
</span><span class='line'><span class="mi">1368</span><span class="p">,</span> <span class="mi">1294</span><span class="p">,</span> <span class="mi">1293</span><span class="p">,</span> <span class="mi">1373</span><span class="p">,</span> <span class="mi">1295</span><span class="p">,</span> <span class="mi">1290</span><span class="p">,</span> <span class="mi">1373</span><span class="p">,</span> <span class="mi">1290</span><span class="p">,</span> <span class="mi">1293</span><span class="p">,</span> <span class="mi">1280</span><span class="p">,</span> <span class="mi">1368</span><span class="p">,</span> <span class="mi">1368</span><span class="p">,</span><span class="mi">1294</span><span class="p">,</span>
</span><span class='line'><span class="mi">1293</span><span class="p">,</span> <span class="mi">1368</span><span class="p">,</span> <span class="mi">1372</span><span class="p">,</span> <span class="mi">1292</span><span class="p">,</span> <span class="mi">1290</span><span class="p">,</span> <span class="mi">1291</span><span class="p">,</span> <span class="mi">1371</span><span class="p">,</span> <span class="mi">1375</span><span class="p">,</span> <span class="mi">1280</span><span class="p">,</span> <span class="mi">1372</span><span class="p">,</span> <span class="mi">1281</span><span class="p">,</span> <span class="mi">1293</span><span class="p">,</span><span class="mi">1373</span><span class="p">,</span>
</span><span class='line'><span class="mi">1371</span><span class="p">,</span> <span class="mi">1354</span><span class="p">,</span> <span class="mi">1370</span><span class="p">,</span> <span class="mi">1356</span><span class="p">,</span> <span class="mi">1354</span><span class="p">,</span> <span class="mi">1355</span><span class="p">,</span> <span class="mi">1370</span><span class="p">,</span> <span class="mi">1357</span><span class="p">,</span> <span class="mi">1357</span><span class="p">,</span> <span class="mi">1302</span><span class="p">,</span> <span class="mi">1366</span><span class="p">,</span> <span class="mi">1303</span><span class="p">,</span><span class="mi">1368</span><span class="p">,</span>
</span><span class='line'><span class="mi">1354</span><span class="p">,</span> <span class="mi">1355</span><span class="p">,</span> <span class="mi">1356</span><span class="p">,</span> <span class="mi">1303</span><span class="p">,</span> <span class="mi">1366</span><span class="p">,</span> <span class="mi">1371</span><span class="p">]),</span> <span class="n">_</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="s">&#39;l0&#39;</span><span class="p">,</span> <span class="n">_</span><span class="p">[</span><span class="s">&#39;!&#39;</span><span class="p">]),</span> <span class="n">_</span><span class="p">)[(</span><span class="o">-</span><span class="mi">1</span><span class="p">)])</span>
</span><span class='line'>            <span class="p">({</span> <span class="s">&#39;g&#39;</span><span class="p">:</span> <span class="n">g</span><span class="p">,</span> <span class="s">&#39;c&#39;</span><span class="p">:</span> <span class="n">c</span><span class="p">,</span> <span class="s">&#39;d&#39;</span><span class="p">:</span> <span class="n">d</span><span class="p">,</span> <span class="s">&#39;$&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">})))))))[</span><span class="s">&#39;$&#39;</span><span class="p">])</span>
</span></code></pre></td></tr></table></div></figure>


<p>I think that was the first time I was seeing obfuscated Python and believe me I did a really strange face when seeing that snippet. But well, with a bit of patience we should manage to get a better understanding of how it is working, let&rsquo;s get to it!</p>

<h2>Tidying up the last one..</h2>

<p>Before doing that here are things we can directly observe just by looking closely at the snippet:</p>

<ul>
<li>We know this function has three arguments ; we don&rsquo;t know them at this point though</li>
<li>The snippet seems to reuse <em>__setitem__</em> quite a lot ; it may mean two things for us:

<ul>
<li>The only standard Python object I know of with a <em>__setitem__</em> function is <em>dictionary</em>,</li>
<li>The way the snippet looks like, it seems that once we will understand one of those <em>__setitem__</em> call, we will understand them all</li>
</ul>
</li>
<li>The following standard functions are used: <em>chr</em>, <em>len</em>, <em>zip</em>

<ul>
<li>That means manipulation of strings, integers and iterables</li>
</ul>
</li>
<li>There are two noticeable operators: <em>mod</em> and <em>xor</em></li>
</ul>


<p>With all that information in our sleeve, the first thing I did was to try to clean it up, starting from the last lambda in the snippet. It gives something like:</p>

<figure class='code'><figcaption><span>Last lambda cleaned</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">tab0</span> <span class="o">=</span> <span class="p">[</span>
</span><span class='line'>    <span class="mi">1375</span><span class="p">,</span> <span class="mi">1368</span><span class="p">,</span> <span class="mi">1294</span><span class="p">,</span> <span class="mi">1293</span><span class="p">,</span> <span class="mi">1373</span><span class="p">,</span> <span class="mi">1295</span><span class="p">,</span> <span class="mi">1290</span><span class="p">,</span> <span class="mi">1373</span><span class="p">,</span> <span class="mi">1290</span><span class="p">,</span> <span class="mi">1293</span><span class="p">,</span>
</span><span class='line'>    <span class="mi">1280</span><span class="p">,</span> <span class="mi">1368</span><span class="p">,</span> <span class="mi">1368</span><span class="p">,</span> <span class="mi">1294</span><span class="p">,</span> <span class="mi">1293</span><span class="p">,</span> <span class="mi">1368</span><span class="p">,</span> <span class="mi">1372</span><span class="p">,</span> <span class="mi">1292</span><span class="p">,</span> <span class="mi">1290</span><span class="p">,</span> <span class="mi">1291</span><span class="p">,</span>
</span><span class='line'>    <span class="mi">1371</span><span class="p">,</span> <span class="mi">1375</span><span class="p">,</span> <span class="mi">1280</span><span class="p">,</span> <span class="mi">1372</span><span class="p">,</span> <span class="mi">1281</span><span class="p">,</span> <span class="mi">1293</span><span class="p">,</span> <span class="mi">1373</span><span class="p">,</span> <span class="mi">1371</span><span class="p">,</span> <span class="mi">1354</span><span class="p">,</span> <span class="mi">1370</span><span class="p">,</span>
</span><span class='line'>    <span class="mi">1356</span><span class="p">,</span> <span class="mi">1354</span><span class="p">,</span> <span class="mi">1355</span><span class="p">,</span> <span class="mi">1370</span><span class="p">,</span> <span class="mi">1357</span><span class="p">,</span> <span class="mi">1357</span><span class="p">,</span> <span class="mi">1302</span><span class="p">,</span> <span class="mi">1366</span><span class="p">,</span> <span class="mi">1303</span><span class="p">,</span> <span class="mi">1368</span><span class="p">,</span>
</span><span class='line'>    <span class="mi">1354</span><span class="p">,</span> <span class="mi">1355</span><span class="p">,</span> <span class="mi">1356</span><span class="p">,</span> <span class="mi">1303</span><span class="p">,</span> <span class="mi">1366</span><span class="p">,</span> <span class="mi">1371</span>
</span><span class='line'><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="n">z</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span>
</span><span class='line'>    <span class="n">x</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="s">&#39;!&#39;</span><span class="p">,</span> <span class="n">tab0</span><span class="p">),</span>
</span><span class='line'>    <span class="n">x</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="s">&#39;l0&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="s">&#39;!&#39;</span><span class="p">]),</span>
</span><span class='line'>    <span class="n">x</span>
</span><span class='line'><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>That lambda takes a dictionary <em>x</em>, sets two items, generates a tuple with a reference to the dictionary at the end of the tuple ; finally the lambda is going to return that same dictionary.
It also uses <em>x[&lsquo;!&rsquo;]</em> as a temporary variable to then assign its value to <em>x[&lsquo;l0&rsquo;]</em>.</p>

<p>Long story short, it basically takes a dictionary, updates it and returns it to the caller: clever trick to pass that same object across lambdas. We can also see that easily in Python directly:</p>

<figure class='code'><figcaption><span>lambda, dictionary & setitem</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>In [8]: d = {}
</span><span class='line'>In [9]: z(d)
</span><span class='line'>Out[9]:
</span><span class='line'>{&#39;!&#39;: [1375,
</span><span class='line'>  ...
</span><span class='line'> &#39;l0&#39;: [1375,
</span><span class='line'>  ...
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>That lambda is even called with a dictionary that will contain, among other things, the three user controlled variable: <em>g</em>, <em>c</em>, <em>d</em>.
That dictionary seems to be some kind of storage used to keep track of all the variables that will be used across those lambdas.</p>

<figure class='code'><figcaption><span>lambda & the resulting dictionary</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c"># Returns { &#39;g&#39; : g, &#39;c&#39;, &#39;d&#39;: d, &#39;$&#39;:None, &#39;!&#39;:tab0, &#39;l0&#39;:tab0}</span>
</span><span class='line'><span class="n">last_res</span> <span class="o">=</span> <span class="p">(</span>
</span><span class='line'>    <span class="p">(</span>
</span><span class='line'>        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span>
</span><span class='line'>            <span class="n">x</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="s">&#39;!&#39;</span><span class="p">,</span> <span class="n">tab0</span><span class="p">),</span>
</span><span class='line'>            <span class="n">x</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="s">&#39;l0&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="s">&#39;!&#39;</span><span class="p">]),</span>
</span><span class='line'>            <span class="n">x</span>
</span><span class='line'>        <span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>    <span class="p">({</span> <span class="s">&#39;g&#39;</span><span class="p">:</span> <span class="n">g</span><span class="p">,</span> <span class="s">&#39;c&#39;</span><span class="p">:</span> <span class="n">c</span><span class="p">,</span> <span class="s">&#39;d&#39;</span><span class="p">:</span> <span class="n">d</span><span class="p">,</span> <span class="s">&#39;$&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">})</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>..then the one before&hellip;</h2>

<p>Now if we repeat that same operation with the one before the last lambda, we have the exact same pattern:</p>

<figure class='code'><figcaption><span>lambda before the last one</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">tab1</span> <span class="o">=</span> <span class="p">[</span>
</span><span class='line'>    <span class="mi">1373</span><span class="p">,</span> <span class="mi">1281</span><span class="p">,</span> <span class="mi">1288</span><span class="p">,</span> <span class="mi">1373</span><span class="p">,</span> <span class="mi">1290</span><span class="p">,</span> <span class="mi">1294</span><span class="p">,</span> <span class="mi">1375</span><span class="p">,</span> <span class="mi">1371</span><span class="p">,</span> <span class="mi">1289</span><span class="p">,</span> <span class="mi">1281</span><span class="p">,</span>
</span><span class='line'>    <span class="mi">1280</span><span class="p">,</span> <span class="mi">1293</span><span class="p">,</span> <span class="mi">1289</span><span class="p">,</span> <span class="mi">1280</span><span class="p">,</span> <span class="mi">1373</span><span class="p">,</span> <span class="mi">1294</span><span class="p">,</span> <span class="mi">1289</span><span class="p">,</span> <span class="mi">1280</span><span class="p">,</span> <span class="mi">1372</span><span class="p">,</span> <span class="mi">1288</span><span class="p">,</span>
</span><span class='line'>    <span class="mi">1375</span><span class="p">,</span> <span class="mi">1375</span><span class="p">,</span> <span class="mi">1289</span><span class="p">,</span> <span class="mi">1373</span><span class="p">,</span> <span class="mi">1290</span><span class="p">,</span> <span class="mi">1281</span><span class="p">,</span> <span class="mi">1294</span><span class="p">,</span> <span class="mi">1302</span><span class="p">,</span> <span class="mi">1372</span><span class="p">,</span> <span class="mi">1355</span><span class="p">,</span>
</span><span class='line'>    <span class="mi">1366</span><span class="p">,</span> <span class="mi">1372</span><span class="p">,</span> <span class="mi">1302</span><span class="p">,</span> <span class="mi">1360</span><span class="p">,</span> <span class="mi">1368</span><span class="p">,</span> <span class="mi">1354</span><span class="p">,</span> <span class="mi">1364</span><span class="p">,</span> <span class="mi">1370</span><span class="p">,</span> <span class="mi">1371</span><span class="p">,</span> <span class="mi">1365</span><span class="p">,</span>
</span><span class='line'>    <span class="mi">1362</span><span class="p">,</span> <span class="mi">1368</span><span class="p">,</span> <span class="mi">1352</span><span class="p">,</span> <span class="mi">1374</span><span class="p">,</span> <span class="mi">1365</span><span class="p">,</span> <span class="mi">1302</span>
</span><span class='line'><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="n">zz</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span>
</span><span class='line'>    <span class="n">x</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="s">&#39;!&#39;</span><span class="p">,</span> <span class="n">tab1</span><span class="p">),</span>
</span><span class='line'>    <span class="n">x</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="s">&#39;l1&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="s">&#39;!&#39;</span><span class="p">]),</span>
</span><span class='line'>    <span class="n">x</span>
</span><span class='line'><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Perfect, now let&rsquo;s repeat the same operations over and over again. At some point, the whole thing becomes crystal clear (sort-of):</p>

<figure class='code'><figcaption><span>cleaned nested lambdas</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c"># Returns { </span>
</span><span class='line'>  <span class="c"># &#39;g&#39;:g, &#39;c&#39;:c, &#39;d&#39;:d,</span>
</span><span class='line'>  <span class="c"># &#39;!&#39;:[],</span>
</span><span class='line'>  <span class="c"># &#39;s&#39;:[],</span>
</span><span class='line'>  <span class="c"># &#39;l&#39;:[j for i in zip(tab0, tab1) for j in i],</span>
</span><span class='line'>  <span class="c"># &#39;l1&#39;:tab1,</span>
</span><span class='line'>  <span class="c"># &#39;l0&#39;:tab0,</span>
</span><span class='line'>  <span class="c"># &#39;i&#39;: 0,</span>
</span><span class='line'>  <span class="c"># &#39;j&#39;: 1302,</span>
</span><span class='line'>  <span class="c"># &#39;$&#39;:None</span>
</span><span class='line'><span class="c">#}</span>
</span><span class='line'><span class="n">res_after_all_operations</span> <span class="o">=</span> <span class="p">(</span>
</span><span class='line'>  <span class="p">(</span>
</span><span class='line'>    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span>
</span><span class='line'>        <span class="n">x</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="s">&#39;!&#39;</span><span class="p">,</span> <span class="p">[]),</span>
</span><span class='line'>        <span class="n">x</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="s">&#39;s&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="s">&#39;!&#39;</span><span class="p">]),</span>
</span><span class='line'>        <span class="n">x</span>
</span><span class='line'>    <span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span class='line'>  <span class="p">)</span>
</span><span class='line'>  <span class="c"># ..</span>
</span><span class='line'>  <span class="p">(</span>
</span><span class='line'>    <span class="p">(</span>
</span><span class='line'>      <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span>
</span><span class='line'>          <span class="n">x</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="s">&#39;!&#39;</span><span class="p">,</span> <span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="s">&#39;d&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;d&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="n">d</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s">&#39;d&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;d&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="n">d</span><span class="p">))),</span>
</span><span class='line'>          <span class="n">x</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="s">&#39;i&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="s">&#39;!&#39;</span><span class="p">]),</span>
</span><span class='line'>          <span class="n">x</span>
</span><span class='line'>      <span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>    <span class="c"># ..</span>
</span><span class='line'>    <span class="p">(</span>
</span><span class='line'>      <span class="p">(</span>
</span><span class='line'>        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span>
</span><span class='line'>            <span class="n">x</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="s">&#39;!&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="n">x</span><span class="p">[</span><span class="s">&#39;j&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;j&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">[</span> <span class="s">&#39;i&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s">&#39;zip&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;zip&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="nb">zip</span><span class="p">)((</span><span class="n">x</span><span class="p">[</span><span class="s">&#39;l0&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;l0&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="n">l0</span><span class="p">),</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s">&#39;l1&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;l1&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="n">l1</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span><span class="p">[</span><span class="s">&#39;j&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s">&#39;i&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;i&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="n">i</span><span class="p">)]),</span>
</span><span class='line'>            <span class="n">x</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="s">&#39;l&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="s">&#39;!&#39;</span><span class="p">]),</span>
</span><span class='line'>            <span class="n">x</span>
</span><span class='line'>        <span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span class='line'>      <span class="p">)</span>
</span><span class='line'>      <span class="c"># Returns { &#39;g&#39;:g, &#39;c&#39;:c, &#39;d&#39;:d, &#39;!&#39;:tab1, &#39;l1&#39;:tab1, &#39;l0&#39;:tab0, &#39;$&#39;:None}</span>
</span><span class='line'>      <span class="p">(</span>
</span><span class='line'>        <span class="p">(</span>
</span><span class='line'>          <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span>
</span><span class='line'>              <span class="n">x</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="s">&#39;!&#39;</span><span class="p">,</span> <span class="n">tab1</span><span class="p">),</span>
</span><span class='line'>              <span class="n">x</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="s">&#39;l1&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="s">&#39;!&#39;</span><span class="p">]),</span>
</span><span class='line'>              <span class="n">x</span>
</span><span class='line'>          <span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>        <span class="c"># Return { &#39;g&#39; : g, &#39;c&#39;, &#39;d&#39;: d, &#39;!&#39;:tab0, &#39;l0&#39;:tab0, &#39;$&#39;:None }</span>
</span><span class='line'>        <span class="p">(</span>
</span><span class='line'>          <span class="p">(</span>
</span><span class='line'>            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span>
</span><span class='line'>                <span class="n">x</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="s">&#39;!&#39;</span><span class="p">,</span> <span class="n">tab0</span><span class="p">),</span>
</span><span class='line'>                <span class="n">x</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="s">&#39;l0&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="s">&#39;!&#39;</span><span class="p">]),</span>
</span><span class='line'>                <span class="n">x</span>
</span><span class='line'>            <span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span class='line'>          <span class="p">)</span>
</span><span class='line'>          <span class="p">({</span> <span class="s">&#39;g&#39;</span><span class="p">:</span> <span class="n">g</span><span class="p">,</span> <span class="s">&#39;c&#39;</span><span class="p">:</span> <span class="n">c</span><span class="p">,</span> <span class="s">&#39;d&#39;</span><span class="p">:</span> <span class="n">d</span><span class="p">,</span> <span class="s">&#39;$&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">})</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>      <span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>  <span class="p">)</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Putting it all together</h2>

<p>After doing all of that, we know now the types of the three variables the function needs to work properly (and we don&rsquo;t really need more to be honest):</p>

<ul>
<li><em>g</em> is an integer that will be mod 4

<ul>
<li>if the value is divisible by 4, the function returns nothing ; so we will need to have this variable sets to 1 for example</li>
</ul>
</li>
<li><em>c</em> is another integer that looks like a xor key ; if we look at the snippet, this variable is used to xor each byte of <em>x[&lsquo;l&rsquo;]</em> (which is the table with tab0 and tab1)

<ul>
<li>this is the interesting parameter</li>
</ul>
</li>
<li><em>d</em> is another integer that we can also ignore: it&rsquo;s only used to set <em>x[&lsquo;i&rsquo;]</em> to zero by xoring <em>x[&rsquo;d&#8217;]</em> by itself.</li>
</ul>


<p>We don&rsquo;t need anything else really now: no more lambdas, no more pain, no more tears. It is time to write what I call, an <a href="https://github.com/0vercl0k/stuffz/blob/master/ql-chall-python-2014/bf_with_lambdas_cleaned.py"><em>educated</em> brute-forcer</a>, to find the correct value of <em>c</em>:</p>

<figure class='code'><figcaption><span>bf_with_lambdas_cleaned.py</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">sys</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">):</span>
</span><span class='line'>    <span class="n">tab0</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1375</span><span class="p">,</span> <span class="mi">1368</span><span class="p">,</span> <span class="mi">1294</span><span class="p">,</span> <span class="mi">1293</span><span class="p">,</span> <span class="mi">1373</span><span class="p">,</span> <span class="mi">1295</span><span class="p">,</span> <span class="mi">1290</span><span class="p">,</span> <span class="mi">1373</span><span class="p">,</span> <span class="mi">1290</span><span class="p">,</span> <span class="mi">1293</span><span class="p">,</span> <span class="mi">1280</span><span class="p">,</span> <span class="mi">1368</span><span class="p">,</span> <span class="mi">1368</span><span class="p">,</span><span class="mi">1294</span><span class="p">,</span> <span class="mi">1293</span><span class="p">,</span> <span class="mi">1368</span><span class="p">,</span> <span class="mi">1372</span><span class="p">,</span> <span class="mi">1292</span><span class="p">,</span> <span class="mi">1290</span><span class="p">,</span> <span class="mi">1291</span><span class="p">,</span> <span class="mi">1371</span><span class="p">,</span> <span class="mi">1375</span><span class="p">,</span> <span class="mi">1280</span><span class="p">,</span> <span class="mi">1372</span><span class="p">,</span> <span class="mi">1281</span><span class="p">,</span> <span class="mi">1293</span><span class="p">,</span><span class="mi">1373</span><span class="p">,</span> <span class="mi">1371</span><span class="p">,</span> <span class="mi">1354</span><span class="p">,</span> <span class="mi">1370</span><span class="p">,</span> <span class="mi">1356</span><span class="p">,</span> <span class="mi">1354</span><span class="p">,</span> <span class="mi">1355</span><span class="p">,</span> <span class="mi">1370</span><span class="p">,</span> <span class="mi">1357</span><span class="p">,</span> <span class="mi">1357</span><span class="p">,</span> <span class="mi">1302</span><span class="p">,</span> <span class="mi">1366</span><span class="p">,</span> <span class="mi">1303</span><span class="p">,</span><span class="mi">1368</span><span class="p">,</span> <span class="mi">1354</span><span class="p">,</span> <span class="mi">1355</span><span class="p">,</span> <span class="mi">1356</span><span class="p">,</span> <span class="mi">1303</span><span class="p">,</span> <span class="mi">1366</span><span class="p">,</span> <span class="mi">1371</span><span class="p">]</span>
</span><span class='line'>    <span class="n">tab1</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1373</span><span class="p">,</span> <span class="mi">1281</span><span class="p">,</span> <span class="mi">1288</span><span class="p">,</span> <span class="mi">1373</span><span class="p">,</span> <span class="mi">1290</span><span class="p">,</span> <span class="mi">1294</span><span class="p">,</span> <span class="mi">1375</span><span class="p">,</span> <span class="mi">1371</span><span class="p">,</span><span class="mi">1289</span><span class="p">,</span> <span class="mi">1281</span><span class="p">,</span> <span class="mi">1280</span><span class="p">,</span> <span class="mi">1293</span><span class="p">,</span> <span class="mi">1289</span><span class="p">,</span> <span class="mi">1280</span><span class="p">,</span> <span class="mi">1373</span><span class="p">,</span> <span class="mi">1294</span><span class="p">,</span> <span class="mi">1289</span><span class="p">,</span> <span class="mi">1280</span><span class="p">,</span> <span class="mi">1372</span><span class="p">,</span> <span class="mi">1288</span><span class="p">,</span> <span class="mi">1375</span><span class="p">,</span><span class="mi">1375</span><span class="p">,</span> <span class="mi">1289</span><span class="p">,</span> <span class="mi">1373</span><span class="p">,</span> <span class="mi">1290</span><span class="p">,</span> <span class="mi">1281</span><span class="p">,</span> <span class="mi">1294</span><span class="p">,</span> <span class="mi">1302</span><span class="p">,</span> <span class="mi">1372</span><span class="p">,</span> <span class="mi">1355</span><span class="p">,</span> <span class="mi">1366</span><span class="p">,</span> <span class="mi">1372</span><span class="p">,</span> <span class="mi">1302</span><span class="p">,</span> <span class="mi">1360</span><span class="p">,</span> <span class="mi">1368</span><span class="p">,</span> <span class="mi">1354</span><span class="p">,</span> <span class="mi">1364</span><span class="p">,</span> <span class="mi">1370</span><span class="p">,</span> <span class="mi">1371</span><span class="p">,</span> <span class="mi">1365</span><span class="p">,</span> <span class="mi">1362</span><span class="p">,</span> <span class="mi">1368</span><span class="p">,</span> <span class="mi">1352</span><span class="p">,</span> <span class="mi">1374</span><span class="p">,</span> <span class="mi">1365</span><span class="p">,</span> <span class="mi">1302</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">func</span> <span class="o">=</span> <span class="p">(</span>
</span><span class='line'>        <span class="k">lambda</span> <span class="n">g</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span>
</span><span class='line'>        <span class="p">(</span>
</span><span class='line'>            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span>
</span><span class='line'>                <span class="n">x</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="s">&#39;$&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([(</span><span class="n">x</span><span class="p">[</span><span class="s">&#39;chr&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;chr&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="nb">chr</span><span class="p">)((</span><span class="n">x</span><span class="p">[</span><span class="s">&#39;_&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;_&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span><span class="p">[</span><span class="s">&#39;_&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s">&#39;s&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;s&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="n">s</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]])),</span>
</span><span class='line'>                <span class="n">x</span>
</span><span class='line'>            <span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>        <span class="p">(</span>
</span><span class='line'>            <span class="p">(</span>
</span><span class='line'>                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span>
</span><span class='line'>                    <span class="p">(</span><span class="k">lambda</span> <span class="n">f</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">f</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
</span><span class='line'>                <span class="p">(</span>
</span><span class='line'>                    <span class="p">(</span>
</span><span class='line'>                        <span class="k">lambda</span> <span class="n">__</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span>
</span><span class='line'>                        <span class="p">(</span>
</span><span class='line'>                            <span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">__</span><span class="p">(</span><span class="n">__</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
</span><span class='line'>                            <span class="p">(</span>
</span><span class='line'>                                <span class="c"># i += 1</span>
</span><span class='line'>                                <span class="p">(</span>
</span><span class='line'>                                    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span>
</span><span class='line'>                                        <span class="n">x</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="s">&#39;i&#39;</span><span class="p">,</span> <span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="s">&#39;i&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;i&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)),</span>
</span><span class='line'>                                        <span class="n">x</span>
</span><span class='line'>                                    <span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span class='line'>                                <span class="p">)</span>
</span><span class='line'>                                <span class="p">(</span>
</span><span class='line'>                                    <span class="c"># s += [c ^ l[i]]</span>
</span><span class='line'>                                    <span class="p">(</span>
</span><span class='line'>                                        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span>
</span><span class='line'>                                            <span class="n">x</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="s">&#39;s&#39;</span><span class="p">,</span> <span class="p">(</span>
</span><span class='line'>                                                    <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s">&#39;s&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;s&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="n">s</span><span class="p">)</span> <span class="o">+</span>
</span><span class='line'>                                                    <span class="p">[((</span><span class="n">x</span><span class="p">[</span><span class="s">&#39;l&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;l&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="n">l</span><span class="p">)[(</span><span class="n">x</span><span class="p">[</span><span class="s">&#39;i&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;i&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="n">i</span><span class="p">)]</span> <span class="o">^</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s">&#39;c&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;c&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="n">c</span><span class="p">))]</span>
</span><span class='line'>                                                <span class="p">)</span>
</span><span class='line'>                                            <span class="p">),</span>
</span><span class='line'>                                            <span class="n">x</span>
</span><span class='line'>                                        <span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span class='line'>                                    <span class="p">)</span>
</span><span class='line'>                                    <span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span class='line'>                                <span class="p">)</span>
</span><span class='line'>                            <span class="p">)</span>
</span><span class='line'>                            <span class="c"># if ((x[&#39;g&#39;] % 4) and (x[&#39;i&#39;] &lt; len(l))) else x</span>
</span><span class='line'>                            <span class="k">if</span> <span class="p">(((</span><span class="n">x</span><span class="p">[</span><span class="s">&#39;g&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;g&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="n">g</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="ow">and</span> <span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="s">&#39;i&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;i&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="n">i</span><span class="p">)</span><span class="o">&lt;</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s">&#39;len&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;len&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="nb">len</span><span class="p">)((</span><span class="n">x</span><span class="p">[</span><span class="s">&#39;l&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;l&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="n">l</span><span class="p">))))</span>
</span><span class='line'>                            <span class="k">else</span> <span class="n">x</span>
</span><span class='line'>                        <span class="p">)</span>
</span><span class='line'>                    <span class="p">),</span>
</span><span class='line'>                    <span class="n">x</span>
</span><span class='line'>                <span class="p">)</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>            <span class="c"># Returns { &#39;g&#39;:g, &#39;c&#39;:c, &#39;d&#39;:d, &#39;!&#39;:zip(tab1, tab0), &#39;l&#39;:zip(tab1, tab0), l1&#39;:tab1, &#39;l0&#39;:tab0, &#39;i&#39;: 0, &#39;j&#39;: 1302, &#39;!&#39;:0, &#39;s&#39;:[] }</span>
</span><span class='line'>            <span class="p">(</span>
</span><span class='line'>                <span class="p">(</span>
</span><span class='line'>                    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span>
</span><span class='line'>                        <span class="n">x</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="s">&#39;!&#39;</span><span class="p">,</span> <span class="p">[]),</span>
</span><span class='line'>                        <span class="n">x</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="s">&#39;s&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="s">&#39;!&#39;</span><span class="p">]),</span>
</span><span class='line'>                        <span class="n">x</span>
</span><span class='line'>                    <span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span class='line'>                <span class="p">)</span>
</span><span class='line'>                <span class="c"># Returns { &#39;g&#39;:g, &#39;c&#39;:c, &#39;d&#39;:d, &#39;!&#39;:zip(tab1, tab0), &#39;l&#39;:zip(tab1, tab0), l1&#39;:tab1, &#39;l0&#39;:tab0, &#39;i&#39;: 0, &#39;j&#39;: 1302, &#39;!&#39;:0}</span>
</span><span class='line'>                <span class="p">(</span>
</span><span class='line'>                    <span class="p">(</span>
</span><span class='line'>                        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span>
</span><span class='line'>                            <span class="n">x</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="s">&#39;!&#39;</span><span class="p">,</span> <span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="s">&#39;d&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;d&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="n">d</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s">&#39;d&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;d&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="n">d</span><span class="p">))),</span>
</span><span class='line'>                            <span class="n">x</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="s">&#39;i&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="s">&#39;!&#39;</span><span class="p">]),</span>
</span><span class='line'>                            <span class="n">x</span>
</span><span class='line'>                        <span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span class='line'>                    <span class="p">)</span>
</span><span class='line'>                    <span class="c"># Returns { &#39;g&#39; : g, &#39;c&#39;, &#39;d&#39;: d, &#39;!&#39;:zip(tab1, tab0), &#39;l&#39;:zip(tab1, tab0), l1&#39;:tab1, &#39;l0&#39;:tab0, &#39;i&#39;: (1371, 1302), &#39;j&#39;: 1302}</span>
</span><span class='line'>                    <span class="p">(</span>
</span><span class='line'>                        <span class="p">(</span>
</span><span class='line'>                            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span>
</span><span class='line'>                                <span class="n">x</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="s">&#39;!&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="n">x</span><span class="p">[</span><span class="s">&#39;j&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;j&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">[</span> <span class="s">&#39;i&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s">&#39;zip&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;zip&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="nb">zip</span><span class="p">)((</span><span class="n">x</span><span class="p">[</span><span class="s">&#39;l0&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;l0&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="n">l0</span><span class="p">),</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s">&#39;l1&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;l1&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="n">l1</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span><span class="p">[</span><span class="s">&#39;j&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s">&#39;i&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;i&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="n">i</span><span class="p">)]),</span>
</span><span class='line'>                                <span class="n">x</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="s">&#39;l&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="s">&#39;!&#39;</span><span class="p">]),</span>
</span><span class='line'>                                <span class="n">x</span>
</span><span class='line'>                            <span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span class='line'>                        <span class="p">)</span>
</span><span class='line'>                        <span class="c"># Returns { &#39;g&#39; : g, &#39;c&#39;, &#39;d&#39;: d, &#39;!&#39;:tab1, &#39;l1&#39;:tab1, &#39;l0&#39;:tab0}</span>
</span><span class='line'>                        <span class="p">(</span>
</span><span class='line'>                            <span class="p">(</span>
</span><span class='line'>                                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span>
</span><span class='line'>                                    <span class="n">x</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="s">&#39;!&#39;</span><span class="p">,</span> <span class="n">tab1</span><span class="p">),</span>
</span><span class='line'>                                    <span class="n">x</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="s">&#39;l1&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="s">&#39;!&#39;</span><span class="p">]),</span>
</span><span class='line'>                                    <span class="n">x</span>
</span><span class='line'>                                <span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span class='line'>                            <span class="p">)</span>
</span><span class='line'>                            <span class="c"># Return { &#39;g&#39; : g, &#39;c&#39;, &#39;d&#39;: d, &#39;!&#39; : tab0, &#39;l0&#39;:tab0}</span>
</span><span class='line'>                            <span class="p">(</span>
</span><span class='line'>                                <span class="p">(</span>
</span><span class='line'>                                    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span>
</span><span class='line'>                                        <span class="n">x</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="s">&#39;!&#39;</span><span class="p">,</span> <span class="n">tab0</span><span class="p">),</span>
</span><span class='line'>                                        <span class="n">x</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="s">&#39;l0&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="s">&#39;!&#39;</span><span class="p">]),</span>
</span><span class='line'>                                        <span class="n">x</span>
</span><span class='line'>                                    <span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span class='line'>                                <span class="p">)</span>
</span><span class='line'>                                <span class="p">({</span> <span class="s">&#39;g&#39;</span><span class="p">:</span> <span class="n">g</span><span class="p">,</span> <span class="s">&#39;c&#39;</span><span class="p">:</span> <span class="n">c</span><span class="p">,</span> <span class="s">&#39;d&#39;</span><span class="p">:</span> <span class="n">d</span><span class="p">,</span> <span class="s">&#39;$&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">})</span>
</span><span class='line'>                            <span class="p">)</span>
</span><span class='line'>                        <span class="p">)</span>
</span><span class='line'>                    <span class="p">)</span>
</span><span class='line'>                <span class="p">)</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>        <span class="p">)[</span><span class="s">&#39;$&#39;</span><span class="p">]</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mh">0x1000</span><span class="p">):</span>
</span><span class='line'>        <span class="k">try</span><span class="p">:</span>
</span><span class='line'>            <span class="n">ret</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>            <span class="k">if</span> <span class="s">&#39;quarks&#39;</span> <span class="ow">in</span> <span class="n">ret</span><span class="p">:</span>
</span><span class='line'>                <span class="k">print</span> <span class="n">ret</span>
</span><span class='line'>        <span class="k">except</span><span class="p">:</span>
</span><span class='line'>            <span class="k">pass</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">1</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">main</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">),</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>And after running it, we are good to go:</p>

<figure class='code'><figcaption><span>w00tw00t</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>D:\Codes\challenges\ql-python&gt;bf_with_lambdas_cleaned.py
</span><span class='line'>/blog.quarkslab.com/static/resources/b7d8438de09fffb12e3950e7ad4970a4a998403bdf3763dd4178adf
</span></code></pre></td></tr></table></div></figure>


<h1>A custom ELF64 Python interpreter you shall debug</h1>

<h2>Recon</h2>

<p>All right, here we are: we now have the real challenge. First, let&rsquo;s see what kind of information we get for free:</p>

<figure class='code'><figcaption><span>recon</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>overclok@wildout:~/chall/ql-py<span class="nv">$ </span>file b7d8438de09fffb12e3950e7ad4970a4a998403bdf3763dd4178adf
</span><span class='line'>b7d8438de09fffb12e3950e7ad4970a4a998403bdf3763dd4178adf: ELF 64-bit LSB  executable, x86-64, version 1 <span class="o">(</span>SYSV<span class="o">)</span>, dynamically linked <span class="o">(</span>uses shared libs<span class="o">)</span>,
</span><span class='line'><span class="k">for </span>GNU/Linux 2.6.26, not stripped
</span><span class='line'>overclok@wildout:~/chall/ql-py<span class="nv">$ </span>ls -lah b7d8438de09fffb12e3950e7ad4970a4a998403bdf3763dd4178adf
</span><span class='line'>-rwxrw-r-x 1 overclok overclok 7.9M Sep  8 21:03 b7d8438de09fffb12e3950e7ad4970a4a998403bdf3763dd4178adf
</span></code></pre></td></tr></table></div></figure>


<p>The binary is quite big, not good for us. But on the other hand, the binary isn&rsquo;t stripped so we might find useful debugging information at some point.</p>

<figure class='code'><figcaption><span>./b7d8438de09fffb12e3950e7ad4970a4a998403bdf3763dd4178adf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>overclok@wildout:~/chall/ql-py<span class="nv">$ </span>/usr/bin/b7d8438de09fffb12e3950e7ad4970a4a998403bdf3763dd4178adf
</span><span class='line'>Python 2.7.8+ <span class="o">(</span>nvcs/newopcodes:a9bd62e4d5f2+, Sep  1 2014, 11:41:46<span class="o">)</span>
</span><span class='line'><span class="o">[</span>GCC 4.8.2<span class="o">]</span> on linux2
</span><span class='line'>Type <span class="s2">&quot;help&quot;</span>, <span class="s2">&quot;copyright&quot;</span>, <span class="s2">&quot;credits&quot;</span> or <span class="s2">&quot;license&quot;</span> <span class="k">for </span>more information.
</span><span class='line'>&gt;&gt;&gt;
</span></code></pre></td></tr></table></div></figure>


<p>That does explain the size of the binary then: we basically have something that looks like a custom Python interpreter. Note that I also remembered reading <em><a href="http://blog.quarkslab.com/building-an-obfuscated-python-interpreter-we-need-more-opcodes.html">Building an obfuscated Python interpreter: we need more opcodes</a></em> on <em>Quarkslab</em>&rsquo;s blog where Serge described how you could tweak the interpreter sources to add / change some opcodes either for optimization or obfuscation purposes.</p>

<h2>Finding the interesting bits</h2>

<p>The next step is to figure out what part of the binary is interesting, what functions have been modified, and where we find the problem we need to solve to get the flag. My idea for that was to use a <em>binary-diffing</em> tool between an original <em>Python278</em> interpreter and the one we were given.</p>

<p>To do so I just grabbed <em>Python278</em>&rsquo;s sources and compiled them by myself:</p>

<figure class='code'><figcaption><span>compiling Py278</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>overclok@wildout:~/chall/ql-py<span class="nv">$ </span>wget https://www.python.org/ftp/python/2.7.8/Python-2.7.8.tgz <span class="o">&amp;&amp;</span> tar xzvf Python-2.7.8.tgz
</span><span class='line'>overclok@wildout:~/chall/ql-py<span class="nv">$ </span>tar xzvf Python-2.7.8.tgz
</span><span class='line'>overclok@wildout:~/chall/ql-py<span class="nv">$ </span><span class="nb">cd </span>Python-2.7.8/ <span class="o">&amp;&amp;</span> ./configure <span class="o">&amp;&amp;</span> make
</span><span class='line'>overclok@wildout:~/chall/ql-py/Python-2.7.8<span class="nv">$ </span>ls -lah ./python
</span><span class='line'>-rwxrwxr-x 1 overclok overclok 8.0M Sep  5 00:13 ./python
</span></code></pre></td></tr></table></div></figure>


<p>The resulting binary has a similar size, so it should do the job even if I&rsquo;m not using <em>GCC 4.8.2</em> and the same compilation/optimization options. To perform the <em>diffing</em> I used <em>IDA Pro</em> and <a href="https://code.google.com/p/patchdiff2/">Patchdiff v2.0.10</a>.</p>

<figure class='code'><figcaption><span>Patchdiff result</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>---------------------------------------------------
</span><span class='line'>PatchDiff Plugin v2.0.10
</span><span class='line'>Copyright (c) 2010-2011, Nicolas Pouvesle
</span><span class='line'>Copyright (C) 2007-2009, Tenable Network Security, Inc
</span><span class='line'>---------------------------------------------------
</span><span class='line'>
</span><span class='line'>Scanning for functions ...
</span><span class='line'>parsing second idb...
</span><span class='line'>parsing first idb...
</span><span class='line'>diffing...
</span><span class='line'>Identical functions:   2750
</span><span class='line'>Matched functions:     176
</span><span class='line'>Unmatched functions 1: 23
</span><span class='line'>Unmatched functions 2: 85
</span><span class='line'>done!
</span></code></pre></td></tr></table></div></figure>


<p>Once the tool has finished its analysis we just have to check the list of unmatched function names (around one hundred of them, so it&rsquo;s pretty quick), and eventually we see that:</p>

<p><img class="center" src="/images/dissection_of_quarkslab_s_2014_security_challenge/initdo_not_run_me.png"></p>

<p>That function directly caught my eyes (you can even check it doesn&rsquo;t exist in the <em>Python278</em> source tree obviously :&ndash;)), and it appears this function is just setting up a Python module called <em>do_not_run_me</em>.</p>

<p><img class="center" src="/images/dissection_of_quarkslab_s_2014_security_challenge/initdonotrunme_assembly.png"></p>

<p>Let&rsquo;s import it:</p>

<figure class='code'><figcaption><span>do_not_run_me module</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">overclok</span><span class="nd">@wildout</span><span class="p">:</span><span class="o">~/</span><span class="n">chall</span><span class="o">/</span><span class="n">ql</span><span class="o">-</span><span class="n">py</span><span class="err">$</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">b7d8438de09fffb12e3950e7ad4970a4a998403bdf3763dd4178adf</span>
</span><span class='line'><span class="n">iPython</span> <span class="mf">2.7</span><span class="o">.</span><span class="mi">8</span><span class="o">+</span> <span class="p">(</span><span class="n">nvcs</span><span class="o">/</span><span class="n">newopcodes</span><span class="p">:</span><span class="n">a9bd62e4d5f2</span><span class="o">+</span><span class="p">,</span> <span class="n">Sep</span>  <span class="mi">1</span> <span class="mi">2014</span><span class="p">,</span> <span class="mi">11</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="mi">46</span><span class="p">)</span>
</span><span class='line'><span class="p">[</span><span class="n">GCC</span> <span class="mf">4.8</span><span class="o">.</span><span class="mi">2</span><span class="p">]</span> <span class="n">on</span> <span class="n">linux2</span>
</span><span class='line'><span class="n">Type</span> <span class="s">&quot;help&quot;</span><span class="p">,</span> <span class="s">&quot;copyright&quot;</span><span class="p">,</span> <span class="s">&quot;credits&quot;</span> <span class="ow">or</span> <span class="s">&quot;license&quot;</span> <span class="k">for</span> <span class="n">more</span> <span class="n">information</span><span class="o">.</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">do_not_run_me</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">do_not_run_me</span><span class="o">.</span><span class="n">__doc__</span>
</span><span class='line'><span class="bp">None</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="nb">dir</span><span class="p">(</span><span class="n">do_not_run_me</span><span class="p">)</span>
</span><span class='line'><span class="p">[</span><span class="s">&#39;__doc__&#39;</span><span class="p">,</span> <span class="s">&#39;__name__&#39;</span><span class="p">,</span> <span class="s">&#39;__package__&#39;</span><span class="p">,</span> <span class="s">&#39;run_me&#39;</span><span class="p">]</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">do_not_run_me</span><span class="o">.</span><span class="n">run_me</span><span class="o">.</span><span class="n">__doc__</span>
</span><span class='line'><span class="n">There</span> <span class="n">are</span> <span class="n">two</span> <span class="n">kinds</span> <span class="n">of</span> <span class="n">people</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">world</span><span class="p">:</span> <span class="n">those</span> <span class="n">who</span> <span class="n">say</span> <span class="n">there</span> <span class="ow">is</span> <span class="n">no</span> <span class="n">such</span> <span class="n">thing</span> <span class="k">as</span> <span class="n">infinite</span> <span class="n">recursion</span><span class="p">,</span> <span class="ow">and</span> <span class="n">those</span> <span class="n">who</span> <span class="n">say</span> <span class="sb">``</span><span class="n">There</span> <span class="n">are</span> <span class="n">two</span> <span class="n">kinds</span> <span class="n">of</span> <span class="n">people</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">world</span><span class="p">:</span> <span class="n">those</span> <span class="n">who</span> <span class="n">say</span> <span class="n">there</span> <span class="ow">is</span> <span class="n">no</span> <span class="n">such</span> <span class="n">thing</span> <span class="k">as</span> <span class="n">infinite</span> <span class="n">recursion</span><span class="p">,</span> <span class="ow">and</span> <span class="n">those</span> <span class="n">who</span> <span class="n">say</span> <span class="o">...</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">do_not_run_me</span><span class="o">.</span><span class="n">run_me</span><span class="p">(</span><span class="s">&#39;doar-e&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">Segmentation</span> <span class="n">fault</span>
</span></code></pre></td></tr></table></div></figure>


<p>All right, we now have something to look at and we are going to do so from a low level point of view because that&rsquo;s what I like ; so don&rsquo;t expect big/magic hacks here :).</p>

<p>If you are not really familiar with Python&rsquo;s VM structures I would advise you to read quickly through this article <em><a href="https://doar-e.github.io/blog/2014/04/17/deep-dive-into-pythons-vm-story-of-load_const-bug/">Deep Dive Into Python’s VM: Story of LOAD_CONST Bug</a></em>, and you should be all set for the next parts.</p>

<h2>do_not_run_me.run_me</h2>

<p>The function is quite small, so it should be pretty quick to analyze:</p>

<ol>
<li>the first part makes sure that we pass a string as an argument when calling <em>run_me</em>,</li>
<li>then a custom <em>marshaled</em> function is loaded, a function is created out of it, and called,</li>
<li>after that it creates another function from the string we pass to the function (which explains the <em>segfault</em> just above),</li>
<li>finally, a last function is created from another hardcoded <em>marshaled</em> string.</li>
</ol>


<h3>First marshaled function</h3>

<p>To understand it we have to dump it first, to unmarshal it and to analyze the resulting code object:</p>

<figure class='code'><figcaption><span>unmarshaling the first function</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>overclok@wildout:~/chall/ql-py$ gdb -q /usr/bin/b7d8438de09fffb12e3950e7ad4970a4a998403bdf3763dd4178adf
</span><span class='line'>Reading symbols from /usr/bin/b7d8438de09fffb12e3950e7ad4970a4a998403bdf3763dd4178adf...done.
</span><span class='line'>gdb$ set disassembly-flavor intel
</span><span class='line'>gdb$ disass run_me
</span><span class='line'>Dump of assembler code for function run_me:
</span><span class='line'>   0x0000000000513d90 &lt;+0&gt;:     push   rbp
</span><span class='line'>   0x0000000000513d91 &lt;+1&gt;:     mov    rdi,rsi
</span><span class='line'>   0x0000000000513d94 &lt;+4&gt;:     xor    eax,eax
</span><span class='line'>   0x0000000000513d96 &lt;+6&gt;:     mov    esi,0x56c70b
</span><span class='line'>   0x0000000000513d9b &lt;+11&gt;:    push   rbx
</span><span class='line'>   0x0000000000513d9c &lt;+12&gt;:    sub    rsp,0x28
</span><span class='line'>   0x0000000000513da0 &lt;+16&gt;:    lea    rcx,[rsp+0x10]
</span><span class='line'>   0x0000000000513da5 &lt;+21&gt;:    mov    rdx,rsp
</span><span class='line'>
</span><span class='line'>   ; Parses the arguments we gave, it expects a string object
</span><span class='line'>   0x0000000000513da8 &lt;+24&gt;:    call   0x4cf430 &lt;PyArg_ParseTuple&gt;
</span><span class='line'>   0x0000000000513dad &lt;+29&gt;:    xor    edx,edx
</span><span class='line'>   0x0000000000513daf &lt;+31&gt;:    test   eax,eax
</span><span class='line'>   0x0000000000513db1 &lt;+33&gt;:    je     0x513e5e &lt;run_me+206&gt;
</span><span class='line'>
</span><span class='line'>   0x0000000000513db7 &lt;+39&gt;:    mov    rax,QWORD PTR [rip+0x2d4342]
</span><span class='line'>   0x0000000000513dbe &lt;+46&gt;:    mov    esi,0x91
</span><span class='line'>   0x0000000000513dc3 &lt;+51&gt;:    mov    edi,0x56c940
</span><span class='line'>   0x0000000000513dc8 &lt;+56&gt;:    mov    rax,QWORD PTR [rax+0x10]
</span><span class='line'>   0x0000000000513dcc &lt;+60&gt;:    mov    rbx,QWORD PTR [rax+0x30]
</span><span class='line'>
</span><span class='line'>   ; Creates a code object from the marshaled string
</span><span class='line'>   ; PyObject* PyMarshal_ReadObjectFromString(char *string, Py_ssize_t len)
</span><span class='line'>   0x0000000000513dd0 &lt;+64&gt;:    call   0x4dc020 &lt;PyMarshal_ReadObjectFromString&gt;
</span><span class='line'>   0x0000000000513dd5 &lt;+69&gt;:    mov    rdi,rax
</span><span class='line'>   0x0000000000513dd8 &lt;+72&gt;:    mov    rsi,rbx
</span><span class='line'>
</span><span class='line'>   ; Creates a function object from the marshaled string
</span><span class='line'>   0x0000000000513ddb &lt;+75&gt;:    call   0x52c630 &lt;PyFunction_New&gt;
</span><span class='line'>   0x0000000000513de0 &lt;+80&gt;:    xor    edi,edi
</span><span class='line'>[...]
</span><span class='line'>gdb$ r -c &#39;import do_not_run_me as v; v.run_me(&quot;&quot;)&#39;
</span><span class='line'>Starting program: /usr/bin/b7d8438de09fffb12e3950e7ad4970a4a998403bdf3763dd4178adf -c &#39;import do_not_run_me as v; v.run_me(&quot;&quot;)&#39;
</span><span class='line'>[...]
</span></code></pre></td></tr></table></div></figure>


<p>To start, we can set two software breakpoints <em>@0x0000000000513dd0</em> and <em>@0x0000000000513dd5</em> to inspect both the marshaled string and the resulting code object.</p>

<p>Just a little reminder though on the <em>Linux/x64 ABI</em>: &ldquo;The first six integer or pointer arguments are passed in registers RDI, RSI, RDX, RCX, R8, and R9&rdquo;.</p>

<figure class='code'><figcaption><span>unmarshaled string inspection</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>gdb$ p /x $rsi
</span><span class='line'>$2 = 0x91
</span><span class='line'>gdb$ x/145bx $rdi
</span><span class='line'>0x56c940 &lt;+00&gt;:  0x63    0x00    0x00    0x00    0x00    0x01    0x00    0x00
</span><span class='line'>0x56c948 &lt;+08&gt;:  0x00    0x02    0x00    0x00    0x00    0x43    0x00    0x00
</span><span class='line'>0x56c950 &lt;+16&gt;:  0x00    0x73    0x14    0x00    0x00    0x00    0x64    0x01
</span><span class='line'>0x56c958 &lt;+24&gt;:  0x00    0x87    0x00    0x00    0x7c    0x00    0x00    0x64
</span><span class='line'>0x56c960 &lt;+32&gt;:  0x01    0x00    0x3c    0x61    0x00    0x00    0x7c    0x00
</span><span class='line'>0x56c968 &lt;+40&gt;:  0x00    0x1b    0x28    0x02    0x00    0x00    0x00    0x4e
</span><span class='line'>0x56c970 &lt;+48&gt;:  0x69    0x01    0x00    0x00    0x00    0x28    0x01    0x00
</span><span class='line'>0x56c978 &lt;+56&gt;:  0x00    0x00    0x74    0x04    0x00    0x00    0x00    0x54
</span><span class='line'>0x56c980 &lt;+64&gt;:  0x72    0x75    0x65    0x28    0x01    0x00    0x00    0x00
</span><span class='line'>0x56c988 &lt;+72&gt;:  0x74    0x0e    0x00    0x00    0x00    0x52    0x6f    0x62
</span><span class='line'>0x56c990 &lt;+80&gt;:  0x65    0x72    0x74    0x5f    0x46    0x6f    0x72    0x73
</span><span class='line'>0x56c998 &lt;+88&gt;:  0x79    0x74    0x68    0x28    0x00    0x00    0x00    0x00
</span><span class='line'>0x56c9a0 &lt;+96&gt;:  0x28    0x00    0x00    0x00    0x00    0x73    0x10    0x00
</span><span class='line'>0x56c9a8 &lt;+104&gt;: 0x00    0x00    0x6f    0x62    0x66    0x75    0x73    0x63
</span><span class='line'>0x56c9b0 &lt;+112&gt;: 0x61    0x74    0x65    0x2f    0x67    0x65    0x6e    0x2e
</span><span class='line'>0x56c9b8 &lt;+120&gt;: 0x70    0x79    0x74    0x03    0x00    0x00    0x00    0x66
</span><span class='line'>0x56c9c0 &lt;+128&gt;: 0x6f    0x6f    0x05    0x00    0x00    0x00    0x73    0x06
</span><span class='line'>0x56c9c8 &lt;+136&gt;: 0x00    0x00    0x00    0x00    0x01    0x06    0x02    0x0a
</span><span class='line'>0x56c9d0 &lt;+144&gt;: 0x01
</span></code></pre></td></tr></table></div></figure>


<p>And obviously you can&rsquo;t use the Python <em>marshal</em> module to load &amp; inspect the resulting object as the author seems to have removed the methods <em>loads</em> and <em>dumps</em>:</p>

<figure class='code'><figcaption><span>fuu</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>overclok@wildout:~/chall/ql-py$ /usr/bin/b7d8438de09fffb12e3950e7ad4970a4a998403bdf3763dd4178adf
</span><span class='line'>Python 2.7.8+ (nvcs/newopcodes:a9bd62e4d5f2+, Sep  1 2014, 11:41:46)
</span><span class='line'>[GCC 4.8.2] on linux2
</span><span class='line'>Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
</span><span class='line'>&gt;&gt;&gt; import marshal
</span><span class='line'>&gt;&gt;&gt; dir(marshal)
</span><span class='line'>[&#39;__doc__&#39;, &#39;__name__&#39;, &#39;__package__&#39;, &#39;version&#39;]
</span></code></pre></td></tr></table></div></figure>


<p>We could still try to run the marshaled string in our fresh compiled original Python though:</p>

<figure class='code'><figcaption><span>unmarshal in an original Python278</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">marshal</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">part_1</span> <span class="o">=</span> <span class="n">marshal</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="s">&#39;c</span><span class="se">\x00\x00\x00\x00\x01\x00\x00\x00\x02\x00\x00\x00</span><span class="s">C</span><span class="se">\x00\x00\x00</span><span class="s">s</span><span class="se">\x14\x00\x00\x00</span><span class="s">d</span><span class="se">\x01\x00\x87\x00\x00</span><span class="s">|</span><span class="se">\x00\x00</span><span class="s">d</span><span class="se">\x01\x00</span><span class="s">&lt;a</span><span class="se">\x00\x00</span><span class="s">|</span><span class="se">\x00\x00\x1b</span><span class="s">(</span><span class="se">\x02\x00\x00\x00</span><span class="s">Ni</span><span class="se">\x01\x00\x00\x00</span><span class="s">(</span><span class="se">\x01\x00\x00\x00</span><span class="s">t</span><span class="se">\x04\x00\x00\x00</span><span class="s">True(</span><span class="se">\x01\x00\x00\x00</span><span class="s">t</span><span class="se">\x0e\x00\x00\x00</span><span class="s">Robert_Forsyth(</span><span class="se">\x00\x00\x00\x00</span><span class="s">(</span><span class="se">\x00\x00\x00\x00</span><span class="s">s</span><span class="se">\x10\x00\x00\x00</span><span class="s">obfuscate/gen.pyt</span><span class="se">\x03\x00\x00\x00</span><span class="s">foo</span><span class="se">\x05\x00\x00\x00</span><span class="s">s</span><span class="se">\x06\x00\x00\x00\x00\x01\x06\x02\n\x01</span><span class="s">&#39;</span><span class="p">)</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">part_1</span><span class="o">.</span><span class="n">co_code</span>
</span><span class='line'><span class="s">&#39;d</span><span class="se">\x01\x00\x87\x00\x00</span><span class="s">|</span><span class="se">\x00\x00</span><span class="s">d</span><span class="se">\x01\x00</span><span class="s">&lt;a</span><span class="se">\x00\x00</span><span class="s">|</span><span class="se">\x00\x00\x1b</span><span class="s">&#39;</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">part_1</span><span class="o">.</span><span class="n">co_varnames</span>
</span><span class='line'><span class="p">(</span><span class="s">&#39;Robert_Forsyth&#39;</span><span class="p">,)</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">part_1</span><span class="o">.</span><span class="n">co_names</span>
</span><span class='line'><span class="p">(</span><span class="s">&#39;True&#39;</span><span class="p">,)</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can also go further by trying to create a function out of this code object, to call it and/or to disassemble it even:</p>

<figure class='code'><figcaption><span>fuu2</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">types</span> <span class="kn">import</span> <span class="n">FunctionType</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">a</span><span class="p">():</span>
</span><span class='line'><span class="o">...</span>     <span class="k">pass</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">FunctionType</span><span class="p">(</span><span class="n">part_1</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">func_globals</span><span class="p">)</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">f</span><span class="p">()</span>
</span><span class='line'><span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
</span><span class='line'>  <span class="n">File</span> <span class="s">&quot;&lt;stdin&gt;&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="n">File</span> <span class="s">&quot;obfuscate/gen.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">8</span><span class="p">,</span> <span class="ow">in</span> <span class="n">foo</span>
</span><span class='line'><span class="ne">UnboundLocalError</span><span class="p">:</span> <span class="n">local</span> <span class="n">variable</span> <span class="s">&#39;Robert_Forsyth&#39;</span> <span class="n">referenced</span> <span class="n">before</span> <span class="n">assignment</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">dis</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">dis</span><span class="o">.</span><span class="n">dis</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span><span class='line'>  <span class="mi">6</span>           <span class="mi">0</span> <span class="n">LOAD_CONST</span>               <span class="mi">1</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>              <span class="mi">3</span> <span class="n">LOAD_CLOSURE</span>             <span class="mi">0</span>
</span><span class='line'><span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
</span><span class='line'>  <span class="n">File</span> <span class="s">&quot;&lt;stdin&gt;&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="n">File</span> <span class="s">&quot;/home/overclok/chall/ql-py/Python-2.7.8/Lib/dis.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">43</span><span class="p">,</span> <span class="ow">in</span> <span class="n">dis</span>
</span><span class='line'>    <span class="n">disassemble</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span class='line'>  <span class="n">File</span> <span class="s">&quot;/home/overclok/chall/ql-py/Python-2.7.8/Lib/dis.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">107</span><span class="p">,</span> <span class="ow">in</span> <span class="n">disassemble</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&#39;(&#39;</span> <span class="o">+</span> <span class="n">free</span><span class="p">[</span><span class="n">oparg</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;)&#39;</span><span class="p">,</span>
</span><span class='line'><span class="ne">IndexError</span><span class="p">:</span> <span class="nb">tuple</span> <span class="n">index</span> <span class="n">out</span> <span class="n">of</span> <span class="nb">range</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Introducing <em>dpy.py</em></h3>

<p>All right, as expected this does not work at all: seems like the custom interpreter uses different opcodes which the original virtual CPU doesn&rsquo;t know about.
Anyway, let&rsquo;s have a look at this object directly from memory because we like low level things (remember?):</p>

<figure class='code'><figcaption><span>inspecting the code object created</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>gdb$ p *(PyObject*)$rax
</span><span class='line'>$3 = {ob_refcnt = 0x1, ob_type = 0x7d3da0 &lt;PyCode_Type&gt;}
</span><span class='line'>
</span><span class='line'>; Ok it is a code object, let&#39;s dump entirely the object now
</span><span class='line'>gdb$ p *(PyCodeObject*)$rax
</span><span class='line'>$4 = {
</span><span class='line'>  ob_refcnt = 0x1,
</span><span class='line'>  ob_type = 0x7d3da0 &lt;PyCode_Type&gt;,
</span><span class='line'>  co_argcount = 0x0, co_nlocals = 0x1, co_stacksize = 0x2, co_flags = 0x43,
</span><span class='line'>  co_code = 0x7ffff7f09df0,
</span><span class='line'>  co_consts = 0x7ffff7ee2908,
</span><span class='line'>  co_names = 0x7ffff7f8e390,
</span><span class='line'>  co_varnames = 0x7ffff7f09ed0,
</span><span class='line'>  co_freevars = 0x7ffff7fa7050, co_cellvars = 0x7ffff7fa7050,
</span><span class='line'>  co_filename = 0x7ffff70a9b58,
</span><span class='line'>  co_name = 0x7ffff7f102b0,
</span><span class='line'>  co_firstlineno = 0x5,
</span><span class='line'>  co_lnotab = 0x7ffff7e59900,
</span><span class='line'>  co_zombieframe = 0x0,
</span><span class='line'>  co_weakreflist = 0x0
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>Perfect, and you can do that for every single field of this structure:</p>

<ul>
<li>to dump the bytecode,</li>
<li>the constants used,</li>
<li>the variable names,</li>
<li>etc.</li>
</ul>


<p>Yes, this is annoying, very much so. That is exactly why there is <em><a href="https://github.com/0vercl0k/stuffz/blob/master/ql-chall-python-2014/dpy.py">dpy</a></em>, a <em>GDB</em> Python command I wrote to dump Python objects in a much easy way directly from memory:</p>

<figure class='code'><figcaption><span>show-casing dpy</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>gdb$ r
</span><span class='line'>Starting program: /usr/bin/b7d8438de09fffb12e3950e7ad4970a4a998403bdf3763dd4178adf
</span><span class='line'>[...]
</span><span class='line'>&gt;&gt;&gt; a = { 1 : [1,2,3], &#39;two&#39; : 31337, 3 : (1,&#39;lul&#39;, [3,4,5])}
</span><span class='line'>&gt;&gt;&gt; print hex(id(a))
</span><span class='line'>0x7ffff7ef1050
</span><span class='line'>&gt;&gt;&gt; ^C
</span><span class='line'>Program received signal SIGINT, Interrupt.
</span><span class='line'>gdb$ dpy 0x7ffff7ef1050
</span><span class='line'>dict -&gt; {1: [1, 2, 3], 3: (1, &#39;lul&#39;, [3, 4, 5]), &#39;two&#39;: 31337}
</span></code></pre></td></tr></table></div></figure>


<h3>I need a disassembler now dad</h3>

<p>But let&rsquo;s get back to our second breakpoint now, and see what <em>dpy</em> gives us with the resulting code object:</p>

<figure class='code'><figcaption><span>dpy code object</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>gdb$ dpy $rax
</span><span class='line'>code -&gt; {&#39;co_code&#39;: &#39;d\x01\x00\x87\x00\x00|\x00\x00d\x01\x00&lt;a\x00\x00|\x00\x00\x1b&#39;,
</span><span class='line'> &#39;co_consts&#39;: (None, 1),
</span><span class='line'> &#39;co_name&#39;: &#39;foo&#39;,
</span><span class='line'> &#39;co_names&#39;: (&#39;True&#39;,),
</span><span class='line'> &#39;co_varnames&#39;: (&#39;Robert_Forsyth&#39;,)}
</span></code></pre></td></tr></table></div></figure>


<p>Because we know the bytecode used by this interpreter is different than the original one, we have to figure out the equivalent between the instructions and their opcodes:</p>

<ol>
<li>Either we can reverse-engineer each handler of the virtual CPU,</li>
<li>Either we can create functions in both interpreters, disassemble those (thanks to <em>dpy</em>) and match the equivalent opcodes</li>
</ol>


<p>I guess we can mix both of them to be more efficient:</p>

<figure class='code'><figcaption><span>deducing equivalent opcodes</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>Python 2.7.8 (default, Sep  5 2014, 00:13:07)
</span><span class='line'>[GCC 4.8.2] on linux2
</span><span class='line'>Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
</span><span class='line'>&gt;&gt;&gt; def assi(x):
</span><span class='line'>...     x = &#39;hu&#39;
</span><span class='line'>...
</span><span class='line'>&gt;&gt;&gt; def add(x):
</span><span class='line'>...     return x + 31337
</span><span class='line'>...
</span><span class='line'>&gt;&gt;&gt; import dis
</span><span class='line'>&gt;&gt;&gt; dis.dis(assi)
</span><span class='line'>  2           0 LOAD_CONST               1 (&#39;hu&#39;)
</span><span class='line'>              3 STORE_FAST               0 (x)
</span><span class='line'>              6 LOAD_CONST               0 (None)
</span><span class='line'>              9 RETURN_VALUE
</span><span class='line'>&gt;&gt;&gt; dis.dis(add)
</span><span class='line'>  2           0 LOAD_FAST                0 (x)
</span><span class='line'>              3 LOAD_CONST               1 (31337)
</span><span class='line'>              6 BINARY_ADD
</span><span class='line'>              7 RETURN_VALUE
</span><span class='line'>&gt;&gt;&gt; assi.func_code.co_code
</span><span class='line'>&#39;d\x01\x00}\x00\x00d\x00\x00S&#39;
</span><span class='line'>&gt;&gt;&gt; add.func_code.co_code
</span><span class='line'>&#39;|\x00\x00d\x01\x00\x17S&#39;
</span><span class='line'>
</span><span class='line'># In the custom interpreter
</span><span class='line'>
</span><span class='line'>gdb$ r
</span><span class='line'>Starting program: /usr/bin/b7d8438de09fffb12e3950e7ad4970a4a998403bdf3763dd4178adf
</span><span class='line'>[Thread debugging using libthread_db enabled]
</span><span class='line'>Using host libthread_db library &quot;/lib/x86_64-linux-gnu/libthread_db.so.1&quot;.
</span><span class='line'>Python 2.7.8+ (nvcs/newopcodes:a9bd62e4d5f2+, Sep  1 2014, 11:41:46)
</span><span class='line'>[GCC 4.8.2] on linux2
</span><span class='line'>Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
</span><span class='line'>&gt;&gt;&gt; def assi(x):
</span><span class='line'>...     x = &#39;hu&#39;
</span><span class='line'>...
</span><span class='line'>&gt;&gt;&gt; def add(x):
</span><span class='line'>...     return x + 31337
</span><span class='line'>...
</span><span class='line'>&gt;&gt;&gt; print hex(id(assi))
</span><span class='line'>0x7ffff7f0c578
</span><span class='line'>&gt;&gt;&gt; print hex(id(add))
</span><span class='line'>0x7ffff7f0c5f0
</span><span class='line'>&gt;&gt;&gt; ^C
</span><span class='line'>Program received signal SIGINT, Interrupt.
</span><span class='line'>gdb$ dpy 0x7ffff7f0c578
</span><span class='line'>function -&gt; {&#39;func_code&#39;: {&#39;co_code&#39;: &#39;d\x01\x00\x87\x00\x00d\x00\x00\x1b&#39;,
</span><span class='line'>               &#39;co_consts&#39;: (None, &#39;hu&#39;),
</span><span class='line'>               &#39;co_name&#39;: &#39;assi&#39;,
</span><span class='line'>               &#39;co_names&#39;: (),
</span><span class='line'>               &#39;co_varnames&#39;: (&#39;x&#39;,)},
</span><span class='line'> &#39;func_dict&#39;: None,
</span><span class='line'> &#39;func_doc&#39;: None,
</span><span class='line'> &#39;func_module&#39;: &#39;__main__&#39;,
</span><span class='line'> &#39;func_name&#39;: &#39;assi&#39;}
</span><span class='line'>gdb$ dpy 0x7ffff7f0c5f0
</span><span class='line'>function -&gt; {&#39;func_code&#39;: {&#39;co_code&#39;: &#39;\x8f\x00\x00d\x01\x00=\x1b&#39;,
</span><span class='line'>               &#39;co_consts&#39;: (None, 31337),
</span><span class='line'>               &#39;co_name&#39;: &#39;add&#39;,
</span><span class='line'>               &#39;co_names&#39;: (),
</span><span class='line'>               &#39;co_varnames&#39;: (&#39;x&#39;,)},
</span><span class='line'> &#39;func_dict&#39;: None,
</span><span class='line'> &#39;func_doc&#39;: None,
</span><span class='line'> &#39;func_module&#39;: &#39;__main__&#39;,
</span><span class='line'> &#39;func_name&#39;: &#39;add&#39;}
</span><span class='line'>
</span><span class='line'> # From here we have:
</span><span class='line'> # 0x64 -&gt; LOAD_CONST
</span><span class='line'> # 0x87 -&gt; STORE_FAST
</span><span class='line'> # 0x1b -&gt; RETURN_VALUE
</span><span class='line'> # 0x8f -&gt; LOAD_FAST
</span><span class='line'> # 0x3d -&gt; BINARY_ADD
</span></code></pre></td></tr></table></div></figure>


<p>OK I think you got the idea, and if you don&rsquo;t manage to find all of them you can just debug the virtual CPU by putting a software breakpoint <em>@0x4b0960</em>:</p>

<figure class='code'><figcaption><span>opcode fetching</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>=&gt; 0x4b0923 &lt;PyEval_EvalFrameEx+867&gt;:   movzx  eax,BYTE PTR [r13+0x0]
</span></code></pre></td></tr></table></div></figure>


<p>For the interested readers: there is at least one interesting opcode that you wouldn&rsquo;t find in a normal Python interpreter, check what <em>0xA0</em> is doing especially when followed by <em>0x87</em> :&ndash;).</p>

<h3>Back to the first marshaled function with all our tooling now</h3>

<p>Thanks to our <a href="https://github.com/0vercl0k/stuffz/blob/master/ql-chall-python-2014/disassembler_ql_chall.py">disassembler.py</a>, we can now disassemble easily the first part:</p>

<figure class='code'><figcaption><span>disassembling</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>PS D:\Codes\ql-chall-python-2014&gt; python .\disassembler_ql_chall.py
</span><span class='line'>  6           0 LOAD_CONST               1 (1)
</span><span class='line'>              3 STORE_FAST               0 (Robert_Forsyth)
</span><span class='line'>
</span><span class='line'>  8           6 LOAD_GLOBAL              0 (True)
</span><span class='line'>              9 LOAD_CONST               1 (1)
</span><span class='line'>             12 INPLACE_ADD
</span><span class='line'>             13 STORE_GLOBAL             0 (True)
</span><span class='line'>
</span><span class='line'>  9          16 LOAD_GLOBAL              0 (True)
</span><span class='line'>             19 RETURN_VALUE
</span><span class='line'>================================================================================
</span></code></pre></td></tr></table></div></figure>


<p>It seems the author has been really (too) kind with us: the function is really small and we can rewrite it in Python straightaway:</p>

<figure class='code'><figcaption><span>part_1</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">def</span> <span class="nf">part1</span><span class="p">():</span>
</span><span class='line'>    <span class="k">global</span> <span class="bp">True</span>
</span><span class='line'>    <span class="n">Robert_Forsyth</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'>    <span class="bp">True</span> <span class="o">+=</span> <span class="mi">1</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can also make sure with <a href="https://github.com/0vercl0k/stuffz/blob/master/ql-chall-python-2014/dpy.py">dpy</a> that the code of <em>part1</em> is the exact same than the unmarshaled function we dumped earlier.</p>

<figure class='code'><figcaption><span>part_1 successfully decompiled</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt;&gt;&gt; def part_1():
</span><span class='line'>...  global True
</span><span class='line'>...  Robert_Forsyth = 1
</span><span class='line'>...  True += 1
</span><span class='line'>...
</span><span class='line'>&gt;&gt;&gt; print hex(id(part_1))
</span><span class='line'>0x7ffff7f0f578
</span><span class='line'>&gt;&gt;&gt; ^C
</span><span class='line'>Program received signal SIGINT, Interrupt.
</span><span class='line'>gdb$ dpy 0x7ffff7f0f578
</span><span class='line'>function -&gt; {&#39;func_code&#39;: {&#39;co_code&#39;: &#39;d\x01\x00\x87\x00\x00|\x00\x00d\x01\x00&lt;a\x00\x00d\x00\x00\x1b&#39;,
</span><span class='line'>               &#39;co_consts&#39;: (None, 1),
</span><span class='line'>               &#39;co_name&#39;: &#39;part_1&#39;,
</span><span class='line'>               &#39;co_names&#39;: (&#39;True&#39;,),
</span><span class='line'>               &#39;co_varnames&#39;: (&#39;Robert_Forsyth&#39;,)},
</span><span class='line'> &#39;func_dict&#39;: None,
</span><span class='line'> &#39;func_doc&#39;: None,
</span><span class='line'> &#39;func_module&#39;: &#39;__main__&#39;,
</span><span class='line'> &#39;func_name&#39;: &#39;part_1&#39;}
</span></code></pre></td></tr></table></div></figure>


<h3>Run my bytecode</h3>

<p>The second part is also quite simple according to the following disassembly:</p>

<figure class='code'><figcaption><span>run my bytecode</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>gdb$ disass run_me
</span><span class='line'>Dump of assembler code for function run_me:
</span><span class='line'>[...]
</span><span class='line'>   ; Parses the arguments we gave, it expects a string object
</span><span class='line'>   0x0000000000513da0 &lt;+16&gt;:    lea    rcx,[rsp+0x10]
</span><span class='line'>   0x0000000000513da5 &lt;+21&gt;:    mov    rdx,rsp
</span><span class='line'>   0x0000000000513da8 &lt;+24&gt;:    call   0x4cf430 &lt;PyArg_ParseTuple&gt;
</span><span class='line'>   0x0000000000513dad &lt;+29&gt;:    xor    edx,edx
</span><span class='line'>   0x0000000000513daf &lt;+31&gt;:    test   eax,eax
</span><span class='line'>   0x0000000000513db1 &lt;+33&gt;:    je     0x513e5e &lt;run_me+206&gt;
</span><span class='line'>
</span><span class='line'>   0x0000000000513db7 &lt;+39&gt;:    mov    rax,QWORD PTR [rip+0x2d4342]
</span><span class='line'>   0x0000000000513dbe &lt;+46&gt;:    mov    esi,0x91
</span><span class='line'>   0x0000000000513dc3 &lt;+51&gt;:    mov    edi,0x56c940
</span><span class='line'>   0x0000000000513dc8 &lt;+56&gt;:    mov    rax,QWORD PTR [rax+0x10]
</span><span class='line'>   0x0000000000513dcc &lt;+60&gt;:    mov    rbx,QWORD PTR [rax+0x30]
</span><span class='line'>
</span><span class='line'>[...]
</span><span class='line'>   ; Part1
</span><span class='line'>[...]
</span><span class='line'>
</span><span class='line'>   0x0000000000513df7 &lt;+103&gt;:   mov    rsi,QWORD PTR [rsp+0x10]
</span><span class='line'>   0x0000000000513dfc &lt;+108&gt;:   mov    rdi,QWORD PTR [rsp]
</span><span class='line'>   ; Uses the string passed as argument to run_me as a marshaled object
</span><span class='line'>   ; PyObject* PyMarshal_ReadObjectFromString(char *string, Py_ssize_t len)
</span><span class='line'>   0x0000000000513e00 &lt;+112&gt;:   call   0x4dc020 &lt;PyMarshal_ReadObjectFromString&gt;
</span><span class='line'>
</span><span class='line'>   0x0000000000513e05 &lt;+117&gt;:   mov    rsi,rbx
</span><span class='line'>   0x0000000000513e08 &lt;+120&gt;:   mov    rdi,rax
</span><span class='line'>
</span><span class='line'>   ; Creates a function out of it
</span><span class='line'>   0x0000000000513e0b &lt;+123&gt;:   call   0x52c630 &lt;PyFunction_New&gt;
</span><span class='line'>   0x0000000000513e10 &lt;+128&gt;:   xor    edi,edi
</span><span class='line'>   0x0000000000513e12 &lt;+130&gt;:   mov    rbp,rax
</span><span class='line'>   0x0000000000513e15 &lt;+133&gt;:   call   0x478f80 &lt;PyTuple_New&gt;
</span><span class='line'>
</span><span class='line'>   ; Calls it
</span><span class='line'>   ; PyObject* PyObject_Call(PyObject *callable_object, PyObject *args, PyObject *kw)
</span><span class='line'>   0x0000000000513e1a &lt;+138&gt;:   xor    edx,edx
</span><span class='line'>   0x0000000000513e1c &lt;+140&gt;:   mov    rdi,rbp
</span><span class='line'>   0x0000000000513e1f &lt;+143&gt;:   mov    rsi,rax
</span><span class='line'>   0x0000000000513e22 &lt;+146&gt;:   call   0x422b40 &lt;PyObject_Call&gt;
</span></code></pre></td></tr></table></div></figure>


<p>Basically, the string you pass to <em>run_me</em> is treated as a marshaled function: it explains why you get <em>segmentation faults</em> when you call the function with random strings.
We can just <em>jump over</em> that part of the function because we don&rsquo;t really need it so far: <em>set $eip=0x513e27</em> and job done!</p>

<h3>Second &amp; last marshaled function</h3>

<p>By the way I hope you are still reading &mdash; hold tight, we are nearly done!
Let&rsquo;s dump the function object with <a href="https://github.com/0vercl0k/stuffz/blob/master/ql-chall-python-2014/dpy.py">dpy</a>:</p>

<figure class='code'><figcaption><span>Second part inspection with dpy</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>-----------------------------------------------------------------------------------------------------------------------[regs]
</span><span class='line'>  RAX: 0x00007FFFF7FA7050  RBX: 0x00007FFFF7F0F758  RBP: 0x00000000007B0270  RSP: 0x00007FFFFFFFE040  o d I t s Z a P c
</span><span class='line'>  RDI: 0x00007FFFF7F0F758  RSI: 0x00007FFFF7FA7050  RDX: 0x0000000000000000  RCX: 0x0000000000000828  RIP: 0x0000000000513E56
</span><span class='line'>  R8 : 0x0000000000880728  R9 : 0x00007FFFF7F8D908  R10: 0x00007FFFF7FA7050  R11: 0x00007FFFF7FA7050  R12: 0x00007FFFF7FD0F48
</span><span class='line'>  R13: 0x00000000007EF0A0  R14: 0x00007FFFF7F3CB00  R15: 0x00007FFFF7F07ED0
</span><span class='line'>  CS: 0033  DS: 0000  ES: 0000  FS: 0000  GS: 0000  SS: 002B
</span><span class='line'>-----------------------------------------------------------------------------------------------------------------------[code]
</span><span class='line'>=&gt; 0x513e56 &lt;run_me+198&gt;:       call   0x422b40 &lt;PyObject_Call&gt;
</span><span class='line'>-----------------------------------------------------------------------------------------------------------------------------
</span><span class='line'>gdb$ dpy $rdi
</span><span class='line'>function -&gt; {&#39;func_code&#39;: {&#39;co_code&#39;: &#39;\\x7c\\x00\\x00\\x64\\x01\\x00\\x6b\\x03\\x00\\x72\\x19\\x00\\x7c\\x00\\x00\\x64\\x02\\x00\\x55\\x61\\x00\\x00\\x6e\\x6e\\x00\\x7c\\x01\\x00\\x6a\\x02\\x00\\x64\\x03\\x00\\x6a\\x03\\x00\\x64\\x04\\x00\\x77\\x00\\x00\\xa0\\x05\\x00\\xc8\\x06\\x00\\xa0\\x07\\x00\\xb2\\x08\\x00\\xa0\\x09\\x00\\xea\\x0a\\x00\\xa0\\x0b\\x00\\x91\\x08\\x00\\xa0\\x0c\\x00\\x9e\\x0b\\x00\\xa0\\x0d\\x00\\xd4\\x08\\x00\\xa0\\x0e\\x00\\xd5\\x0f\\x00\\xa0\\x10\\x00\\xdd\\x11\\x00\\xa0\\x07\\x00\\xcc\\x08\\x00\\xa0\\x12\\x00\\x78\\x0b\\x00\\xa0\\x13\\x00\\x87\\x0f\\x00\\xa0\\x14\\x00\\x5b\\x15\\x00\\xa0\\x16\\x00\\x97\\x17\\x00\\x67\\x1a\\x00\\x53\\x86\\x01\\x00\\x86\\x01\\x00\\x86\\x01\\x00\\x54\\x64\\x00\\x00\\x1b&#39;,
</span><span class='line'>   &#39;co_consts&#39;: (None,
</span><span class='line'>     3,
</span><span class='line'>     1,
</span><span class='line'>     &#39;&#39;,
</span><span class='line'>     {&#39;co_code&#39;: &#39;\\x8f\\x00\\x00\\x5d\\x15\\x00\\x87\\x01\\x00\\x7c\\x00\\x00\\x8f\\x01\\x00\\x64\\x00\\x00\\x4e\\x86\\x01\\x00\\x59\\x54\\x71\\x03\\x00\\x64\\x01\\x00\\x1b&#39;,
</span><span class='line'>      &#39;co_consts&#39;: (13, None),
</span><span class='line'>      &#39;co_name&#39;: &#39;&lt;genexpr&gt;&#39;,
</span><span class='line'>      &#39;co_names&#39;: (&#39;chr&#39;,),
</span><span class='line'>      &#39;co_varnames&#39;: (&#39;.0&#39;, &#39;_&#39;)},
</span><span class='line'>     75,
</span><span class='line'>     98,
</span><span class='line'>     127,
</span><span class='line'>     45,
</span><span class='line'>     89,
</span><span class='line'>     101,
</span><span class='line'>     104,
</span><span class='line'>     67,
</span><span class='line'>     122,
</span><span class='line'>     65,
</span><span class='line'>     120,
</span><span class='line'>     99,
</span><span class='line'>     108,
</span><span class='line'>     95,
</span><span class='line'>     125,
</span><span class='line'>     111,
</span><span class='line'>     97,
</span><span class='line'>     100,
</span><span class='line'>     110),
</span><span class='line'>   &#39;co_name&#39;: &#39;foo&#39;,
</span><span class='line'>   &#39;co_names&#39;: (&#39;True&#39;, &#39;quarkslab&#39;, &#39;append&#39;, &#39;join&#39;),
</span><span class='line'>   &#39;co_varnames&#39;: ()},
</span><span class='line'> &#39;func_dict&#39;: None,
</span><span class='line'> &#39;func_doc&#39;: None,
</span><span class='line'> &#39;func_module&#39;: &#39;__main__&#39;,
</span><span class='line'> &#39;func_name&#39;: &#39;foo&#39;}
</span></code></pre></td></tr></table></div></figure>


<p>Even before studying / disassembling the code, we see some interesting things: <em>chr</em>, <em>quarkslab</em>, <em>append</em>, <em>join</em>, etc. It definitely feels like that function is generating the flag we are looking for.</p>

<p>Seeing <em>append</em>, <em>join</em> and another code object (in <em>co_consts</em>) suggests that a <em>generator</em> is used to populate the variable <em>quarkslab</em>. We also can guess that the bunch of bytes we are seeing may be the flag encoded/encrypted &mdash; anyway we can infer <strong>too much information to me</strong> just by dumping/looking at the object.</p>

<p>Let&rsquo;s use our magic <a href="https://github.com/0vercl0k/stuffz/blob/master/ql-chall-python-2014/disassembler_ql_chall.py">disassembler.py</a> to see those codes objects:</p>

<figure class='code'><figcaption><span>part2 & its generator disassembled</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'> 19     &gt;&gt;    0 LOAD_GLOBAL              0 (True)
</span><span class='line'>              3 LOAD_CONST               1 (3)
</span><span class='line'>              6 COMPARE_OP               3 (!=)
</span><span class='line'>              9 POP_JUMP_IF_FALSE       25
</span><span class='line'>
</span><span class='line'> 20          12 LOAD_GLOBAL              0 (True)
</span><span class='line'>             15 LOAD_CONST               2 (1)
</span><span class='line'>             18 INPLACE_SUBTRACT
</span><span class='line'>             19 STORE_GLOBAL             0 (True)
</span><span class='line'>             22 JUMP_FORWARD           110 (to 135)
</span><span class='line'>
</span><span class='line'> 22     &gt;&gt;   25 LOAD_GLOBAL              1 (quarkslab)
</span><span class='line'>             28 LOAD_ATTR                2 (append)
</span><span class='line'>             31 LOAD_CONST               3 (&#39;&#39;)
</span><span class='line'>             34 LOAD_ATTR                3 (join)
</span><span class='line'>             37 LOAD_CONST               4 (&lt;code object &lt;genexpr&gt; at 023A84A0, file &quot;obfuscate/gen.py&quot;, line 22&gt;)
</span><span class='line'>             40 MAKE_FUNCTION            0
</span><span class='line'>             43 LOAD_CONST2              5 (75)
</span><span class='line'>             46 LOAD_CONST3              6 (98)
</span><span class='line'>             49 LOAD_CONST2              7 (127)
</span><span class='line'>             52 LOAD_CONST5              8 (45)
</span><span class='line'>             55 LOAD_CONST2              9 (89)
</span><span class='line'>             58 LOAD_CONST4             10 (101)
</span><span class='line'>             61 LOAD_CONST2             11 (104)
</span><span class='line'>             64 LOAD_CONST6              8 (45)
</span><span class='line'>             67 LOAD_CONST2             12 (67)
</span><span class='line'>             70 LOAD_CONST7             11 (104)
</span><span class='line'>             73 LOAD_CONST2             13 (122)
</span><span class='line'>             76 LOAD_CONST8              8 (45)
</span><span class='line'>             79 LOAD_CONST2             14 (65)
</span><span class='line'>             82 LOAD_CONST10            15 (120)
</span><span class='line'>             85 LOAD_CONST2             16 (99)
</span><span class='line'>             88 LOAD_CONST9             17 (108)
</span><span class='line'>             91 LOAD_CONST2              7 (127)
</span><span class='line'>             94 LOAD_CONST11             8 (45)
</span><span class='line'>             97 LOAD_CONST2             18 (95)
</span><span class='line'>            100 LOAD_CONST12            11 (104)
</span><span class='line'>            103 LOAD_CONST2             19 (125)
</span><span class='line'>            106 LOAD_CONST16            15 (120)
</span><span class='line'>            109 LOAD_CONST2             20 (111)
</span><span class='line'>            112 LOAD_CONST14            21 (97)
</span><span class='line'>            115 LOAD_CONST2             22 (100)
</span><span class='line'>            118 LOAD_CONST15            23 (110)
</span><span class='line'>            121 BUILD_LIST              26
</span><span class='line'>            124 GET_ITER
</span><span class='line'>            125 CALL_FUNCTION            1
</span><span class='line'>            128 CALL_FUNCTION            1
</span><span class='line'>            131 CALL_FUNCTION            1
</span><span class='line'>            134 POP_TOP
</span><span class='line'>        &gt;&gt;  135 LOAD_CONST               0 (None)
</span><span class='line'>            138 RETURN_VALUE
</span><span class='line'>================================================================================
</span><span class='line'> 22           0 LOAD_FAST                0 (.0)
</span><span class='line'>        &gt;&gt;    3 FOR_ITER                21 (to 27)
</span><span class='line'>              6 LOAD_CONST16             1 (None)
</span><span class='line'>              9 LOAD_GLOBAL              0 (chr)
</span><span class='line'>             12 LOAD_FAST                1 (_)
</span><span class='line'>             15 LOAD_CONST               0 (13)
</span><span class='line'>             18 BINARY_XOR
</span><span class='line'>             19 CALL_FUNCTION            1
</span><span class='line'>             22 YIELD_VALUE
</span><span class='line'>             23 POP_TOP
</span><span class='line'>             24 JUMP_ABSOLUTE            3
</span><span class='line'>        &gt;&gt;   27 LOAD_CONST               1 (None)
</span><span class='line'>             30 RETURN_VALUE
</span></code></pre></td></tr></table></div></figure>


<p>Great, that definitely sounds like what we described earlier.</p>

<h3>I need a decompiler dad</h3>

<p>Now because we really like to hack things, I decided to patch a Python decompiler to support the opcodes defined in this challenge in order to fully decompile the codes we saw so far.</p>

<p>I won&rsquo;t bother you with how I managed to do it though ; long story short: it is built it on top of <a href="https://github.com/gdelugre/fupy">fupy.py</a> which is a readable hackable Python 2.7 decompiler written by the awesome <a href="https://github.com/gdelugre">Guillaume Delugre</a> &mdash; Cheers to my mate <a href="https://twitter.com/Myst3rie">@Myst3rie</a> for telling about this project!</p>

<p>So here is <a href="https://github.com/0vercl0k/stuffz/blob/master/ql-chall-python-2014/decompiler_ql_chall.py">decompiler.py</a> working on the two code objects of the challenge:</p>

<figure class='code'><figcaption><span>decompiiiiiilation</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>PS D:\Codes\ql-chall-python-2014&gt; python .\decompiler_ql_chall.py
</span><span class='line'>PART1 ====================
</span><span class='line'>Robert_Forsyth = 1
</span><span class='line'>True = True + 1
</span><span class='line'>
</span><span class='line'>PART2 ====================
</span><span class='line'>if True != 3:
</span><span class='line'>    True = True - 1
</span><span class='line'>else:
</span><span class='line'>    quarkslab.append(&#39;&#39;.join(chr(_ ^ 13) for _ in [75, 98, 127, 45, 89, 101, 104, 45, 67, 104, 122, 45, 65, 120, 99, 108, 127, 45, 95, 104, 125, 120, 111, 97, 100, 110]))
</span></code></pre></td></tr></table></div></figure>


<p>Brilliant &mdash; time to get a flag now :&ndash;).
Here are the things we need to do:</p>

<ol>
<li>Set <em>True</em> to 2 (so that it&rsquo;s equal to 3 in the part 2)</li>
<li>Declare a <em>list</em> named <em>quarkslab</em></li>
<li>Jump over the middle part of the function where it will run the bytecode you gave as argument (or give a valid marshaled string that won&rsquo;t crash the interpreter)</li>
<li>Profit!</li>
</ol>


<figure class='code'><figcaption><span>win</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>overclok@wildout:~/chall/ql-py$ /usr/bin/b7d8438de09fffb12e3950e7ad4970a4a998403bdf3763dd4178adf
</span><span class='line'>Python 2.7.8+ (nvcs/newopcodes:a9bd62e4d5f2+, Sep  1 2014, 11:41:46)
</span><span class='line'>[GCC 4.8.2] on linux2
</span><span class='line'>Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
</span><span class='line'>&gt;&gt;&gt; True = 2
</span><span class='line'>&gt;&gt;&gt; quarkslab = list()
</span><span class='line'>&gt;&gt;&gt; import do_not_run_me as v
</span><span class='line'>&gt;&gt;&gt; v.run_me(&quot;c\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00C\x00\x00\x00s\x04\x00\x00\x00d\x00\x00\x1B(\x01\x00\x00\x00N(\x00\x00\x00\x00(\x00\x00\x00\x00(\x00\x00\x00\x00(\x00\x00\x00\x00s\x07\x00\x00\x00rstdinrt\x01\x00\x00\x00a\x01\x00\x00\x00s\x02\x00\x00\x00\x00\x01&quot;)
</span><span class='line'>&gt;&gt;&gt; quarkslab
</span><span class='line'>[&#39;For The New Lunar Republic&#39;]
</span></code></pre></td></tr></table></div></figure>


<h1>Conclusion</h1>

<p>This was definitely entertaining, so thanks to Serge and <a href="http://blog.quarkslab.com/">Quarkslab</a> for putting this challenge together! I feel like it would have been cooler to force people to write a disassembler or/and a decompiler to study the code of <em>run_me</em> though ; because as I mentioned at the very beginning of the article you don&rsquo;t really need any tool to guess/know roughly where the flag is, and how to get it. I still did write all those little scripts because it was fun and cool that&rsquo;s all!</p>

<p>Anyway, the codes I talked about are available on my github as usual if you want to have a look at them. You can also have look at <a href="https://github.com/0vercl0k/stuffz/blob/master/Python's%20internals/wildfire.py">wildfire.py</a> if you like weird/wild/whatever Python beasts!</p>

<p>That&rsquo;s all for today guys, I hope it wasn&rsquo;t too long and that you did enjoy the read.</p>

<p>By the way, we still think it would be cool to have more people posting on that blog, so if you are interested feel free to <a href="https://doar-e.github.io/about/">contact us</a>!</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Axel "0vercl0k" Souchet</span></span>

      








  


<time datetime="2014-09-06T20:37:00+01:00" pubdate data-updated="true">Sep 6<span>th</span>, 2014</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/python/'>python</a>, <a class='category' href='/blog/categories/reverse-engineering/'>reverse-engineering</a>, <a class='category' href='/blog/categories/virtual-machine/'>virtual machine</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/04/30/corrupting-arm-evt/" title="Previous Post: Corrupting the ARM Exception Vector Table">&laquo; Corrupting the ARM Exception Vector Table</a>
      
      
        <a class="basic-alignment right" href="/blog/2014/10/11/taiming-a-wild-nanomite-protected-mips-binary-with-symbolic-execution-no-such-crackme/" title="Next Post: Taming a wild nanomite-protected MIPS binary with symbolic execution: No Such Crackme">Taming a wild nanomite-protected MIPS binary with symbolic execution: No Such Crackme &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/10/11/taiming-a-wild-nanomite-protected-mips-binary-with-symbolic-execution-no-such-crackme/">Taming a wild nanomite-protected MIPS binary with symbolic execution: No Such Crackme</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/09/06/dissection-of-quarkslabs-2014-security-challenge/">Dissection of Quarkslab's 2014 security challenge</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/04/30/corrupting-arm-evt/">Corrupting the ARM Exception Vector Table</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/04/17/deep-dive-into-pythons-vm-story-of-load_const-bug/">Deep dive into Python's VM: Story of LOAD_CONST bug</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/03/11/first-dip-into-the-kernel-pool-ms10-058/">First dip into the kernel pool : MS10-058</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 -  Axel Souchet, Jonathan Salwan, Jérémy Fetiveau <br/>
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a> + <a href="https://github.com/ioveracker/mnml">mnml</a>.
	  
  </span>
</p>

</footer>
  












  <script type="text/javascript">
  jQuery(document).ready(function() {
    // Put a TOC right before the entry content.
    if(jQuery('div[id="tocBlock"]').length == 0)
        generateTOC('.entry-content-toc', null);
  });
  </script>

</body>
</html>
