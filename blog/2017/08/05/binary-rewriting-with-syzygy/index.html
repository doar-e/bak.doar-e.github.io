
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Binary rewriting with syzygy, Pt. I - Diary of a reverse-engineer</title>
  <meta name="author" content="Axel Souchet, Jonathan Salwan, Jérémy Fetiveau">

  
  <meta name="description" content="Introduction Binary instrumentation and analysis have been subjects that I have always found fascinating. At compile time via clang, or at runtime &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://doar-e.github.io/blog/2017/08/05/binary-rewriting-with-syzygy">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Diary of a reverse-engineer" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <script src="/javascripts/jquery.tableofcontents.min.js" type="text/javascript"></script>
  <script src="/javascripts/generate-toc.js" type="text/javascript"></script>

  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="https://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-43481215-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>



  <style>
    p { text-align: justify; }
  </style>

</head>
<body   class="collapse-sidebar sidebar-footer" >
  <header role="banner"><img src="/images/sigle-blanc-250px.jpg"></img>

	<div class="header-title"><a href="/">Diary of a reverse-engineer</a></div>


	<br><div class="header-subtitle">Because we like to play with weird things.</div>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:doar-e.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About</a></li>
  <li><a href="/presentations">Presentations</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
  
    
      <h1 class="entry-title">Binary Rewriting With Syzygy, Pt. I</h1>
    
  
    
      <p class="meta">
        








  


<time datetime="2017-08-05T16:08:00-07:00" pubdate data-updated="true">Aug 5<span>th</span>, 2017</time>
        
      </p>
    
  </header>


<div class="entry-content"><h1>Introduction</h1>

<p>Binary instrumentation and analysis have been subjects that I have always found fascinating. At compile time via <a href="http://doar-e.github.io/blog/2016/11/27/clang-and-passes/">clang</a>, or at runtime with dynamic binary instrumentation frameworks like <a href="https://software.intel.com/en-us/articles/pin-a-dynamic-binary-instrumentation-tool">Pin</a> or <a href="http://www.dynamorio.org/">DynamoRIO</a>. One thing I have always looked for though, is a framework able to statically instrument a PE image. A framework designed a bit like <a href="https://clang.llvm.org/">clang</a> where you can write &lsquo;passes&rsquo; doing various things: transformation of the image, analysis of code blocks, etc. Until a couple of months ago, I wasn&rsquo;t aware of any public and robust projects providing this capability (as in, able to instrument real-world scale programs like Chrome or similar).</p>

<p>In this post (it&rsquo;s been a while I know!), I&rsquo;ll introduce the <a href="https://github.com/google/syzygy">syzygy</a> transformation tool chain with a focus on its <a href="https://github.com/google/syzygy/tree/master/syzygy/instrument">instrumenter</a>, and give an overview of the framework, its capabilities, its limitations, and how you can write transformations yourself. As examples, I&rsquo;ll walk through two simple examples: an analysis pass generating a call-graph, and a transformation pass rewriting the function <code>__report_gsfailure</code> in <a href="https://msdn.microsoft.com/en-us/library/8dbf701c.aspx">/GS</a> protected binaries.</p>

<div class='entry-content-toc'></div>




<!--more-->


<h1>Syzygy</h1>

<h2>Introduction and a little bit of History</h2>

<p><a href="https://github.com/google/syzygy/wiki">syzygy</a> is a project written by Google labeled as a &ldquo;transformation tool chain&rdquo;. It encompasses a suite of various utilities: <a href="https://github.com/google/syzygy/blob/master/syzygy/instrument/instrument_app.cc">instrument.exe</a> is the application invoking the various transformation passes and apply them on a binary, <a href="https://github.com/google/syzygy/blob/master/syzygy/grinder/grinder_app.cc">grinder.exe</a>, <a href="https://github.com/google/syzygy/blob/master/syzygy/reorder/reorder_app.cc">reorder.exe</a>, etc. In a nutshell, the framework is able to (non exhaustive list):</p>

<ul>
<li>Read and write PDB files,</li>
<li>&lsquo;Decompose&rsquo; PE32 binaries built with MSVC (with the help of full PDB symbol),</li>
<li>Assemble Intel x86 32 bits code,</li>
<li>Disassemble Intel x86 32 bits code (via <a href="https://github.com/google/syzygy/tree/master/third_party/distorm">Distorm</a>),</li>
<li>&lsquo;Relink&rsquo; an instrumented binary.</li>
</ul>


<p>You also may have briefly heard about the project a while back in this post from May 2013 on Chromium&rsquo;s blog: <a href="https://blog.chromium.org/2013/05/testing-chromium-syzyasan-lightweight.html">Testing Chromium: SyzyASAN, a lightweight heap error detector</a>. As I am sure you all know, <a href="https://github.com/google/sanitizers/wiki/AddressSanitizer">AddressSanitizer</a> is a compile-time instrumentation whose purpose is to <a href="https://github.com/google/sanitizers/wiki/AddressSanitizerAlgorithm">detect memory errors</a> in C/C++ programs. Long story short, AddressSanitizer tracks the state of your program&rsquo;s memory and instrument memory operations (read / write / heap allocation / heap free) at runtime to make sure that they are &lsquo;safe&rsquo;. For example, in a normal situation reading off by one out-of-bounds on a static sized stack buffer will most likely not result in a crash. AddressSanitizer&rsquo;s job is to detect this issue and to report it to the user.</p>

<p>Currently there is no real equivalent on Windows platforms. The only supported available technology that could help with detecting memory errors is the <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/gflags-and-pageheap">Page Heap</a>. Even though today, clang for Windows is working (<a href="https://groups.google.com/a/chromium.org/forum/#!topic/chromium-dev/Y3OEIKkdlu0">Chrome</a> announced that <a href="https://chromium.googlesource.com/chromium/src/+/d2c91228a51bdf37ae3b2e501fb53c0528f1629c">Windows builds of Chrome now use clang</a>), this was not the case back in 2013. As a result, Google built <a href="https://github.com/google/syzygy/wiki/SyzyASanDesignDocument">SyzyASAN</a>, which is the name of a <a href="https://github.com/google/syzygy/blob/master/syzygy/instrument/transforms/asan_transform.h">transformation</a> aiming at detecting memory errors in PE32 binaries. This transform is built on top of the syzygy framework, and you can instrument your binary with it via the <a href="https://github.com/google/syzygy/blob/master/syzygy/instrument/instrument_app.cc#L94">instrument.exe</a> tool. One consequence of the above, is that the framework has to be robust and accurate enough to instrument Chrome; as a result the code is heavily tested which is awesome for us (it is also nearly the only documentation available too 0:&ndash;))!</p>

<h2>Compiling</h2>

<p>In order to get a development environment setup you need to follow specific steps to get all the chromium build/dev tools installed. <a href="https://dev.chromium.org/developers/how-tos/install-depot-tools">depot_tools</a> is the name of the package containing everything you need to properly build the various chromium projects; it includes things like Python, <a href="https://gyp.gsrc.io/">GYP</a>, <a href="https://ninja-build.org/">Ninja</a>, git, etc.</p>

<p>Once depot_tools is installed, it is just a matter of executing the below commands for getting the code and compiling it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt; set PATH=D:\Codes\depot_tools;%PATH%
</span><span class='line'>&gt; mkdir syzygy
</span><span class='line'>&gt; cd syzygy
</span><span class='line'>&gt; fetch syzygy
</span><span class='line'>&gt; cd syzygy\src
</span><span class='line'>&gt; ninja -C out\Release instrument
</span></code></pre></td></tr></table></div></figure>


<p>If you would like more information on the matter, I suggest you read this wiki page: <a href="https://github.com/google/syzygy/wiki/SyzygyDevelopmentGuide">SyzygyDevelopmentGuide</a>.</p>

<h2>Terminology</h2>

<p>The terminology used across the project can be a bit misleading or confusing at first, so it is a good time to describe the key terms and their meanings: a <a href="https://github.com/google/syzygy/blob/master/syzygy/block_graph/block_graph.h">BlockGraph</a> is a basically a container of blocks. A <a href="https://github.com/google/syzygy/blob/master/syzygy/block_graph/block_graph.h#L542">BlockGraph::Block</a> can be either a code block, or a data block (the <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms680336(v=vs.85).aspx">IMAGE_NT_HEADERS</a> of your binary would be a data block for example). Every block has various properties like an identifier, a name, etc. and belongs to a section (as in PE sections). Most of those properties are mutable, and you are free to play with them and they will get picked-up by the back-end when relinking the output image. In addition to being a top-level container of blocks, the BlockGraph also keeps track of the sections in your executable. Blocks also have a concept of referrers and references. A reference is basically a link from Block <code>foo</code> to Block <code>bar</code>; where <code>bar</code> is the referent. A referrer can be seen as a cross-reference (in the IDA sense): <code>foo</code> would be a referrer of <code>bar</code>. These two key concepts are very important when building transforms as they also allow you to walk the graph faster. Transferring referrers to another Block is also a very easy operation for example (and is super powerful).</p>

<p>Something that also got me confused at first is their name for a Block is not a basic-block as we know them. Instead, it is a function; a set of basic-blocks. Another key concept being used is called <a href="https://github.com/google/syzygy/blob/master/syzygy/block_graph/block_graph.h#L574">SourceRanges</a>. As Blocks can be combined together or split, they are made so that they look after their own address-space mapping bytes from the original image to bytes in the block.</p>

<p>Finally, the container of basic-blocks as we know them is a <a href="https://github.com/google/syzygy/blob/master/syzygy/block_graph/basic_block_subgraph.h#L38">BasicBlockSubGraph</a> (I briefly mention it a bit later in the post).</p>

<p>Oh, one last thing: the instrumenter is basically the application that decomposes an input binary (comparable to a front-end), present the deconstructed binary (functions, blocks, instructions) to transforms (comparable to a mid-end) that modifies, and finally the back-end part that reconstruct your instrumented binary.</p>

<h2>Debugging session</h2>

<p>To make things clearer &ndash; and because I like debugging sessions &ndash; I think it is worthwhile to spend a bit of time in a debugger actually seeing the various structures and how they map to some code we know. Let&rsquo;s take the following C program and compile it in debug mode (don&rsquo;t forget to enable the full PDB generation with the following linker flag: <code>/PROFILE</code>):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">foo</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">x</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Binary rewriting with syzygy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Hello doar-e.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="n">foo</span><span class="p">(</span><span class="n">argc</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Throw it to your favorite debugger with the following command &ndash; we will use the afl transformation as an example transform to analyze the data we have available to us:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">instrument</span><span class="p">.</span><span class="n">exe</span> <span class="o">--</span><span class="n">mode</span><span class="o">=</span><span class="n">afl</span> <span class="o">--</span><span class="n">input</span><span class="o">-</span><span class="n">image</span><span class="o">=</span><span class="n">test</span><span class="p">.</span><span class="n">exe</span> <span class="o">--</span><span class="n">output</span><span class="o">-</span><span class="n">image</span><span class="o">=</span><span class="n">test</span><span class="p">.</span><span class="n">instr</span><span class="p">.</span><span class="n">exe</span>
</span></code></pre></td></tr></table></div></figure>


<p>And let&rsquo;s place this breakpoint:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">bm</span> <span class="n">instrument</span><span class="o">!*</span><span class="n">AFLTransform</span><span class="o">::</span><span class="n">OnBlock</span> <span class="s">&quot;.if(@@c++(block-&gt;type_ == 0)){ }.else{ g }&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now it&rsquo;s time to inspect the Block associated with our function <code>foo</code> from above:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="mi">0</span><span class="o">:</span><span class="mo">000</span><span class="o">&gt;</span> <span class="n">g</span>
</span><span class='line'><span class="n">eax</span><span class="o">=</span><span class="mo">002</span><span class="n">dcf80</span> <span class="n">ebx</span><span class="o">=</span><span class="mo">00000051</span> <span class="n">ecx</span><span class="o">=</span><span class="mo">004</span><span class="mi">82</span><span class="n">da8</span> <span class="n">edx</span><span class="o">=</span><span class="mo">004</span><span class="n">eaba0</span> <span class="n">esi</span><span class="o">=</span><span class="mo">004</span><span class="n">bd398</span> <span class="n">edi</span><span class="o">=</span><span class="mo">004</span><span class="n">bd318</span>
</span><span class='line'><span class="n">eip</span><span class="o">=</span><span class="mo">002</span><span class="n">dcf80</span> <span class="n">esp</span><span class="o">=</span><span class="mf">0113f</span><span class="mi">4</span><span class="n">b8</span> <span class="n">ebp</span><span class="o">=</span><span class="mf">0113f</span><span class="mi">4</span><span class="n">c8</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">po</span> <span class="n">nc</span>
</span><span class='line'><span class="n">cs</span><span class="o">=</span><span class="mo">0023</span>  <span class="n">ss</span><span class="o">=</span><span class="mo">002</span><span class="n">b</span>  <span class="n">ds</span><span class="o">=</span><span class="mo">002</span><span class="n">b</span>  <span class="n">es</span><span class="o">=</span><span class="mo">002</span><span class="n">b</span>  <span class="n">fs</span><span class="o">=</span><span class="mo">0053</span>  <span class="n">gs</span><span class="o">=</span><span class="mo">002</span><span class="n">b</span>             <span class="n">efl</span><span class="o">=</span><span class="mo">00000202</span>
</span><span class='line'><span class="n">instrument</span><span class="o">!</span><span class="n">instrument</span><span class="o">::</span><span class="n">transforms</span><span class="o">::</span><span class="n">AFLTransform</span><span class="o">::</span><span class="n">OnBlock</span><span class="o">:</span>
</span><span class='line'><span class="mo">002</span><span class="n">dcf80</span> <span class="mi">55</span>              <span class="n">push</span>    <span class="n">ebp</span>
</span><span class='line'><span class="mi">0</span><span class="o">:</span><span class="mo">000</span><span class="o">&gt;</span> <span class="n">dx</span> <span class="n">block</span>
</span><span class='line'>  <span class="p">[</span><span class="o">+</span><span class="mh">0x000</span><span class="p">]</span> <span class="n">id_</span>              <span class="o">:</span> <span class="mh">0x51</span>
</span><span class='line'>  <span class="p">[</span><span class="o">+</span><span class="mh">0x004</span><span class="p">]</span> <span class="n">type_</span>            <span class="o">:</span> <span class="n">CODE_BLOCK</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>  <span class="p">[</span><span class="o">+</span><span class="mh">0x008</span><span class="p">]</span> <span class="n">size_</span>            <span class="o">:</span> <span class="mh">0x5b</span>
</span><span class='line'>  <span class="p">[</span><span class="o">+</span><span class="mh">0x00c</span><span class="p">]</span> <span class="n">alignment_</span>       <span class="o">:</span> <span class="mh">0x1</span>
</span><span class='line'>  <span class="p">[</span><span class="o">+</span><span class="mh">0x010</span><span class="p">]</span> <span class="n">alignment_offset_</span> <span class="o">:</span> <span class="mi">0</span>
</span><span class='line'>  <span class="p">[</span><span class="o">+</span><span class="mh">0x014</span><span class="p">]</span> <span class="n">padding_before_</span>  <span class="o">:</span> <span class="mh">0x0</span>
</span><span class='line'>  <span class="p">[</span><span class="o">+</span><span class="mh">0x018</span><span class="p">]</span> <span class="n">name_</span>            <span class="o">:</span> <span class="mh">0x4ffc70</span> <span class="o">:</span> <span class="s">&quot;foo&quot;</span>
</span><span class='line'>  <span class="p">[</span><span class="o">+</span><span class="mh">0x01c</span><span class="p">]</span> <span class="n">compiland_name_</span>  <span class="o">:</span> <span class="mh">0x4c50b0</span> <span class="o">:</span> <span class="s">&quot;D:</span><span class="se">\t</span><span class="s">mp</span><span class="se">\t</span><span class="s">est\Debug\main.obj&quot;</span>
</span><span class='line'>  <span class="p">[</span><span class="o">+</span><span class="mh">0x020</span><span class="p">]</span> <span class="n">addr_</span>            <span class="p">[</span><span class="n">Type</span><span class="o">:</span> <span class="n">core</span><span class="o">::</span><span class="n">detail</span><span class="o">::</span><span class="n">AddressImpl</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">]</span>
</span><span class='line'>  <span class="p">[</span><span class="o">+</span><span class="mh">0x024</span><span class="p">]</span> <span class="n">block_graph_</span>     <span class="o">:</span> <span class="mh">0x48d10c</span>
</span><span class='line'>  <span class="p">[</span><span class="o">+</span><span class="mh">0x028</span><span class="p">]</span> <span class="n">section_</span>         <span class="o">:</span> <span class="mh">0x0</span>
</span><span class='line'>  <span class="p">[</span><span class="o">+</span><span class="mh">0x02c</span><span class="p">]</span> <span class="n">attributes_</span>      <span class="o">:</span> <span class="mh">0x8</span>
</span><span class='line'>  <span class="p">[</span><span class="o">+</span><span class="mh">0x030</span><span class="p">]</span> <span class="n">references_</span>      <span class="o">:</span> <span class="p">{</span> <span class="n">size</span><span class="o">=</span><span class="mh">0x3</span> <span class="p">}</span>
</span><span class='line'>  <span class="p">[</span><span class="o">+</span><span class="mh">0x038</span><span class="p">]</span> <span class="n">referrers_</span>       <span class="o">:</span> <span class="p">{</span> <span class="n">size</span><span class="o">=</span><span class="mh">0x1</span> <span class="p">}</span>
</span><span class='line'>  <span class="p">[</span><span class="o">+</span><span class="mh">0x040</span><span class="p">]</span> <span class="n">source_ranges_</span>   <span class="p">[</span><span class="n">Type</span><span class="o">:</span> <span class="n">core</span><span class="o">::</span><span class="n">AddressRangeMap</span><span class="o">&lt;</span><span class="n">core</span><span class="o">::</span><span class="n">AddressRange</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="o">&gt;</span><span class="p">,</span><span class="n">core</span><span class="o">::</span><span class="n">AddressRange</span><span class="o">&lt;</span><span class="n">core</span><span class="o">::</span><span class="n">detail</span><span class="o">::</span><span class="n">AddressImpl</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">]</span>
</span><span class='line'>  <span class="p">[</span><span class="o">+</span><span class="mh">0x04c</span><span class="p">]</span> <span class="n">labels_</span>          <span class="o">:</span> <span class="p">{</span> <span class="n">size</span><span class="o">=</span><span class="mh">0x3</span> <span class="p">}</span>
</span><span class='line'>  <span class="p">[</span><span class="o">+</span><span class="mh">0x054</span><span class="p">]</span> <span class="n">owns_data_</span>       <span class="o">:</span> <span class="nb">false</span>
</span><span class='line'>  <span class="p">[</span><span class="o">+</span><span class="mh">0x058</span><span class="p">]</span> <span class="n">data_</span>            <span class="o">:</span> <span class="mh">0x49ef50</span> <span class="o">:</span> <span class="mh">0x55</span>
</span><span class='line'>  <span class="p">[</span><span class="o">+</span><span class="mh">0x05c</span><span class="p">]</span> <span class="n">data_size_</span>       <span class="o">:</span> <span class="mh">0x5b</span>
</span></code></pre></td></tr></table></div></figure>


<p>The above shows us every the different properties available in a Block; we can see it is named <code>foo</code>, has the identifier 0x51 and has a size of 0x5B bytes.</p>

<p><img class="center" src="/images/binary_rewriting_with_syzygy/foo_idaview.png"></p>

<p>It also has one referrer and 3 references, what could they be? With the explanation I gave above, we can guess that the referrer (or cross-ref) must be the <code>main</code> function as it calls into <code>foo</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="mi">0</span><span class="o">:</span><span class="mo">000</span><span class="o">&gt;</span> <span class="n">dx</span> <span class="o">-</span><span class="n">r1</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">instrument</span><span class="o">!</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">block_graph</span><span class="o">::</span><span class="n">BlockGraph</span><span class="o">::</span><span class="n">Block</span> <span class="o">*</span><span class="p">,</span><span class="kt">int</span><span class="o">&gt;</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x4f87c0</span><span class="p">))</span>
</span><span class='line'>  <span class="n">first</span>            <span class="o">:</span> <span class="mh">0x4bd3ac</span>
</span><span class='line'>  <span class="n">second</span>           <span class="o">:</span> <span class="mi">48</span>
</span><span class='line'><span class="mi">0</span><span class="o">:</span><span class="mo">000</span><span class="o">&gt;</span> <span class="n">dx</span> <span class="o">-</span><span class="n">r1</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">instrument</span><span class="o">!</span><span class="n">block_graph</span><span class="o">::</span><span class="n">BlockGraph</span><span class="o">::</span><span class="n">Block</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x4bd3ac</span><span class="p">))</span>
</span><span class='line'>    <span class="p">[</span><span class="o">+</span><span class="mh">0x000</span><span class="p">]</span> <span class="n">id_</span>              <span class="o">:</span> <span class="mh">0x52</span>
</span><span class='line'>    <span class="p">[</span><span class="o">+</span><span class="mh">0x004</span><span class="p">]</span> <span class="n">type_</span>            <span class="o">:</span> <span class="n">CODE_BLOCK</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>    <span class="p">[</span><span class="o">+</span><span class="mh">0x008</span><span class="p">]</span> <span class="n">size_</span>            <span class="o">:</span> <span class="mh">0x4d</span>
</span><span class='line'>    <span class="p">[</span><span class="o">+</span><span class="mh">0x00c</span><span class="p">]</span> <span class="n">alignment_</span>       <span class="o">:</span> <span class="mh">0x1</span>
</span><span class='line'>    <span class="p">[</span><span class="o">+</span><span class="mh">0x010</span><span class="p">]</span> <span class="n">alignment_offset_</span> <span class="o">:</span> <span class="mi">0</span>
</span><span class='line'>    <span class="p">[</span><span class="o">+</span><span class="mh">0x014</span><span class="p">]</span> <span class="n">padding_before_</span>  <span class="o">:</span> <span class="mh">0x0</span>
</span><span class='line'>    <span class="p">[</span><span class="o">+</span><span class="mh">0x018</span><span class="p">]</span> <span class="n">name_</span>            <span class="o">:</span> <span class="mh">0x4c51a0</span> <span class="o">:</span> <span class="s">&quot;main&quot;</span>
</span><span class='line'>    <span class="p">[</span><span class="o">+</span><span class="mh">0x01c</span><span class="p">]</span> <span class="n">compiland_name_</span>  <span class="o">:</span> <span class="mh">0x4c50b0</span> <span class="o">:</span> <span class="s">&quot;D:</span><span class="se">\t</span><span class="s">mp</span><span class="se">\t</span><span class="s">est\Debug\main.obj&quot;</span>
</span><span class='line'>    <span class="p">[</span><span class="o">+</span><span class="mh">0x020</span><span class="p">]</span> <span class="n">addr_</span>            <span class="p">[</span><span class="n">Type</span><span class="o">:</span> <span class="n">core</span><span class="o">::</span><span class="n">detail</span><span class="o">::</span><span class="n">AddressImpl</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">]</span>
</span><span class='line'>    <span class="p">[</span><span class="o">+</span><span class="mh">0x024</span><span class="p">]</span> <span class="n">block_graph_</span>     <span class="o">:</span> <span class="mh">0x48d10c</span>
</span><span class='line'>    <span class="p">[</span><span class="o">+</span><span class="mh">0x028</span><span class="p">]</span> <span class="n">section_</span>         <span class="o">:</span> <span class="mh">0x0</span>
</span><span class='line'>    <span class="p">[</span><span class="o">+</span><span class="mh">0x02c</span><span class="p">]</span> <span class="n">attributes_</span>      <span class="o">:</span> <span class="mh">0x8</span>
</span><span class='line'>    <span class="p">[</span><span class="o">+</span><span class="mh">0x030</span><span class="p">]</span> <span class="n">references_</span>      <span class="o">:</span> <span class="p">{</span> <span class="n">size</span><span class="o">=</span><span class="mh">0x4</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">[</span><span class="o">+</span><span class="mh">0x038</span><span class="p">]</span> <span class="n">referrers_</span>       <span class="o">:</span> <span class="p">{</span> <span class="n">size</span><span class="o">=</span><span class="mh">0x1</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">[</span><span class="o">+</span><span class="mh">0x040</span><span class="p">]</span> <span class="n">source_ranges_</span>   <span class="p">[</span><span class="n">Type</span><span class="o">:</span> <span class="n">core</span><span class="o">::</span><span class="n">AddressRangeMap</span><span class="o">&lt;</span><span class="n">core</span><span class="o">::</span><span class="n">AddressRange</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="o">&gt;</span><span class="p">,</span><span class="n">core</span><span class="o">::</span><span class="n">AddressRange</span><span class="o">&lt;</span><span class="n">core</span><span class="o">::</span><span class="n">detail</span><span class="o">::</span><span class="n">AddressImpl</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">]</span>
</span><span class='line'>    <span class="p">[</span><span class="o">+</span><span class="mh">0x04c</span><span class="p">]</span> <span class="n">labels_</span>          <span class="o">:</span> <span class="p">{</span> <span class="n">size</span><span class="o">=</span><span class="mh">0x3</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">[</span><span class="o">+</span><span class="mh">0x054</span><span class="p">]</span> <span class="n">owns_data_</span>       <span class="o">:</span> <span class="nb">false</span>
</span><span class='line'>    <span class="p">[</span><span class="o">+</span><span class="mh">0x058</span><span class="p">]</span> <span class="n">data_</span>            <span class="o">:</span> <span class="mh">0x49efb0</span> <span class="o">:</span> <span class="mh">0x55</span>
</span><span class='line'>    <span class="p">[</span><span class="o">+</span><span class="mh">0x05c</span><span class="p">]</span> <span class="n">data_size_</span>       <span class="o">:</span> <span class="mh">0x4d</span>
</span></code></pre></td></tr></table></div></figure>


<p>Something to keep in mind when it comes to <a href="https://github.com/google/syzygy/blob/master/syzygy/block_graph/block_graph.h#L1046">references</a> is that they are not simply a pointer to a block. A reference does indeed reference a block (duh), but it also has an offset associated to this block to point exactly at where the data is being referenced from.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="c1">// Represents a reference from one block to another. References may be offset.</span>
</span><span class='line'><span class="c1">// That is, they may refer to an object at a given location, but actually point</span>
</span><span class='line'><span class="c1">// to a location that is some fixed distance away from that object. This allows,</span>
</span><span class='line'><span class="c1">// for example, non-zero based indexing into a table. The object that is</span>
</span><span class='line'><span class="c1">// intended to be dereferenced is called the &#39;base&#39; of the offset.</span>
</span><span class='line'><span class="c1">//</span>
</span><span class='line'><span class="c1">// BlockGraph references are from a location (offset) in one block, to some</span>
</span><span class='line'><span class="c1">// location in another block. The referenced block itself plays the role of the</span>
</span><span class='line'><span class="c1">// &#39;base&#39; of the reference, with the offset of the reference being stored as</span>
</span><span class='line'><span class="c1">// an integer from the beginning of the block. However, basic block</span>
</span><span class='line'><span class="c1">// decomposition requires breaking the block into smaller pieces and thus we</span>
</span><span class='line'><span class="c1">// need to carry around an explicit base value, indicating which byte in the</span>
</span><span class='line'><span class="c1">// block is intended to be referenced.</span>
</span><span class='line'><span class="c1">//</span>
</span><span class='line'><span class="c1">// A direct reference to a location will have the same value for &#39;base&#39; and</span>
</span><span class='line'><span class="c1">// &#39;offset&#39;.</span>
</span><span class='line'><span class="c1">//</span>
</span><span class='line'><span class="c1">// Here is an example:</span>
</span><span class='line'><span class="c1">//</span>
</span><span class='line'><span class="c1">//        /----------\</span>
</span><span class='line'><span class="c1">//        +---------------------------+</span>
</span><span class='line'><span class="c1">//  O     |          B                | &lt;--- Referenced block</span>
</span><span class='line'><span class="c1">//        +---------------------------+      B = base</span>
</span><span class='line'><span class="c1">//  \-----/                                  O = offset</span>
</span><span class='line'><span class="c1">//</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s have a look at the references associated with the <code>foo</code> block now. If you look closely at the block, the set of references is of size 3&hellip; what could they be?</p>

<p>One for the <code>printf</code> function, one for the data Block for the string passed to <code>printf</code> maybe?</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="n">First</span> <span class="nl">reference:</span>
</span><span class='line'><span class="o">----------------</span>
</span><span class='line'>
</span><span class='line'><span class="mi">0</span><span class="o">:</span><span class="mo">000</span><span class="o">&gt;</span> <span class="n">dx</span> <span class="o">-</span><span class="n">r1</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">instrument</span><span class="o">!</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="kt">int</span> <span class="k">const</span> <span class="p">,</span><span class="n">block_graph</span><span class="o">::</span><span class="n">BlockGraph</span><span class="o">::</span><span class="n">Reference</span><span class="o">&gt;</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x4f5640</span><span class="p">))</span>
</span><span class='line'>    <span class="n">first</span>            <span class="o">:</span> <span class="mi">57</span>
</span><span class='line'>    <span class="n">second</span>           <span class="p">[</span><span class="nl">Type:</span> <span class="n">block_graph</span><span class="o">::</span><span class="n">BlockGraph</span><span class="o">::</span><span class="n">Reference</span><span class="p">]</span>
</span><span class='line'><span class="mi">0</span><span class="o">:</span><span class="mo">000</span><span class="o">&gt;</span> <span class="n">dx</span> <span class="o">-</span><span class="n">r1</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">instrument</span><span class="o">!</span><span class="n">block_graph</span><span class="o">::</span><span class="n">BlockGraph</span><span class="o">::</span><span class="n">Reference</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x4f5644</span><span class="p">))</span>
</span><span class='line'>    <span class="p">[</span><span class="o">+</span><span class="mh">0x000</span><span class="p">]</span> <span class="n">type_</span>            <span class="o">:</span> <span class="n">ABSOLUTE_REF</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">[</span><span class="nl">Type:</span> <span class="n">block_graph</span><span class="o">::</span><span class="n">BlockGraph</span><span class="o">::</span><span class="n">ReferenceType</span><span class="p">]</span>
</span><span class='line'>    <span class="p">[</span><span class="o">+</span><span class="mh">0x004</span><span class="p">]</span> <span class="n">size_</span>            <span class="o">:</span> <span class="mh">0x4</span>
</span><span class='line'>    <span class="p">[</span><span class="o">+</span><span class="mh">0x008</span><span class="p">]</span> <span class="n">referenced_</span>      <span class="o">:</span> <span class="mh">0x4ce334</span>
</span><span class='line'>    <span class="p">[</span><span class="o">+</span><span class="mh">0x00c</span><span class="p">]</span> <span class="n">offset_</span>          <span class="o">:</span> <span class="mi">0</span>
</span><span class='line'>    <span class="p">[</span><span class="o">+</span><span class="mh">0x010</span><span class="p">]</span> <span class="n">base_</span>            <span class="o">:</span> <span class="mi">0</span>
</span><span class='line'><span class="mi">0</span><span class="o">:</span><span class="mo">000</span><span class="o">&gt;</span> <span class="n">dx</span> <span class="o">-</span><span class="n">r1</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">instrument</span><span class="o">!</span><span class="n">block_graph</span><span class="o">::</span><span class="n">BlockGraph</span><span class="o">::</span><span class="n">Block</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x4ce334</span><span class="p">))</span>
</span><span class='line'>    <span class="p">[</span><span class="o">+</span><span class="mh">0x000</span><span class="p">]</span> <span class="n">id_</span>              <span class="o">:</span> <span class="mh">0xbc</span>
</span><span class='line'>    <span class="p">[</span><span class="o">+</span><span class="mh">0x004</span><span class="p">]</span> <span class="n">type_</span>            <span class="o">:</span> <span class="n">DATA_BLOCK</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'><span class="p">[...]</span>
</span><span class='line'>    <span class="p">[</span><span class="o">+</span><span class="mh">0x018</span><span class="p">]</span> <span class="n">name_</span>            <span class="o">:</span> <span class="mh">0xbb90f8</span> <span class="o">:</span> <span class="s">&quot;??_C@_0BO@LBGMPKED@Binary?5rewriting?5with?5syzygy?6?$AA@&quot;</span>
</span><span class='line'>    <span class="p">[</span><span class="o">+</span><span class="mh">0x01c</span><span class="p">]</span> <span class="n">compiland_name_</span>  <span class="o">:</span> <span class="mh">0x4c50b0</span> <span class="o">:</span> <span class="s">&quot;D:</span><span class="se">\t</span><span class="s">mp</span><span class="se">\t</span><span class="s">est\Debug\main.obj&quot;</span>
</span><span class='line'><span class="p">[...]</span>
</span><span class='line'>    <span class="p">[</span><span class="o">+</span><span class="mh">0x058</span><span class="p">]</span> <span class="n">data_</span>            <span class="o">:</span> <span class="mh">0x4a11e0</span> <span class="o">:</span> <span class="mh">0x42</span>
</span><span class='line'>    <span class="p">[</span><span class="o">+</span><span class="mh">0x05c</span><span class="p">]</span> <span class="n">data_size_</span>       <span class="o">:</span> <span class="mh">0x1e</span>
</span><span class='line'><span class="mi">0</span><span class="o">:</span><span class="mo">000</span><span class="o">&gt;</span> <span class="n">da</span> <span class="mh">0x4a11e0</span>
</span><span class='line'><span class="mo">004</span><span class="n">a11e0</span>  <span class="s">&quot;Binary rewriting with syzygy.&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="n">Second</span> <span class="nl">reference:</span>
</span><span class='line'><span class="o">-----------------</span>
</span><span class='line'>
</span><span class='line'><span class="mi">0</span><span class="o">:</span><span class="mo">000</span><span class="o">&gt;</span> <span class="n">dx</span> <span class="o">-</span><span class="n">r1</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">instrument</span><span class="o">!</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="kt">int</span> <span class="k">const</span> <span class="p">,</span><span class="n">block_graph</span><span class="o">::</span><span class="n">BlockGraph</span><span class="o">::</span><span class="n">Reference</span><span class="o">&gt;</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x4f56a0</span><span class="p">))</span>
</span><span class='line'>    <span class="n">first</span>            <span class="o">:</span> <span class="mi">62</span>
</span><span class='line'>    <span class="n">second</span>           <span class="p">[</span><span class="nl">Type:</span> <span class="n">block_graph</span><span class="o">::</span><span class="n">BlockGraph</span><span class="o">::</span><span class="n">Reference</span><span class="p">]</span>
</span><span class='line'><span class="mi">0</span><span class="o">:</span><span class="mo">000</span><span class="o">&gt;</span> <span class="n">dx</span> <span class="o">-</span><span class="n">r1</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">instrument</span><span class="o">!</span><span class="n">block_graph</span><span class="o">::</span><span class="n">BlockGraph</span><span class="o">::</span><span class="n">Reference</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x4f56a4</span><span class="p">))</span>
</span><span class='line'>    <span class="p">[</span><span class="o">+</span><span class="mh">0x000</span><span class="p">]</span> <span class="n">type_</span>            <span class="o">:</span> <span class="n">PC_RELATIVE_REF</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">[</span><span class="nl">Type:</span> <span class="n">block_graph</span><span class="o">::</span><span class="n">BlockGraph</span><span class="o">::</span><span class="n">ReferenceType</span><span class="p">]</span>
</span><span class='line'>    <span class="p">[</span><span class="o">+</span><span class="mh">0x004</span><span class="p">]</span> <span class="n">size_</span>            <span class="o">:</span> <span class="mh">0x4</span>
</span><span class='line'>    <span class="p">[</span><span class="o">+</span><span class="mh">0x008</span><span class="p">]</span> <span class="n">referenced_</span>      <span class="o">:</span> <span class="mh">0x4bd42c</span>
</span><span class='line'>    <span class="p">[</span><span class="o">+</span><span class="mh">0x00c</span><span class="p">]</span> <span class="n">offset_</span>          <span class="o">:</span> <span class="mi">0</span>
</span><span class='line'>    <span class="p">[</span><span class="o">+</span><span class="mh">0x010</span><span class="p">]</span> <span class="n">base_</span>            <span class="o">:</span> <span class="mi">0</span>
</span><span class='line'><span class="mi">0</span><span class="o">:</span><span class="mo">000</span><span class="o">&gt;</span> <span class="n">dx</span> <span class="o">-</span><span class="n">r1</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">instrument</span><span class="o">!</span><span class="n">block_graph</span><span class="o">::</span><span class="n">BlockGraph</span><span class="o">::</span><span class="n">Block</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x4bd42c</span><span class="p">))</span>
</span><span class='line'>    <span class="p">[</span><span class="o">+</span><span class="mh">0x000</span><span class="p">]</span> <span class="n">id_</span>              <span class="o">:</span> <span class="mh">0x53</span>
</span><span class='line'>    <span class="p">[</span><span class="o">+</span><span class="mh">0x004</span><span class="p">]</span> <span class="n">type_</span>            <span class="o">:</span> <span class="n">CODE_BLOCK</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'><span class="p">[...]</span>
</span><span class='line'>    <span class="p">[</span><span class="o">+</span><span class="mh">0x018</span><span class="p">]</span> <span class="n">name_</span>            <span class="o">:</span> <span class="mh">0x4ffd60</span> <span class="o">:</span> <span class="s">&quot;printf&quot;</span>
</span><span class='line'>    <span class="p">[</span><span class="o">+</span><span class="mh">0x01c</span><span class="p">]</span> <span class="n">compiland_name_</span>  <span class="o">:</span> <span class="mh">0x4c50b0</span> <span class="o">:</span> <span class="s">&quot;D:</span><span class="se">\t</span><span class="s">mp</span><span class="se">\t</span><span class="s">est\Debug\main.obj&quot;</span>
</span><span class='line'><span class="p">[...]</span>
</span><span class='line'>
</span><span class='line'><span class="n">Third</span> <span class="nl">reference:</span>
</span><span class='line'><span class="o">----------------</span>
</span><span class='line'>
</span><span class='line'><span class="mi">0</span><span class="o">:</span><span class="mo">000</span><span class="o">&gt;</span> <span class="n">dx</span> <span class="o">-</span><span class="n">r1</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">instrument</span><span class="o">!</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="kt">int</span> <span class="k">const</span> <span class="p">,</span><span class="n">block_graph</span><span class="o">::</span><span class="n">BlockGraph</span><span class="o">::</span><span class="n">Reference</span><span class="o">&gt;</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x4f5a90</span><span class="p">))</span>
</span><span class='line'>    <span class="n">first</span>            <span class="o">:</span> <span class="mi">83</span>
</span><span class='line'>    <span class="n">second</span>           <span class="p">[</span><span class="nl">Type:</span> <span class="n">block_graph</span><span class="o">::</span><span class="n">BlockGraph</span><span class="o">::</span><span class="n">Reference</span><span class="p">]</span>
</span><span class='line'><span class="mi">0</span><span class="o">:</span><span class="mo">000</span><span class="o">&gt;</span> <span class="n">dx</span> <span class="o">-</span><span class="n">r1</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">instrument</span><span class="o">!</span><span class="n">block_graph</span><span class="o">::</span><span class="n">BlockGraph</span><span class="o">::</span><span class="n">Reference</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x4f5a94</span><span class="p">))</span>
</span><span class='line'>    <span class="p">[</span><span class="o">+</span><span class="mh">0x000</span><span class="p">]</span> <span class="n">type_</span>            <span class="o">:</span> <span class="n">PC_RELATIVE_REF</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">[</span><span class="nl">Type:</span> <span class="n">block_graph</span><span class="o">::</span><span class="n">BlockGraph</span><span class="o">::</span><span class="n">ReferenceType</span><span class="p">]</span>
</span><span class='line'>    <span class="p">[</span><span class="o">+</span><span class="mh">0x004</span><span class="p">]</span> <span class="n">size_</span>            <span class="o">:</span> <span class="mh">0x4</span>
</span><span class='line'>    <span class="p">[</span><span class="o">+</span><span class="mh">0x008</span><span class="p">]</span> <span class="n">referenced_</span>      <span class="o">:</span> <span class="mh">0x4bd52c</span>
</span><span class='line'>    <span class="p">[</span><span class="o">+</span><span class="mh">0x00c</span><span class="p">]</span> <span class="n">offset_</span>          <span class="o">:</span> <span class="mi">0</span>
</span><span class='line'>    <span class="p">[</span><span class="o">+</span><span class="mh">0x010</span><span class="p">]</span> <span class="n">base_</span>            <span class="o">:</span> <span class="mi">0</span>
</span><span class='line'><span class="mi">0</span><span class="o">:</span><span class="mo">000</span><span class="o">&gt;</span> <span class="n">dx</span> <span class="o">-</span><span class="n">r1</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">instrument</span><span class="o">!</span><span class="n">block_graph</span><span class="o">::</span><span class="n">BlockGraph</span><span class="o">::</span><span class="n">Block</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x4bd52c</span><span class="p">))</span>
</span><span class='line'>    <span class="p">[</span><span class="o">+</span><span class="mh">0x000</span><span class="p">]</span> <span class="n">id_</span>              <span class="o">:</span> <span class="mh">0x54</span>
</span><span class='line'>    <span class="p">[</span><span class="o">+</span><span class="mh">0x004</span><span class="p">]</span> <span class="n">type_</span>            <span class="o">:</span> <span class="n">CODE_BLOCK</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'><span class="p">[...]</span>
</span><span class='line'>    <span class="p">[</span><span class="o">+</span><span class="mh">0x018</span><span class="p">]</span> <span class="n">name_</span>            <span class="o">:</span> <span class="mh">0xbb96c8</span> <span class="o">:</span> <span class="s">&quot;_RTC_CheckEsp&quot;</span>
</span><span class='line'>    <span class="p">[</span><span class="o">+</span><span class="mh">0x01c</span><span class="p">]</span> <span class="n">compiland_name_</span>  <span class="o">:</span> <span class="mh">0x4c5260</span> <span class="o">:</span> <span class="s">&quot;f:</span><span class="se">\b</span><span class="s">inaries\Intermediate</span><span class="se">\v</span><span class="s">ctools\msvcrt.nativeproj_607447030\objd</span><span class="se">\x86</span><span class="s">\_stack_.obj&quot;</span>
</span><span class='line'><span class="p">[...]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Perfect &ndash; that&rsquo;s what we sort of guessed! The last one is just the compiler adding <a href="https://msdn.microsoft.com/en-us/library/8wtf2dfz.aspx">Run-Time Error Checks</a> on us.</p>

<p>Let&rsquo;s have a closer look to the first reference. The <code>references_</code> member is a hash table of offsets and instances of reference.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="c1">// Map of references that this block makes to other blocks.</span>
</span><span class='line'><span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">Offset</span><span class="p">,</span> <span class="n">Reference</span><span class="o">&gt;</span> <span class="n">ReferenceMap</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The offset tells you where exactly in the <code>foo</code> block there is a reference; in our case we can see that the first reference is at offset 57 from the base of the block. If you start IDA real quick and browse at this address, you will see that it points one byte after the PUSH opcode (pointing exactly on the reference to the <code>_Format</code> string):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="p">.</span><span class="nl">text:</span><span class="mo">004010</span><span class="n">C8</span> <span class="mi">68</span> <span class="mi">20</span> <span class="mi">41</span> <span class="mi">40</span> <span class="mo">00</span> <span class="n">push</span>    <span class="n">offset</span> <span class="n">_Format</span>  <span class="p">;</span> <span class="s">&quot;Binary rewriting with syzygy</span><span class="se">\n</span><span class="s">&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Another interesting bit I didn&rsquo;t mention earlier is that naturally the <code>data_</code> field backs the actual content of the Block:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="mi">0</span><span class="o">:</span><span class="mo">000</span><span class="o">&gt;</span> <span class="n">u</span> <span class="err">@@</span><span class="n">c</span><span class="o">++</span><span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">data_</span><span class="p">)</span>
</span><span class='line'><span class="mo">004</span><span class="mi">9</span><span class="n">ef50</span> <span class="mi">55</span>              <span class="n">push</span>    <span class="n">ebp</span>
</span><span class='line'><span class="mo">004</span><span class="mi">9</span><span class="n">ef51</span> <span class="mi">8</span><span class="n">bec</span>            <span class="n">mov</span>     <span class="n">ebp</span><span class="p">,</span><span class="n">esp</span>
</span><span class='line'><span class="mo">004</span><span class="mi">9</span><span class="n">ef53</span> <span class="mi">81</span><span class="n">eccc000000</span>    <span class="n">sub</span>     <span class="n">esp</span><span class="p">,</span><span class="mi">0</span><span class="n">CCh</span>
</span><span class='line'><span class="mo">004</span><span class="mi">9</span><span class="n">ef59</span> <span class="mi">53</span>              <span class="n">push</span>    <span class="n">ebx</span>
</span><span class='line'><span class="mo">004</span><span class="mi">9</span><span class="n">ef5a</span> <span class="mi">56</span>              <span class="n">push</span>    <span class="n">esi</span>
</span><span class='line'><span class="mo">004</span><span class="mi">9</span><span class="n">ef5b</span> <span class="mi">57</span>              <span class="n">push</span>    <span class="n">edi</span>
</span><span class='line'><span class="mo">004</span><span class="mi">9</span><span class="n">ef5c</span> <span class="mi">8</span><span class="n">dbd34ffffff</span>    <span class="n">lea</span>     <span class="n">edi</span><span class="p">,[</span><span class="n">ebp</span><span class="o">-</span><span class="mi">0</span><span class="n">CCh</span><span class="p">]</span>
</span><span class='line'><span class="mo">004</span><span class="mi">9</span><span class="n">ef62</span> <span class="n">b933000000</span>      <span class="n">mov</span>     <span class="n">ecx</span><span class="p">,</span><span class="mi">33</span><span class="n">h</span>
</span></code></pre></td></tr></table></div></figure>


<p><img class="center" src="/images/binary_rewriting_with_syzygy/foo_disassview.png"></p>

<p>Last but not least, I mentioned SourceRanges (you can see it as a vector of pairs describing data ranges from the binary to the content in memory) before, so let&rsquo;s dump it to see what it looks like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="mi">0</span><span class="o">:</span><span class="mo">000</span><span class="o">&gt;</span> <span class="n">dx</span> <span class="o">-</span><span class="n">r1</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">instrument</span><span class="o">!</span><span class="n">core</span><span class="o">::</span><span class="n">AddressRangeMap</span><span class="o">&lt;</span><span class="n">core</span><span class="o">::</span><span class="n">AddressRange</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="o">&gt;</span><span class="p">,</span><span class="n">core</span><span class="o">::</span><span class="n">AddressRange</span><span class="o">&lt;</span><span class="n">core</span><span class="o">::</span><span class="n">detail</span><span class="o">::</span><span class="n">AddressImpl</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x4bd36c</span><span class="p">))</span>
</span><span class='line'>    <span class="p">[</span><span class="o">+</span><span class="mh">0x000</span><span class="p">]</span> <span class="n">range_pairs_</span>     <span class="o">:</span> <span class="p">{</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span> <span class="p">}</span>
</span><span class='line'><span class="mi">0</span><span class="o">:</span><span class="mo">000</span><span class="o">&gt;</span> <span class="n">dx</span> <span class="o">-</span><span class="n">r1</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">instrument</span><span class="o">!</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">core</span><span class="o">::</span><span class="n">AddressRange</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="o">&gt;</span><span class="p">,</span><span class="n">core</span><span class="o">::</span><span class="n">AddressRange</span><span class="o">&lt;</span><span class="n">core</span><span class="o">::</span><span class="n">detail</span><span class="o">::</span><span class="n">AddressImpl</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">allocator</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">core</span><span class="o">::</span><span class="n">AddressRange</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="o">&gt;</span><span class="p">,</span><span class="n">core</span><span class="o">::</span><span class="n">AddressRange</span><span class="o">&lt;</span><span class="n">core</span><span class="o">::</span><span class="n">detail</span><span class="o">::</span><span class="n">AddressImpl</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="o">&gt;</span> <span class="o">&gt;</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x4bd36c</span><span class="p">))</span>
</span><span class='line'>    <span class="p">[</span><span class="mi">0</span><span class="p">]</span>              <span class="o">:</span> <span class="p">{...},</span> <span class="p">{...}</span>
</span><span class='line'><span class="mi">0</span><span class="o">:</span><span class="mo">000</span><span class="o">&gt;</span> <span class="n">dx</span> <span class="o">-</span><span class="n">r1</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">instrument</span><span class="o">!</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">core</span><span class="o">::</span><span class="n">AddressRange</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="o">&gt;</span><span class="p">,</span><span class="n">core</span><span class="o">::</span><span class="n">AddressRange</span><span class="o">&lt;</span><span class="n">core</span><span class="o">::</span><span class="n">detail</span><span class="o">::</span><span class="n">AddressImpl</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x4da1c8</span><span class="p">))</span>
</span><span class='line'>    <span class="n">first</span>            <span class="p">[</span><span class="nl">Type:</span> <span class="n">core</span><span class="o">::</span><span class="n">AddressRange</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="o">&gt;</span><span class="p">]</span>
</span><span class='line'>    <span class="n">second</span>           <span class="p">[</span><span class="nl">Type:</span> <span class="n">core</span><span class="o">::</span><span class="n">AddressRange</span><span class="o">&lt;</span><span class="n">core</span><span class="o">::</span><span class="n">detail</span><span class="o">::</span><span class="n">AddressImpl</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="o">&gt;</span><span class="p">]</span>
</span><span class='line'><span class="mi">0</span><span class="o">:</span><span class="mo">000</span><span class="o">&gt;</span> <span class="n">dx</span> <span class="o">-</span><span class="n">r1</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">instrument</span><span class="o">!</span><span class="n">core</span><span class="o">::</span><span class="n">AddressRange</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="o">&gt;</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x4da1c8</span><span class="p">))</span>
</span><span class='line'>    <span class="p">[</span><span class="o">+</span><span class="mh">0x000</span><span class="p">]</span> <span class="n">start_</span>           <span class="o">:</span> <span class="mi">0</span>
</span><span class='line'>    <span class="p">[</span><span class="o">+</span><span class="mh">0x004</span><span class="p">]</span> <span class="n">size_</span>            <span class="o">:</span> <span class="mh">0x5b</span>
</span><span class='line'><span class="mi">0</span><span class="o">:</span><span class="mo">000</span><span class="o">&gt;</span> <span class="n">dx</span> <span class="o">-</span><span class="n">r1</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">instrument</span><span class="o">!</span><span class="n">core</span><span class="o">::</span><span class="n">AddressRange</span><span class="o">&lt;</span><span class="n">core</span><span class="o">::</span><span class="n">detail</span><span class="o">::</span><span class="n">AddressImpl</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="o">&gt;</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x4da1d0</span><span class="p">))</span>
</span><span class='line'>    <span class="p">[</span><span class="o">+</span><span class="mh">0x000</span><span class="p">]</span> <span class="n">start_</span>           <span class="p">[</span><span class="nl">Type:</span> <span class="n">core</span><span class="o">::</span><span class="n">detail</span><span class="o">::</span><span class="n">AddressImpl</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">]</span>
</span><span class='line'>    <span class="p">[</span><span class="o">+</span><span class="mh">0x004</span><span class="p">]</span> <span class="n">size_</span>            <span class="o">:</span> <span class="mh">0x5b</span>
</span><span class='line'><span class="mi">0</span><span class="o">:</span><span class="mo">000</span><span class="o">&gt;</span> <span class="n">dx</span> <span class="o">-</span><span class="n">r1</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">instrument</span><span class="o">!</span><span class="n">core</span><span class="o">::</span><span class="n">detail</span><span class="o">::</span><span class="n">AddressImpl</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x4da1d0</span><span class="p">))</span>
</span><span class='line'>    <span class="p">[</span><span class="o">+</span><span class="mh">0x000</span><span class="p">]</span> <span class="n">value_</span>           <span class="o">:</span> <span class="mh">0x1090</span> <span class="p">[</span><span class="nl">Type:</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>In this SourceRanges, we have a mapping from the <a href="https://github.com/google/syzygy/blob/master/syzygy/block_graph/block_graph.h#L568">DataRange</a> (RVA 0, size 0x5B), to the <a href="https://github.com/google/syzygy/blob/master/syzygy/block_graph/block_graph.h#L571">SourceRange</a> (RVA 0x1090, size 0x5B &ndash; which matches the previous IDA screen shot, obviously). We will come back to those once we have actually modified / rewritten the blocks to see what happens to the SourceRanges.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">enum</span> <span class="n">AddressType</span> <span class="o">:</span> <span class="n">uint8_t</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">kRelativeAddressType</span><span class="p">,</span>
</span><span class='line'>  <span class="n">kAbsoluteAddressType</span><span class="p">,</span>
</span><span class='line'>  <span class="n">kFileOffsetAddressType</span><span class="p">,</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// This class implements an address in a PE image file.</span>
</span><span class='line'><span class="c1">// Addresses are of three varieties:</span>
</span><span class='line'><span class="c1">// - Relative addresses are relative to the base of the image, and thus do not</span>
</span><span class='line'><span class="c1">//   change when the image is relocated. Bulk of the addresses in the PE image</span>
</span><span class='line'><span class="c1">//   format itself are of this variety, and that&#39;s where relative addresses</span>
</span><span class='line'><span class="c1">//   crop up most frequently.</span>
</span><span class='line'><span class="c1">// This class is a lightweight wrapper for an integer, which can be freely</span>
</span><span class='line'><span class="c1">// copied. The different address types are deliberately assignment</span>
</span><span class='line'><span class="c1">// incompatible, which helps to avoid confusion when handling different</span>
</span><span class='line'><span class="c1">// types of addresses in implementation.</span>
</span><span class='line'><span class="k">template</span> <span class="o">&lt;</span><span class="n">AddressType</span> <span class="n">kType</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">class</span> <span class="nc">AddressImpl</span> <span class="p">{};</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// A virtual address relative to the image base, often termed RVA in</span>
</span><span class='line'><span class="c1">// documentation and in data structure comments.</span>
</span><span class='line'><span class="k">using</span> <span class="n">RelativeAddress</span> <span class="o">=</span> <span class="n">detail</span><span class="o">::</span><span class="n">AddressImpl</span><span class="o">&lt;</span><span class="n">kRelativeAddressType</span><span class="o">&gt;</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now that you have been introduced to the main concepts, it is time for me to walk you through two small applications.</p>

<h2>CallGraphAnalysis</h2>

<h3>The plan</h3>

<p>As the framework exposes all the information you need to rewrite and analyze binary, you are also free to <em>just</em> analyze a binary and not modify a single bit. In this example let&rsquo;s make a Block transform and generate a graph of the relationship between code Blocks (functions). As we are interested in exploring the whole binary and every single code Block, we subclass <code>IterativeTransformImpl</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="c1">// Declares a BlockGraphTransform implementation wrapping the common transform</span>
</span><span class='line'><span class="c1">// that iterates over each block in the image.</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">// An implementation of a BlockGraph transform encapsulating the simple pattern</span>
</span><span class='line'><span class="c1">// of Pre, per-block, and Post functions. The derived class is responsible for</span>
</span><span class='line'><span class="c1">// implementing &#39;OnBlock&#39; and &#39;name&#39;, and may optionally override Pre and</span>
</span><span class='line'><span class="c1">// Post. The derived type needs to also define the static public member</span>
</span><span class='line'><span class="c1">// variable:</span>
</span><span class='line'><span class="c1">//</span>
</span><span class='line'><span class="c1">//   static const char DerivedType::kTransformName[];</span>
</span><span class='line'><span class="c1">//</span>
</span><span class='line'><span class="c1">// @tparam DerivedType the type of the derived class.</span>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">DerivedType</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">class</span> <span class="nc">IterativeTransformImpl</span>
</span><span class='line'>    <span class="o">:</span> <span class="k">public</span> <span class="n">NamedBlockGraphTransformImpl</span><span class="o">&lt;</span><span class="n">DerivedType</span><span class="o">&gt;</span> <span class="p">{</span> <span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Doing so allows us define <code>Pre</code> / <code>Post</code> functions, and an <code>OnBlock</code> function that gets called for every Block encountered in the image. This is pretty handy as I can define an <code>OnBlock</code> callback to mine the information we want for every Block, and define <code>Post</code> to process the data I have accumulated if necessary.</p>

<p>The <code>OnBlock</code> function should be pretty light as we only want to achieve a couple of things:</p>

<ol>
<li> Make sure we are dealing with a code Block (and not data),</li>
<li> Walk every referrers and store pairs of [<code>ReferrerBlock</code>, <code>CurrentBlock</code>] in a container.</li>
</ol>


<h3>Implementation</h3>

<p>The first thing to do is to create a C++ class named <code>CallGraphAnalysis</code>, declared in <code>doare_transform.h</code> and defined in <code>doare_transform.cc</code>. Those files are put in the <code>syzygy/instrument/transforms</code> directory where all others transforms live in:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="nl">D:</span><span class="err">\</span><span class="n">syzygy</span><span class="err">\</span><span class="n">src</span><span class="o">&gt;</span><span class="n">git</span> <span class="n">status</span>
</span><span class='line'><span class="n">On</span> <span class="n">branch</span> <span class="n">dev</span><span class="o">-</span><span class="n">doare1</span>
</span><span class='line'><span class="n">Changes</span> <span class="n">to</span> <span class="n">be</span> <span class="nl">committed:</span>
</span><span class='line'>  <span class="p">(</span><span class="n">use</span> <span class="s">&quot;git reset HEAD &lt;file&gt;...&quot;</span> <span class="n">to</span> <span class="n">unstage</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">new</span> <span class="nl">file:</span>   <span class="n">syzygy</span><span class="o">/</span><span class="n">instrument</span><span class="o">/</span><span class="n">transforms</span><span class="o">/</span><span class="n">doare_transforms</span><span class="p">.</span><span class="n">cc</span>
</span><span class='line'>        <span class="k">new</span> <span class="nl">file:</span>   <span class="n">syzygy</span><span class="o">/</span><span class="n">instrument</span><span class="o">/</span><span class="n">transforms</span><span class="o">/</span><span class="n">doare_transforms</span><span class="p">.</span><span class="n">h</span>
</span></code></pre></td></tr></table></div></figure>


<p>In order to get it compiled we also need to modify the <code>instrument.gyp</code> project file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="nl">D:</span><span class="err">\</span><span class="n">syzygy</span><span class="err">\</span><span class="n">src</span><span class="o">&gt;</span><span class="n">git</span> <span class="n">diff</span> <span class="n">syzygy</span><span class="o">/</span><span class="n">instrument</span><span class="o">/</span><span class="n">instrument</span><span class="p">.</span><span class="n">gyp</span>
</span><span class='line'><span class="n">diff</span> <span class="o">--</span><span class="n">git</span> <span class="n">a</span><span class="o">/</span><span class="n">syzygy</span><span class="o">/</span><span class="n">instrument</span><span class="o">/</span><span class="n">instrument</span><span class="p">.</span><span class="n">gyp</span> <span class="n">b</span><span class="o">/</span><span class="n">syzygy</span><span class="o">/</span><span class="n">instrument</span><span class="o">/</span><span class="n">instrument</span><span class="p">.</span><span class="n">gyp</span>
</span><span class='line'><span class="n">index</span> <span class="mi">464</span><span class="n">c5566</span><span class="p">..</span><span class="n">c0eceb87</span> <span class="mi">100644</span>
</span><span class='line'><span class="o">---</span> <span class="n">a</span><span class="o">/</span><span class="n">syzygy</span><span class="o">/</span><span class="n">instrument</span><span class="o">/</span><span class="n">instrument</span><span class="p">.</span><span class="n">gyp</span>
</span><span class='line'><span class="o">+++</span> <span class="n">b</span><span class="o">/</span><span class="n">syzygy</span><span class="o">/</span><span class="n">instrument</span><span class="o">/</span><span class="n">instrument</span><span class="p">.</span><span class="n">gyp</span>
</span><span class='line'><span class="err">@@</span> <span class="o">-</span><span class="mi">68</span><span class="p">,</span><span class="mi">6</span> <span class="o">+</span><span class="mi">70</span><span class="p">,</span><span class="mi">8</span> <span class="err">@@</span>
</span><span class='line'>         <span class="err">&#39;</span><span class="n">transforms</span><span class="o">/</span><span class="n">branch_hook_transform</span><span class="p">.</span><span class="n">h</span><span class="err">&#39;</span><span class="p">,</span>
</span><span class='line'>         <span class="err">&#39;</span><span class="n">transforms</span><span class="o">/</span><span class="n">coverage_transform</span><span class="p">.</span><span class="n">cc</span><span class="err">&#39;</span><span class="p">,</span>
</span><span class='line'>         <span class="err">&#39;</span><span class="n">transforms</span><span class="o">/</span><span class="n">coverage_transform</span><span class="p">.</span><span class="n">h</span><span class="err">&#39;</span><span class="p">,</span>
</span><span class='line'><span class="o">+</span>        <span class="err">&#39;</span><span class="n">transforms</span><span class="o">/</span><span class="n">doare_transforms</span><span class="p">.</span><span class="n">cc</span><span class="err">&#39;</span><span class="p">,</span>
</span><span class='line'><span class="o">+</span>        <span class="err">&#39;</span><span class="n">transforms</span><span class="o">/</span><span class="n">doare_transforms</span><span class="p">.</span><span class="n">h</span><span class="err">&#39;</span><span class="p">,</span>
</span><span class='line'>         <span class="err">&#39;</span><span class="n">transforms</span><span class="o">/</span><span class="n">entry_call_transform</span><span class="p">.</span><span class="n">cc</span><span class="err">&#39;</span><span class="p">,</span>
</span><span class='line'>         <span class="err">&#39;</span><span class="n">transforms</span><span class="o">/</span><span class="n">entry_call_transform</span><span class="p">.</span><span class="n">h</span><span class="err">&#39;</span><span class="p">,</span>
</span><span class='line'>         <span class="err">&#39;</span><span class="n">transforms</span><span class="o">/</span><span class="n">entry_thunk_transform</span><span class="p">.</span><span class="n">cc</span><span class="err">&#39;</span><span class="p">,</span>
</span></code></pre></td></tr></table></div></figure>


<p>The gyp file is basically used to generate Ninja project files &ndash; which means that if you don&rsquo;t regenerate the Ninja files from the updated version of this gyp file, you will not be compiling your new code. In order to force a regeneration, you can invoke the <code>depot_tools</code> command: <code>gclient runhooks</code>.</p>

<p>At this point we are ready to get our class coded up; here is the class declaration I have:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="c1">// Axel &#39;0vercl0k&#39; Souchet - 26 Aug 2017</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifndef SYZYGY_INSTRUMENT_TRANSFORMS_DOARE_TRANSFORMS_H_</span>
</span><span class='line'><span class="cp">#define SYZYGY_INSTRUMENT_TRANSFORMS_DOARE_TRANSFORMS_H_</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#include &quot;base/logging.h&quot;</span>
</span><span class='line'><span class="cp">#include &quot;syzygy/block_graph/transform_policy.h&quot;</span>
</span><span class='line'><span class="cp">#include &quot;syzygy/block_graph/transforms/iterative_transform.h&quot;</span>
</span><span class='line'><span class="cp">#include &quot;syzygy/block_graph/transforms/named_transform.h&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">namespace</span> <span class="n">instrument</span> <span class="p">{</span>
</span><span class='line'><span class="k">namespace</span> <span class="n">transforms</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'><span class="k">typedef</span> <span class="n">block_graph</span><span class="o">::</span><span class="n">BlockGraph</span> <span class="n">BlockGraph</span><span class="p">;</span>
</span><span class='line'><span class="k">typedef</span> <span class="n">block_graph</span><span class="o">::</span><span class="n">BlockGraph</span><span class="o">::</span><span class="n">Block</span> <span class="n">Block</span><span class="p">;</span>
</span><span class='line'><span class="k">typedef</span> <span class="n">block_graph</span><span class="o">::</span><span class="n">TransformPolicyInterface</span> <span class="n">TransformPolicyInterface</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">CallGraphAnalysis</span>
</span><span class='line'>    <span class="o">:</span> <span class="k">public</span> <span class="n">block_graph</span><span class="o">::</span><span class="n">transforms</span><span class="o">::</span><span class="n">IterativeTransformImpl</span><span class="o">&lt;</span>
</span><span class='line'>          <span class="n">CallGraphAnalysis</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'> <span class="k">public</span><span class="o">:</span>
</span><span class='line'>  <span class="n">CallGraphAnalysis</span><span class="p">()</span>
</span><span class='line'>      <span class="o">:</span> <span class="n">edges_</span><span class="p">(),</span>
</span><span class='line'>        <span class="n">main_block_</span><span class="p">(</span><span class="n">nullptr</span><span class="p">),</span>
</span><span class='line'>        <span class="n">total_blocks_</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span><span class='line'>        <span class="n">total_code_blocks_</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">kTransformName</span><span class="p">[];</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Functions needed for IterativeTransform.</span>
</span><span class='line'>  <span class="kt">bool</span> <span class="n">OnBlock</span><span class="p">(</span><span class="k">const</span> <span class="n">TransformPolicyInterface</span><span class="o">*</span> <span class="n">policy</span><span class="p">,</span>
</span><span class='line'>               <span class="n">BlockGraph</span><span class="o">*</span> <span class="n">block_graph</span><span class="p">,</span>
</span><span class='line'>               <span class="n">Block</span><span class="o">*</span> <span class="n">block</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'> <span class="k">private</span><span class="o">:</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">list</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">Block</span><span class="o">*</span><span class="p">,</span> <span class="n">Block</span><span class="o">*&gt;&gt;</span> <span class="n">edges_</span><span class="p">;</span>
</span><span class='line'>  <span class="n">Block</span><span class="o">*</span> <span class="n">main_block_</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Stats.</span>
</span><span class='line'>  <span class="n">size_t</span> <span class="n">total_blocks_</span><span class="p">;</span>
</span><span class='line'>  <span class="n">size_t</span> <span class="n">total_code_blocks_</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>  <span class="c1">// namespace transforms</span>
</span><span class='line'><span class="p">}</span>  <span class="c1">// namespace instrument</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#endif  </span><span class="c1">// SYZYGY_INSTRUMENT_TRANSFORMS_DOARE_TRANSFORMS_H_</span>
</span></code></pre></td></tr></table></div></figure>


<p>After declaring it, the interesting part for us is to have a look at the <code>OnBlock</code> method:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="kt">bool</span> <span class="n">CallGraphAnalysis</span><span class="o">::</span><span class="n">OnBlock</span><span class="p">(</span><span class="k">const</span> <span class="n">TransformPolicyInterface</span><span class="o">*</span> <span class="n">policy</span><span class="p">,</span>
</span><span class='line'>                                <span class="n">BlockGraph</span><span class="o">*</span> <span class="n">block_graph</span><span class="p">,</span>
</span><span class='line'>                                <span class="n">Block</span><span class="o">*</span> <span class="n">block</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">total_blocks_</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">()</span> <span class="o">!=</span> <span class="n">BlockGraph</span><span class="o">::</span><span class="n">CODE_BLOCK</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">attributes</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">BlockGraph</span><span class="o">::</span><span class="n">GAP_BLOCK</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">VLOG</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">__FUNCTION__</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">block</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">();</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;main&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">main_block_</span> <span class="o">=</span> <span class="n">block</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Walk the referrers of this block.</span>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">referrer</span> <span class="o">:</span> <span class="n">block</span><span class="o">-&gt;</span><span class="n">referrers</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">Block</span><span class="o">*</span> <span class="n">referrer_block</span><span class="p">(</span><span class="n">referrer</span><span class="p">.</span><span class="n">first</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// We are not interested in non-code referrers.</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">referrer_block</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">()</span> <span class="o">!=</span> <span class="n">BlockGraph</span><span class="o">::</span><span class="n">CODE_BLOCK</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">continue</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">VLOG</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">referrer_block</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; -&gt; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">block</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Keep track of the relation between the block &amp; its referrer.</span>
</span><span class='line'>    <span class="n">edges_</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">referrer_block</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">total_code_blocks_</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>  <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The first step of the method is to make sure that the Block we are dealing with is a block we want to analyze. As I have explained before, Blocks are not exclusive code Blocks. That is the reason why we check the type of the block to only accepts code Blocks. Another type of Block that syzygy artificially creates (it has no existence in the image being analyzed) is called a <code>GAP_BLOCK</code>; which is basically a block that fills a gap in the address space. For that reason we also skip those blocks.</p>

<p>At this point we have a code Block and we can start to mine whatever information needed: name, size, referrers, etc. As the thing we are mostly interested about is the relationships between the code Blocks, we have to walk the referrers. The only thing to be wary about is to also exclude data Blocks (a function pointer table would be a data Block referencing a code Block for example) there. After this minor filtering we can just add the two pointers into the container.</p>

<p>I am sure at this stage you are interested in compiling it, and get it to run on a binary. To do that we need to add the <em>plumbing</em> necessary to surface it to <code>instrument.exe</code> tool. First thing you need is an <code>instrumenter</code>, we declare it in <code>doare_instrumenter.h</code> and define it in <code>doare_instrumenter.cc</code> in the <code>syzygy/instrument/instrumenters</code> directory:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="nl">D:</span><span class="err">\</span><span class="n">syzygy</span><span class="err">\</span><span class="n">src</span><span class="o">&gt;</span><span class="n">git</span> <span class="n">status</span>
</span><span class='line'><span class="n">On</span> <span class="n">branch</span> <span class="n">dev</span><span class="o">-</span><span class="n">doare1</span>
</span><span class='line'><span class="n">Changes</span> <span class="n">to</span> <span class="n">be</span> <span class="nl">committed:</span>
</span><span class='line'>  <span class="p">(</span><span class="n">use</span> <span class="s">&quot;git reset HEAD &lt;file&gt;...&quot;</span> <span class="n">to</span> <span class="n">unstage</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">new</span> <span class="nl">file:</span>   <span class="n">syzygy</span><span class="o">/</span><span class="n">instrument</span><span class="o">/</span><span class="n">instrumenters</span><span class="o">/</span><span class="n">doare_instrumenter</span><span class="p">.</span><span class="n">cc</span>
</span><span class='line'>        <span class="k">new</span> <span class="nl">file:</span>   <span class="n">syzygy</span><span class="o">/</span><span class="n">instrument</span><span class="o">/</span><span class="n">instrumenters</span><span class="o">/</span><span class="n">doare_instrumenter</span><span class="p">.</span><span class="n">h</span>
</span></code></pre></td></tr></table></div></figure>


<p>An instrumenter is basically a class that encapsulate the configuration and the invocation of one or several transforms. The instrumenter can receive options passed by the application, thus can set configuration flags when invoking the transforms, etc. You could imagine parsing a configuration file here, or doing any preparation needed by your transform. Then, the instrumenter registers the transform against the <code>Relinker</code> object (a bit like the pass manager in LLVM if you want to think about it this way).</p>

<p>Anyway, as our transform is trivial we basically don&rsquo;t need any of this &ldquo;preparation&rdquo;; so let&rsquo;s settle for the least required:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="c1">// Axel &#39;0vercl0k&#39; Souchet - 26 Aug 2017</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifndef SYZYGY_INSTRUMENT_INSTRUMENTERS_DOARE_INSTRUMENTER_H_</span>
</span><span class='line'><span class="cp">#define SYZYGY_INSTRUMENT_INSTRUMENTERS_DOARE_INSTRUMENTER_H_</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#include &quot;base/command_line.h&quot;</span>
</span><span class='line'><span class="cp">#include &quot;syzygy/instrument/instrumenters/instrumenter_with_agent.h&quot;</span>
</span><span class='line'><span class="cp">#include &quot;syzygy/instrument/transforms/doare_transforms.h&quot;</span>
</span><span class='line'><span class="cp">#include &quot;syzygy/pe/pe_relinker.h&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">namespace</span> <span class="n">instrument</span> <span class="p">{</span>
</span><span class='line'><span class="k">namespace</span> <span class="n">instrumenters</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">DoareInstrumenter</span> <span class="o">:</span> <span class="k">public</span> <span class="n">InstrumenterWithRelinker</span> <span class="p">{</span>
</span><span class='line'> <span class="k">public</span><span class="o">:</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">InstrumenterWithRelinker</span> <span class="n">Super</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">DoareInstrumenter</span><span class="p">()</span> <span class="o">:</span> <span class="n">Super</span><span class="p">()</span> <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// From InstrumenterWithRelinker</span>
</span><span class='line'>  <span class="kt">bool</span> <span class="n">InstrumentPrepare</span><span class="p">()</span> <span class="n">override</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">bool</span> <span class="n">InstrumentImpl</span><span class="p">()</span> <span class="n">override</span><span class="p">;</span>
</span><span class='line'>  <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">InstrumentationMode</span><span class="p">()</span> <span class="n">override</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'> <span class="k">private</span><span class="o">:</span>
</span><span class='line'>  <span class="c1">// The transform for this agent.</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">instrument</span><span class="o">::</span><span class="n">transforms</span><span class="o">::</span><span class="n">CallGraphAnalysis</span><span class="o">&gt;</span>
</span><span class='line'>      <span class="n">transformer_callgraph_</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">DISALLOW_COPY_AND_ASSIGN</span><span class="p">(</span><span class="n">DoareInstrumenter</span><span class="p">);</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>  <span class="c1">// namespace instrumenters</span>
</span><span class='line'><span class="p">}</span>  <span class="c1">// namespace instrument</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#endif  </span><span class="c1">// SYZYGY_INSTRUMENT_INSTRUMENTERS_DOARE_INSTRUMENTER_H_</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>InstrumentPrepare</code> method is where the instrumenter registers the transform against the relinker object:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="c1">// Axel &#39;0vercl0k&#39; Souchet - 26 Aug 2017</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#include &quot;syzygy/instrument/instrumenters/doare_instrumenter.h&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#include &quot;base/logging.h&quot;</span>
</span><span class='line'><span class="cp">#include &quot;base/values.h&quot;</span>
</span><span class='line'><span class="cp">#include &quot;syzygy/application/application.h&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">namespace</span> <span class="n">instrument</span> <span class="p">{</span>
</span><span class='line'><span class="k">namespace</span> <span class="n">instrumenters</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'><span class="kt">bool</span> <span class="n">DoareInstrumenter</span><span class="o">::</span><span class="n">InstrumentPrepare</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">bool</span> <span class="n">DoareInstrumenter</span><span class="o">::</span><span class="n">InstrumentImpl</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">transformer_callgraph_</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">new</span> <span class="n">instrument</span><span class="o">::</span><span class="n">transforms</span><span class="o">::</span><span class="n">CallGraphAnalysis</span><span class="p">());</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">relinker_</span><span class="o">-&gt;</span><span class="n">AppendTransform</span><span class="p">(</span><span class="n">transformer_callgraph_</span><span class="p">.</span><span class="n">get</span><span class="p">()))</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;AppendTransform failed.&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">DoareInstrumenter</span><span class="o">::</span><span class="n">InstrumentationMode</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="s">&quot;Diary of a reverse engineer&quot;</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="p">}</span>  <span class="c1">// namespace instrumenters</span>
</span><span class='line'><span class="p">}</span>  <span class="c1">// namespace instrument</span>
</span></code></pre></td></tr></table></div></figure>


<p>Like before, we also need to add those two files in the <code>instrument.gyp</code> file and regenerate the Ninja project files via the <code>gclient runhooks</code> command:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="nl">D:</span><span class="err">\</span><span class="n">syzygy</span><span class="err">\</span><span class="n">src</span><span class="o">&gt;</span><span class="n">git</span> <span class="n">diff</span> <span class="n">syzygy</span><span class="o">/</span><span class="n">instrument</span><span class="o">/</span><span class="n">instrument</span><span class="p">.</span><span class="n">gyp</span>
</span><span class='line'><span class="n">diff</span> <span class="o">--</span><span class="n">git</span> <span class="n">a</span><span class="o">/</span><span class="n">syzygy</span><span class="o">/</span><span class="n">instrument</span><span class="o">/</span><span class="n">instrument</span><span class="p">.</span><span class="n">gyp</span> <span class="n">b</span><span class="o">/</span><span class="n">syzygy</span><span class="o">/</span><span class="n">instrument</span><span class="o">/</span><span class="n">instrument</span><span class="p">.</span><span class="n">gyp</span>
</span><span class='line'><span class="n">index</span> <span class="mi">464</span><span class="n">c5566</span><span class="p">..</span><span class="n">c0eceb87</span> <span class="mi">100644</span>
</span><span class='line'><span class="o">---</span> <span class="n">a</span><span class="o">/</span><span class="n">syzygy</span><span class="o">/</span><span class="n">instrument</span><span class="o">/</span><span class="n">instrument</span><span class="p">.</span><span class="n">gyp</span>
</span><span class='line'><span class="o">+++</span> <span class="n">b</span><span class="o">/</span><span class="n">syzygy</span><span class="o">/</span><span class="n">instrument</span><span class="o">/</span><span class="n">instrument</span><span class="p">.</span><span class="n">gyp</span>
</span><span class='line'><span class="err">@@</span> <span class="o">-</span><span class="mi">36</span><span class="p">,</span><span class="mi">6</span> <span class="o">+</span><span class="mi">36</span><span class="p">,</span><span class="mi">8</span> <span class="err">@@</span>
</span><span class='line'>         <span class="err">&#39;</span><span class="n">instrumenters</span><span class="o">/</span><span class="n">bbentry_instrumenter</span><span class="p">.</span><span class="n">h</span><span class="err">&#39;</span><span class="p">,</span>
</span><span class='line'>         <span class="err">&#39;</span><span class="n">instrumenters</span><span class="o">/</span><span class="n">coverage_instrumenter</span><span class="p">.</span><span class="n">cc</span><span class="err">&#39;</span><span class="p">,</span>
</span><span class='line'>         <span class="err">&#39;</span><span class="n">instrumenters</span><span class="o">/</span><span class="n">coverage_instrumenter</span><span class="p">.</span><span class="n">h</span><span class="err">&#39;</span><span class="p">,</span>
</span><span class='line'><span class="o">+</span>        <span class="err">&#39;</span><span class="n">instrumenters</span><span class="o">/</span><span class="n">doare_instrumenter</span><span class="p">.</span><span class="n">h</span><span class="err">&#39;</span><span class="p">,</span>
</span><span class='line'><span class="o">+</span>        <span class="err">&#39;</span><span class="n">instrumenters</span><span class="o">/</span><span class="n">doare_instrumenter</span><span class="p">.</span><span class="n">cc</span><span class="err">&#39;</span><span class="p">,</span>
</span><span class='line'>         <span class="err">&#39;</span><span class="n">instrumenters</span><span class="o">/</span><span class="n">entry_call_instrumenter</span><span class="p">.</span><span class="n">cc</span><span class="err">&#39;</span><span class="p">,</span>
</span><span class='line'>         <span class="err">&#39;</span><span class="n">instrumenters</span><span class="o">/</span><span class="n">entry_call_instrumenter</span><span class="p">.</span><span class="n">h</span><span class="err">&#39;</span><span class="p">,</span>
</span><span class='line'>         <span class="err">&#39;</span><span class="n">instrumenters</span><span class="o">/</span><span class="n">entry_thunk_instrumenter</span><span class="p">.</span><span class="n">cc</span><span class="err">&#39;</span><span class="p">,</span>
</span><span class='line'><span class="err">@@</span> <span class="o">-</span><span class="mi">68</span><span class="p">,</span><span class="mi">6</span> <span class="o">+</span><span class="mi">70</span><span class="p">,</span><span class="mi">8</span> <span class="err">@@</span>
</span><span class='line'>         <span class="err">&#39;</span><span class="n">transforms</span><span class="o">/</span><span class="n">branch_hook_transform</span><span class="p">.</span><span class="n">h</span><span class="err">&#39;</span><span class="p">,</span>
</span><span class='line'>         <span class="err">&#39;</span><span class="n">transforms</span><span class="o">/</span><span class="n">coverage_transform</span><span class="p">.</span><span class="n">cc</span><span class="err">&#39;</span><span class="p">,</span>
</span><span class='line'>         <span class="err">&#39;</span><span class="n">transforms</span><span class="o">/</span><span class="n">coverage_transform</span><span class="p">.</span><span class="n">h</span><span class="err">&#39;</span><span class="p">,</span>
</span><span class='line'><span class="o">+</span>        <span class="err">&#39;</span><span class="n">transforms</span><span class="o">/</span><span class="n">doare_transforms</span><span class="p">.</span><span class="n">cc</span><span class="err">&#39;</span><span class="p">,</span>
</span><span class='line'><span class="o">+</span>        <span class="err">&#39;</span><span class="n">transforms</span><span class="o">/</span><span class="n">doare_transforms</span><span class="p">.</span><span class="n">h</span><span class="err">&#39;</span><span class="p">,</span>
</span><span class='line'>         <span class="err">&#39;</span><span class="n">transforms</span><span class="o">/</span><span class="n">entry_call_transform</span><span class="p">.</span><span class="n">cc</span><span class="err">&#39;</span><span class="p">,</span>
</span><span class='line'>         <span class="err">&#39;</span><span class="n">transforms</span><span class="o">/</span><span class="n">entry_call_transform</span><span class="p">.</span><span class="n">h</span><span class="err">&#39;</span><span class="p">,</span>
</span><span class='line'>         <span class="err">&#39;</span><span class="n">transforms</span><span class="o">/</span><span class="n">entry_thunk_transform</span><span class="p">.</span><span class="n">cc</span><span class="err">&#39;</span><span class="p">,</span>
</span></code></pre></td></tr></table></div></figure>


<p>The last step for us is to surface our instrumenter to the main of the application. I just add a mode called <code>doare</code> that you can set via the <code>--mode</code> switch, and if the flag is specified it instantiates the newly born <code>DoareInstrumenter</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="nl">D:</span><span class="err">\</span><span class="n">syzygy</span><span class="err">\</span><span class="n">src</span><span class="o">&gt;</span><span class="n">git</span> <span class="n">diff</span> <span class="n">syzygy</span><span class="o">/</span><span class="n">instrument</span><span class="o">/</span><span class="n">instrument_app</span><span class="p">.</span><span class="n">cc</span>
</span><span class='line'><span class="n">diff</span> <span class="o">--</span><span class="n">git</span> <span class="n">a</span><span class="o">/</span><span class="n">syzygy</span><span class="o">/</span><span class="n">instrument</span><span class="o">/</span><span class="n">instrument_app</span><span class="p">.</span><span class="n">cc</span> <span class="n">b</span><span class="o">/</span><span class="n">syzygy</span><span class="o">/</span><span class="n">instrument</span><span class="o">/</span><span class="n">instrument_app</span><span class="p">.</span><span class="n">cc</span>
</span><span class='line'><span class="n">index</span> <span class="mi">72</span><span class="n">bb40b8</span><span class="p">..</span><span class="n">c54258d8</span> <span class="mi">100644</span>
</span><span class='line'><span class="o">---</span> <span class="n">a</span><span class="o">/</span><span class="n">syzygy</span><span class="o">/</span><span class="n">instrument</span><span class="o">/</span><span class="n">instrument_app</span><span class="p">.</span><span class="n">cc</span>
</span><span class='line'><span class="o">+++</span> <span class="n">b</span><span class="o">/</span><span class="n">syzygy</span><span class="o">/</span><span class="n">instrument</span><span class="o">/</span><span class="n">instrument_app</span><span class="p">.</span><span class="n">cc</span>
</span><span class='line'><span class="err">@@</span> <span class="o">-</span><span class="mi">29</span><span class="p">,</span><span class="mi">6</span> <span class="o">+</span><span class="mi">29</span><span class="p">,</span><span class="mi">7</span> <span class="err">@@</span>
</span><span class='line'> <span class="err">#</span><span class="n">include</span> <span class="s">&quot;syzygy/instrument/instrumenters/bbentry_instrumenter.h&quot;</span>
</span><span class='line'> <span class="err">#</span><span class="n">include</span> <span class="s">&quot;syzygy/instrument/instrumenters/branch_instrumenter.h&quot;</span>
</span><span class='line'> <span class="err">#</span><span class="n">include</span> <span class="s">&quot;syzygy/instrument/instrumenters/coverage_instrumenter.h&quot;</span>
</span><span class='line'><span class="o">+</span><span class="err">#</span><span class="n">include</span> <span class="s">&quot;syzygy/instrument/instrumenters/doare_instrumenter.h&quot;</span>
</span><span class='line'> <span class="err">#</span><span class="n">include</span> <span class="s">&quot;syzygy/instrument/instrumenters/entry_call_instrumenter.h&quot;</span>
</span><span class='line'> <span class="err">#</span><span class="n">include</span> <span class="s">&quot;syzygy/instrument/instrumenters/entry_thunk_instrumenter.h&quot;</span>
</span><span class='line'> <span class="err">#</span><span class="n">include</span> <span class="s">&quot;syzygy/instrument/instrumenters/flummox_instrumenter.h&quot;</span>
</span><span class='line'><span class="err">@@</span> <span class="o">-</span><span class="mi">41</span><span class="p">,</span><span class="mi">7</span> <span class="o">+</span><span class="mi">42</span><span class="p">,</span><span class="mi">7</span> <span class="err">@@</span> <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">kUsageFormatStr</span><span class="p">[]</span> <span class="o">=</span>
</span><span class='line'>     <span class="s">&quot;Usage: %ls [options]</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>     <span class="s">&quot;  Required arguments:</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>     <span class="s">&quot;    --input-image=&lt;path&gt; The input image to instrument.</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'><span class="o">-</span>    <span class="s">&quot;    --mode=afl|asan|bbentry|branch|calltrace|coverage|flummox|profile</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'><span class="o">+</span>    <span class="s">&quot;    --mode=afl|asan|bbentry|branch|calltrace|coverage|doare|flummox|profile</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>     <span class="s">&quot;                            Specifies which instrumentation mode is to</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>     <span class="s">&quot;                            be used. If this is not specified it is</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>     <span class="s">&quot;                            equivalent to specifying --mode=calltrace</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'><span class="err">@@</span> <span class="o">-</span><span class="mi">192</span><span class="p">,</span><span class="mi">6</span> <span class="o">+</span><span class="mi">193</span><span class="p">,</span><span class="mi">8</span> <span class="err">@@</span> <span class="kt">bool</span> <span class="n">InstrumentApp</span><span class="o">::</span><span class="n">ParseCommandLine</span><span class="p">(</span><span class="k">const</span> <span class="n">base</span><span class="o">::</span><span class="n">CommandLine</span><span class="o">*</span> <span class="n">cmd_line</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>           <span class="n">instrumenters</span><span class="o">::</span><span class="n">EntryThunkInstrumenter</span><span class="o">::</span><span class="n">CALL_TRACE</span><span class="p">));</span>
</span><span class='line'>     <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">LowerCaseEqualsASCII</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="s">&quot;coverage&quot;</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>       <span class="n">instrumenter_</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">new</span> <span class="n">instrumenters</span><span class="o">::</span><span class="n">CoverageInstrumenter</span><span class="p">());</span>
</span><span class='line'><span class="o">+</span>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">LowerCaseEqualsASCII</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="s">&quot;doare&quot;</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'><span class="o">+</span>      <span class="n">instrumenter_</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">new</span> <span class="n">instrumenters</span><span class="o">::</span><span class="n">DoareInstrumenter</span><span class="p">());</span>
</span><span class='line'>     <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">LowerCaseEqualsASCII</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="s">&quot;flummox&quot;</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>       <span class="n">instrumenter_</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">new</span> <span class="n">instrumenters</span><span class="o">::</span><span class="n">FlummoxInstrumenter</span><span class="p">());</span>
</span><span class='line'>     <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">LowerCaseEqualsASCII</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="s">&quot;profile&quot;</span><span class="p">))</span> <span class="p">{</span>
</span></code></pre></td></tr></table></div></figure>


<p>This should be it! Recompiling the <code>instrument</code> project should be enough to be able to invoke the transform and see some of our debug messages:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="nl">D:</span><span class="err">\</span><span class="n">Downloads</span><span class="err">\</span><span class="n">syzygy</span><span class="err">\</span><span class="n">src</span><span class="o">&gt;</span><span class="n">ninja</span> <span class="o">-</span><span class="n">C</span> <span class="n">out</span><span class="err">\</span><span class="n">Release</span> <span class="n">instrument</span>
</span><span class='line'><span class="nl">ninja:</span> <span class="n">Entering</span> <span class="n">directory</span> <span class="err">`</span><span class="n">out</span><span class="err">\</span><span class="n">Release</span><span class="err">&#39;</span>
</span><span class='line'><span class="p">[</span><span class="mi">4</span><span class="o">/</span><span class="mi">4</span><span class="p">]</span> <span class="n">LINK_EMBED</span> <span class="n">instrument</span><span class="p">.</span><span class="n">exe</span>
</span><span class='line'><span class="nl">D:</span><span class="err">\</span><span class="n">Downloads</span><span class="err">\</span><span class="n">syzygy</span><span class="err">\</span><span class="n">src</span><span class="o">&gt;</span><span class="n">out</span><span class="err">\</span><span class="n">Release</span><span class="err">\</span><span class="n">instrument</span><span class="p">.</span><span class="n">exe</span> <span class="o">--</span><span class="n">input</span><span class="o">-</span><span class="n">image</span><span class="o">=</span><span class="n">out</span><span class="err">\</span><span class="n">Release</span><span class="err">\</span><span class="n">instrument</span><span class="p">.</span><span class="n">exe</span> <span class="o">--</span><span class="n">output</span><span class="o">-</span><span class="n">image</span><span class="o">=</span><span class="n">nul</span> <span class="o">--</span><span class="n">mode</span><span class="o">=</span><span class="n">doare</span> <span class="o">--</span><span class="n">verbose</span>
</span><span class='line'><span class="p">[...]</span>
</span><span class='line'><span class="p">[</span><span class="mi">0902</span><span class="o">/</span><span class="mi">120452</span><span class="o">:</span><span class="nl">VERBOSE1:</span><span class="n">doare_transforms</span><span class="p">.</span><span class="n">cc</span><span class="p">(</span><span class="mi">22</span><span class="p">)]</span> <span class="n">instrument</span><span class="o">::</span><span class="n">transforms</span><span class="o">::</span><span class="n">CallGraphAnalysis</span><span class="o">::</span><span class="nl">OnBlock:</span> <span class="n">block_graph</span><span class="o">::</span><span class="n">BlockGraph</span><span class="o">::</span><span class="n">AddressSpace</span><span class="o">::</span><span class="n">GetBlockByAddress</span>
</span><span class='line'><span class="p">[</span><span class="mi">0902</span><span class="o">/</span><span class="mi">120452</span><span class="o">:</span><span class="nl">VERBOSE1:</span><span class="n">doare_transforms</span><span class="p">.</span><span class="n">cc</span><span class="p">(</span><span class="mi">36</span><span class="p">)]</span> <span class="n">pe</span><span class="o">::</span><span class="err">`</span><span class="n">anonymous</span> <span class="k">namespace</span><span class="err">&#39;</span><span class="o">::</span><span class="n">Decompose</span> <span class="o">-&gt;</span> <span class="n">block_graph</span><span class="o">::</span><span class="n">BlockGraph</span><span class="o">::</span><span class="n">AddressSpace</span><span class="o">::</span><span class="n">GetBlockByAddress</span>
</span><span class='line'><span class="p">[</span><span class="mi">0902</span><span class="o">/</span><span class="mi">120452</span><span class="o">:</span><span class="nl">VERBOSE1:</span><span class="n">doare_transforms</span><span class="p">.</span><span class="n">cc</span><span class="p">(</span><span class="mi">36</span><span class="p">)]</span> <span class="n">pe</span><span class="o">::</span><span class="err">`</span><span class="n">anonymous</span> <span class="k">namespace</span><span class="err">&#39;</span><span class="o">::</span><span class="n">Decompose</span> <span class="o">-&gt;</span> <span class="n">block_graph</span><span class="o">::</span><span class="n">BlockGraph</span><span class="o">::</span><span class="n">AddressSpace</span><span class="o">::</span><span class="n">GetBlockByAddress</span>
</span><span class='line'><span class="p">[...]</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Visualize it?</h3>

<p>As I was writing this I figured it might be worth to spend a bit of time trying to visualize this network to make it more attractive for the readers. So I decided to use <a href="http://visjs.org/network_examples.html">visjs</a> and the <code>Post</code> callback to output the call-graph in a way visjs would understand:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="kt">bool</span> <span class="n">CallGraphAnalysis</span><span class="o">::</span><span class="n">PostBlockGraphIteration</span><span class="p">(</span>
</span><span class='line'>    <span class="k">const</span> <span class="n">TransformPolicyInterface</span><span class="o">*</span> <span class="n">policy</span><span class="p">,</span>
</span><span class='line'>    <span class="n">BlockGraph</span><span class="o">*</span> <span class="n">block_graph</span><span class="p">,</span>
</span><span class='line'>    <span class="n">Block</span><span class="o">*</span> <span class="n">header_block</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">VLOG</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;      Blocks found: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">total_blocks_</span><span class="p">;</span>
</span><span class='line'>  <span class="n">VLOG</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; Code Blocks found: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">total_code_blocks_</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">main_block_</span> <span class="o">==</span> <span class="n">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;A &#39;main&#39; block is mandatory.&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Now we walk the graph from the &#39;main&#39; block, with a BFS algorithm.</span>
</span><span class='line'>  <span class="n">uint32_t</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">list</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">Block</span><span class="o">*</span><span class="p">,</span> <span class="n">Block</span><span class="o">*&gt;&gt;</span> <span class="n">selected_edges</span><span class="p">;</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">Block</span><span class="o">*</span><span class="p">,</span> <span class="n">uint32_t</span><span class="o">&gt;</span> <span class="n">selected_nodes</span><span class="p">;</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">Block</span><span class="o">*</span><span class="p">,</span> <span class="n">uint32_t</span><span class="o">&gt;</span> <span class="n">selected_nodes_levels</span><span class="p">;</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">Block</span><span class="o">*&gt;</span> <span class="n">nodes_to_inspect</span><span class="p">{</span><span class="n">main_block_</span><span class="p">};</span>
</span><span class='line'>  <span class="k">while</span> <span class="p">(</span><span class="n">nodes_to_inspect</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// Make a copy of the node to inspect so that we can iterate</span>
</span><span class='line'>    <span class="c1">// over them.</span>
</span><span class='line'>    <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">Block</span><span class="o">*&gt;</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">nodes_to_inspect</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// The node selected to be inspected in the next iteration of</span>
</span><span class='line'>    <span class="c1">// the loop will be added in this set.</span>
</span><span class='line'>    <span class="n">nodes_to_inspect</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Go through every nodes to find to what nodes they are connected</span>
</span><span class='line'>    <span class="c1">// to.</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">node_to_inspect</span> <span class="o">:</span> <span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="c1">// Assign an index and a level to the node.</span>
</span><span class='line'>      <span class="n">selected_nodes</span><span class="p">.</span><span class="n">emplace</span><span class="p">(</span><span class="n">node_to_inspect</span><span class="p">,</span> <span class="n">idx</span><span class="o">++</span><span class="p">);</span>
</span><span class='line'>      <span class="n">selected_nodes_levels</span><span class="p">[</span><span class="n">node_to_inspect</span><span class="p">]</span> <span class="o">=</span> <span class="n">level</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Now let&#39;s iterate through the edges to find to what nodes, the current</span>
</span><span class='line'>      <span class="c1">// one is connected to.</span>
</span><span class='line'>      <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">edge</span> <span class="o">:</span> <span class="n">edges_</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// We are interested to find edges connected to the current node.</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">edge</span><span class="p">.</span><span class="n">first</span> <span class="o">!=</span> <span class="n">node_to_inspect</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">continue</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Get the connected node and make sure we haven&#39;t handled it already.</span>
</span><span class='line'>        <span class="n">Block</span><span class="o">*</span> <span class="n">to_block</span><span class="p">(</span><span class="n">edge</span><span class="p">.</span><span class="n">second</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">selected_nodes</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">to_block</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">continue</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">selected_nodes</span><span class="p">.</span><span class="n">emplace</span><span class="p">(</span><span class="n">to_block</span><span class="p">,</span> <span class="n">idx</span><span class="o">++</span><span class="p">);</span>
</span><span class='line'>        <span class="n">selected_nodes_levels</span><span class="p">[</span><span class="n">to_block</span><span class="p">]</span> <span class="o">=</span> <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// If it&#39;s a</span>
</span><span class='line'>        <span class="n">selected_edges</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">node_to_inspect</span><span class="p">,</span> <span class="n">to_block</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// We need to analyze this block at the next iteration (level + 1).</span>
</span><span class='line'>        <span class="n">nodes_to_inspect</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">to_block</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Bump the level as we finished analyzing the nodes we wanted to inspect.</span>
</span><span class='line'>    <span class="n">level</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;var nodes = new vis.DataSet([&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">node</span> <span class="o">:</span> <span class="n">selected_nodes</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">Block</span><span class="o">*</span> <span class="n">block</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">first</span><span class="p">);</span>
</span><span class='line'>    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">compiland_path</span> <span class="o">=</span> <span class="n">block</span><span class="o">-&gt;</span><span class="n">compiland_name</span><span class="p">().</span><span class="n">c_str</span><span class="p">();</span>
</span><span class='line'>    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">compiland_name</span> <span class="o">=</span> <span class="n">strrchr</span><span class="p">(</span><span class="n">compiland_path</span><span class="p">,</span> <span class="sc">&#39;\\&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">description</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">compiland_name</span> <span class="o">!=</span> <span class="n">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">compiland_name</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">compiland_name</span> <span class="o">=</span> <span class="s">&quot;Unknown&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">uint32_t</span> <span class="n">level</span> <span class="o">=</span> <span class="n">selected_nodes_levels</span><span class="p">[</span><span class="n">block</span><span class="p">];</span>
</span><span class='line'>    <span class="n">_snprintf_s</span><span class="p">(</span><span class="n">description</span><span class="p">,</span> <span class="n">ARRAYSIZE</span><span class="p">(</span><span class="n">description</span><span class="p">),</span> <span class="n">_TRUNCATE</span><span class="p">,</span>
</span><span class='line'>                <span class="s">&quot;RVA: %p&lt;br&gt;Size: %d&lt;br&gt;Level: %d&lt;br&gt;Compiland: %s&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">().</span><span class="n">value</span><span class="p">(),</span> <span class="n">block</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">(),</span> <span class="n">level</span><span class="p">,</span>
</span><span class='line'>                <span class="n">compiland_name</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;  { id : &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">node</span><span class="p">.</span><span class="n">second</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, label : </span><span class="se">\&quot;</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">block</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">()</span>
</span><span class='line'>              <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">, &quot;</span>
</span><span class='line'>              <span class="o">&lt;&lt;</span> <span class="s">&quot;title : &#39;&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">description</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;&#39;, group : &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">level</span>
</span><span class='line'>              <span class="o">&lt;&lt;</span> <span class="s">&quot;, value : &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">block</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; },&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;]);&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span>
</span><span class='line'>            <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;var edges = new vis.DataSet([&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">edge</span> <span class="o">:</span> <span class="n">selected_edges</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;  { from : &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">selected_nodes</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">edge</span><span class="p">.</span><span class="n">first</span><span class="p">)</span>
</span><span class='line'>              <span class="o">&lt;&lt;</span> <span class="s">&quot;, to : &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">selected_nodes</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">edge</span><span class="p">.</span><span class="n">second</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; },&quot;</span>
</span><span class='line'>              <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;]);&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>  <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The above function basically starts to walk the network from the <code>main</code> function and do a BFS algorithm (that allows us to define <em>levels</em> for each Block). It then outputs two sets of data: the nodes, and the edges.</p>

<p>If you would like to check out the result I have uploaded an interactive network graph here: <a href="/images/binary_rewriting_with_syzygy/network.afl-fuzz.exe.html">network.afl-fuzz.exe.html</a>. Even though it sounds pretty useless, it looks pretty cool!</p>

<h2>SecurityCookieCheckHookTransform</h2>

<h3>The problem</h3>

<p>The idea for this transform came back when I was playing around with <a href="https://github.com/ivanfratric/winafl">WinAFL</a>; I encountered a case where one of the test-case triggered a <a href="https://msdn.microsoft.com/en-us/library/8dbf701c.aspx">/GS</a> violation in a harness program I was fuzzing. Buffer security checks are a set of compiler and runtime instrumentation aiming at detecting and preventing the exploitation of stack-based buffer overflows. A cookie is placed on the stack by the prologue of the protected function in between the local variables of the stack-frame and the saved stack pointer / saved instruction pointer. The compiler instruments the code so that before the function returns, it invokes a check function (called <code>__security_check_cookie</code>) that ensure the integrity of the cookie.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='nasm'><span class='line'><span class="c1">; void __fastcall __security_check_cookie(unsigned int cookie)</span>
</span><span class='line'><span class="err">@</span><span class="nf">__security_check_cookie@4</span> <span class="nv">proc</span> <span class="nv">near</span>
</span><span class='line'><span class="nf">cookie</span><span class="err">=</span> <span class="kt">dword</span> <span class="nv">ptr</span> <span class="o">-</span><span class="mi">4</span>
</span><span class='line'>   <span class="nf">cmp</span>     <span class="nb">ecx</span><span class="p">,</span> <span class="nv">___security_cookie</span>
</span><span class='line'>   <span class="nf">repne</span> <span class="nv">jnz</span> <span class="nv">short</span> <span class="nv">failure</span>
</span><span class='line'>   <span class="nf">repne</span> <span class="nv">retn</span>
</span><span class='line'><span class="nl">failure:</span>
</span><span class='line'>   <span class="nf">repne</span> <span class="nv">jmp</span> <span class="nv">___report_gsfailure</span>
</span><span class='line'><span class="err">@</span><span class="nf">__security_check_cookie@4</span> <span class="nv">endp</span>
</span></code></pre></td></tr></table></div></figure>


<p>If the cookie matches the secret, everything is fine, the function returns and life goes on. If it does not, it means something overwrote it and as a result the process needs to be killed. The way the check function achieves this is by raising an exception that the process cannot even catch itself; which makes sense if you think about it as you don&rsquo;t want an attacker to be able to hijack the exception.</p>

<p>On recent version of Windows, this is achieved via a <a href="http://www.alex-ionescu.com/?p=69">fail-fast exception</a> or by invoking <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms681401(v=vs.85).aspx">UnhandledExceptionFilter</a> (after forcing the top level exception filter to 0) and terminating the process (done by <code>__raise_securityfailure</code>).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='nasm'><span class='line'><span class="c1">; void __cdecl __raise_securityfailure(_EXCEPTION_POINTERS *const exception_pointers)</span>
</span><span class='line'><span class="nf">___raise_securityfailure</span> <span class="nv">proc</span> <span class="nv">near</span>
</span><span class='line'><span class="nf">exception_pointers</span><span class="err">=</span> <span class="kt">dword</span> <span class="nv">ptr</span>  <span class="mi">8</span>
</span><span class='line'>   <span class="nf">push</span>    <span class="nb">ebp</span>
</span><span class='line'>   <span class="nf">mov</span>     <span class="nb">ebp</span><span class="p">,</span> <span class="nb">esp</span>
</span><span class='line'>   <span class="nf">push</span>    <span class="mi">0</span>
</span><span class='line'>   <span class="nf">call</span>    <span class="nb">ds</span><span class="p">:</span><span class="nv">__imp__SetUnhandledExceptionFilter@4</span>
</span><span class='line'>   <span class="nf">mov</span>     <span class="nb">eax</span><span class="p">,</span> <span class="p">[</span><span class="nb">ebp</span><span class="o">+</span><span class="nv">exception_pointers</span><span class="p">]</span>
</span><span class='line'>   <span class="nf">push</span>    <span class="nb">eax</span>
</span><span class='line'>   <span class="nf">call</span>    <span class="nb">ds</span><span class="p">:</span><span class="nv">__imp__UnhandledExceptionFilter@4</span>
</span><span class='line'>   <span class="nf">push</span>    <span class="mh">0C0000409h</span>
</span><span class='line'>   <span class="nf">call</span>    <span class="nb">ds</span><span class="p">:</span><span class="nv">__imp__GetCurrentProcess@0</span>
</span><span class='line'>   <span class="nf">push</span>    <span class="nb">eax</span>
</span><span class='line'>   <span class="nf">call</span>    <span class="nb">ds</span><span class="p">:</span><span class="nv">__imp__TerminateProcess@8</span>
</span><span class='line'>   <span class="nf">pop</span>     <span class="nb">ebp</span>
</span><span class='line'>   <span class="nf">retn</span>
</span><span class='line'><span class="nf">___raise_securityfailure</span> <span class="nv">endp</span>
</span></code></pre></td></tr></table></div></figure>


<p>Funny enough &ndash; if this sounds familiar &ndash; turns out I have encountered this very problem a while back and you can read the story here: <a href="http://doar-e.github.io/blog/2013/10/12/having-a-look-at-the-windows-userkernel-exceptions-dispatcher/">Having a Look at the Windows&#8217; User/Kernel Exceptions Dispatcher</a>.</p>

<p>The thing is when you are fuzzing, this is exactly the type of thing you would like to be aware of. WinAFL uses an in-process exception handler to do the crash monitoring part which means that this type of crashes would not go through the crash monitoring. Bummer.</p>

<h3>The solution</h3>

<p>I started evaluating syzygy with this simple task: making the program crash with a <em>regular</em> exception (that can get caught by an in-process exception handler). I figured it would be a walk in the park, as I basically needed to apply very little transformation to the binary to make this work.</p>

<p>First step is to define a transform as in the previous example. This time I subclass <code>NamedBlockGraphTransformImpl</code> which wants me to implement a <code>TransformBlockGraph</code> method that receives: a transform policy (used to make decision before applying transformation), the graph (block_graph) and a data Block that represents the PE header of our image (header_block):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">class</span> <span class="nc">SecurityCookieCheckHookTransform</span>
</span><span class='line'>    <span class="o">:</span> <span class="k">public</span> <span class="n">block_graph</span><span class="o">::</span><span class="n">transforms</span><span class="o">::</span><span class="n">NamedBlockGraphTransformImpl</span><span class="o">&lt;</span>
</span><span class='line'>          <span class="n">SecurityCookieCheckHookTransform</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'> <span class="k">public</span><span class="o">:</span>
</span><span class='line'>  <span class="n">SecurityCookieCheckHookTransform</span><span class="p">()</span> <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">kTransformName</span><span class="p">[];</span>
</span><span class='line'>  <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">kReportGsFailure</span><span class="p">[];</span>
</span><span class='line'>  <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">kSyzygyReportGsFailure</span><span class="p">[];</span>
</span><span class='line'>  <span class="k">static</span> <span class="k">const</span> <span class="n">uint32_t</span> <span class="n">kInvalidUserAddress</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// BlockGraphTransformInterface implementation.</span>
</span><span class='line'>  <span class="kt">bool</span> <span class="n">TransformBlockGraph</span><span class="p">(</span><span class="k">const</span> <span class="n">TransformPolicyInterface</span><span class="o">*</span> <span class="n">policy</span><span class="p">,</span>
</span><span class='line'>                           <span class="n">BlockGraph</span><span class="o">*</span> <span class="n">block_graph</span><span class="p">,</span>
</span><span class='line'>                           <span class="n">BlockGraph</span><span class="o">::</span><span class="n">Block</span><span class="o">*</span> <span class="n">header_block</span><span class="p">)</span> <span class="n">final</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>As I explained a bit earlier, the BlockGraph is the top level container of Blocks. This is what I walk through in order to find our Block of interest. The Block of interest for us has the name <code>__report_gsfailure</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="n">BlockGraph</span><span class="o">::</span><span class="n">Block</span><span class="o">*</span> <span class="n">report_gsfailure</span> <span class="o">=</span> <span class="n">nullptr</span><span class="p">;</span>
</span><span class='line'><span class="n">BlockGraph</span><span class="o">::</span><span class="n">BlockMap</span><span class="o">&amp;</span> <span class="n">blocks</span> <span class="o">=</span> <span class="n">block_graph</span><span class="o">-&gt;</span><span class="n">blocks_mutable</span><span class="p">();</span>
</span><span class='line'><span class="k">for</span> <span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span> <span class="n">block</span> <span class="o">:</span> <span class="n">blocks</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">name</span><span class="p">(</span><span class="n">block</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">name</span><span class="p">());</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="n">kReportGsFailure</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">report_gsfailure</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">.</span><span class="n">second</span><span class="p">;</span>
</span><span class='line'>    <span class="k">break</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="n">report_gsfailure</span> <span class="o">==</span> <span class="n">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Could not find &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">kReportGsFailure</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;.&quot;</span><span class="p">;</span>
</span><span class='line'>  <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The transform tries to be careful by checking that the Block only has a single referrer: which should be the <code>__security_cookie_check</code> Block. If not, I gracefully exit and don&rsquo;t apply the transformation as I am not sure with what I am dealing with.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">if</span> <span class="p">(</span><span class="n">report_gsfailure</span><span class="o">-&gt;</span><span class="n">referrers</span><span class="p">().</span><span class="n">size</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// We bail out if we don&#39;t have a single referrer as the only</span>
</span><span class='line'>  <span class="c1">// expected referrer is supposed to be __security_cookie_check.</span>
</span><span class='line'>  <span class="c1">// If there is more than one, we would rather bail out than take</span>
</span><span class='line'>  <span class="c1">// a chance at modifying the behavior of the PE image.</span>
</span><span class='line'>  <span class="n">LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Only a single referrer to &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">kReportGsFailure</span>
</span><span class='line'>             <span class="o">&lt;&lt;</span> <span class="s">&quot; is expected.&quot;</span><span class="p">;</span>
</span><span class='line'>  <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>At this point, I create a new Block that has only a single instruction designed to trigger a fault every time; to do so I can even use the basic Intel assembler integrated in syzygy. After this, I place this new Block inside the <code>.text</code> section the image (tracked by the BlockGraph as mentioned earlier).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="n">BlockGraph</span><span class="o">::</span><span class="n">Section</span><span class="o">*</span> <span class="n">section_text</span> <span class="o">=</span> <span class="n">block_graph</span><span class="o">-&gt;</span><span class="n">FindOrAddSection</span><span class="p">(</span>
</span><span class='line'>    <span class="n">pe</span><span class="o">::</span><span class="n">kCodeSectionName</span><span class="p">,</span> <span class="n">pe</span><span class="o">::</span><span class="n">kCodeCharacteristics</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// All of the below is needed to build the instrumentation via the assembler.</span>
</span><span class='line'><span class="n">BasicBlockSubGraph</span> <span class="n">bbsg</span><span class="p">;</span>
</span><span class='line'><span class="n">BasicBlockSubGraph</span><span class="o">::</span><span class="n">BlockDescription</span><span class="o">*</span> <span class="n">block_desc</span> <span class="o">=</span> <span class="n">bbsg</span><span class="p">.</span><span class="n">AddBlockDescription</span><span class="p">(</span>
</span><span class='line'>    <span class="n">kSyzygyReportGsFailure</span><span class="p">,</span> <span class="n">nullptr</span><span class="p">,</span> <span class="n">BlockGraph</span><span class="o">::</span><span class="n">CODE_BLOCK</span><span class="p">,</span>
</span><span class='line'>    <span class="n">section_text</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">(),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="n">BasicCodeBlock</span><span class="o">*</span> <span class="n">bb</span> <span class="o">=</span> <span class="n">bbsg</span><span class="p">.</span><span class="n">AddBasicCodeBlock</span><span class="p">(</span><span class="n">kSyzygyReportGsFailure</span><span class="p">);</span>
</span><span class='line'><span class="n">block_desc</span><span class="o">-&gt;</span><span class="n">basic_block_order</span><span class="p">.</span><span class="n">pushf_back</span><span class="p">(</span><span class="n">bb</span><span class="p">);</span>
</span><span class='line'><span class="n">BasicBlockAssembler</span> <span class="n">assm</span><span class="p">(</span><span class="n">bb</span><span class="o">-&gt;</span><span class="n">instructions</span><span class="p">().</span><span class="n">begin</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">bb</span><span class="o">-&gt;</span><span class="n">instructions</span><span class="p">());</span>
</span><span class='line'><span class="n">assm</span><span class="p">.</span><span class="n">mov</span><span class="p">(</span><span class="n">Operand</span><span class="p">(</span><span class="n">Displacement</span><span class="p">(</span><span class="n">kInvalidUserAddress</span><span class="p">)),</span> <span class="n">assm</span><span class="o">::</span><span class="n">eax</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Condense into a block.</span>
</span><span class='line'><span class="n">BlockBuilder</span> <span class="n">block_builder</span><span class="p">(</span><span class="n">block_graph</span><span class="p">);</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">block_builder</span><span class="p">.</span><span class="n">Merge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bbsg</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Failed to build &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">kSyzygyReportGsFailure</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; block.&quot;</span><span class="p">;</span>
</span><span class='line'>  <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">DCHECK_EQ</span><span class="p">(</span><span class="mi">1u</span><span class="p">,</span> <span class="n">block_builder</span><span class="p">.</span><span class="n">new_blocks</span><span class="p">().</span><span class="n">size</span><span class="p">());</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finally, I update all the referrers to point to our new Block, and remove the <code>__report_gsfailure</code> Block as it is effectively now dead-code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="c1">// Transfer the referrers to the new block, and delete the old one.</span>
</span><span class='line'><span class="n">BlockGraph</span><span class="o">::</span><span class="n">Block</span><span class="o">*</span> <span class="n">syzygy_report_gsfailure</span> <span class="o">=</span>
</span><span class='line'>    <span class="n">block_builder</span><span class="p">.</span><span class="n">new_blocks</span><span class="p">().</span><span class="n">front</span><span class="p">();</span>
</span><span class='line'><span class="n">report_gsfailure</span><span class="o">-&gt;</span><span class="n">TransferReferrers</span><span class="p">(</span>
</span><span class='line'>    <span class="mi">0</span><span class="p">,</span> <span class="n">syzygy_report_gsfailure</span><span class="p">,</span>
</span><span class='line'>    <span class="n">BlockGraph</span><span class="o">::</span><span class="n">Block</span><span class="o">::</span><span class="n">kTransferInternalReferences</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="n">report_gsfailure</span><span class="o">-&gt;</span><span class="n">RemoveAllReferences</span><span class="p">();</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">block_graph</span><span class="o">-&gt;</span><span class="n">RemoveBlock</span><span class="p">(</span><span class="n">report_gsfailure</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Removing &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">kReportGsFailure</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; failed.&quot;</span><span class="p">;</span>
</span><span class='line'>  <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here is what it looks like after our transformation:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='nasm'><span class='line'><span class="c1">; void __fastcall __security_check_cookie(unsigned int cookie)</span>
</span><span class='line'><span class="err">@</span><span class="nf">__security_check_cookie@4</span> <span class="nv">proc</span> <span class="nv">near</span>
</span><span class='line'><span class="nf">cookie</span> <span class="err">=</span> <span class="nb">ecx</span>
</span><span class='line'>                <span class="nf">cmp</span>     <span class="nv">cookie</span><span class="p">,</span> <span class="nv">___security_cookie</span>
</span><span class='line'>                <span class="nf">repne</span> <span class="nv">jnz</span> <span class="nv">short</span> <span class="nv">failure</span>
</span><span class='line'>                <span class="nf">repne</span> <span class="nv">retn</span>
</span><span class='line'><span class="nl">failure:</span>
</span><span class='line'>                <span class="nf">repne</span> <span class="nv">jmp</span> <span class="nv">loc_426EE6</span> <span class="o">&lt;-</span> <span class="nv">our</span> <span class="nv">new</span> <span class="nv">__report_gsfailure</span> <span class="nb">bl</span><span class="nv">ock</span>
</span><span class='line'>
</span><span class='line'><span class="nl">loc_426EE6:</span>
</span><span class='line'>                <span class="nf">mov</span>     <span class="nb">ds</span><span class="p">:</span><span class="mh">0DEADBEEFh</span><span class="p">,</span> <span class="nb">eax</span>
</span></code></pre></td></tr></table></div></figure>


<h3>One does not simply binary rewrite</h3>

<p>It may look like an easy problem without any pitfall, but before settling down on the solution above I actually first tried to rewrite the <code>__security_check_cookie</code> function. I thought it would be cleaner and it was also very easy to do with syzygy. I had to create a new Block, and transfer the referrers to my new block and.. that was it!</p>

<p>Now it was working fine on a bunch of targets on various OSs: Windows 7, Windows 8, Windows 8.1, Windows 10. Until I started notice some instrumented binaries that would not even execute; the loader would not load the binary and I was left with some message box telling me the binary could not be loaded in memory: <code>STATUS_INVALID_IMAGE_FORMAT</code> or <code>0xc000007b</code>. This was pretty mysterious at first as the instrumented binary would run fine on Windows 7 but not on Windows 10. The instrumented binary also looked instrumented fine &ndash; the way I wanted it to be instrumented: all the callers of <code>__security_check_cookie</code> were now calling into my new function and nothing seemed off.</p>

<p>At this point, the only thing I knew was that the PE loader was not happy with the file; so that is where I started my investigation. After hours of back and forth between ntdll and the kernel I found that the CFG <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms680547(v=vs.85).aspx">LoadConfigDirectory.GuardCFFunctionTable</a> table (where the compiler puts all the valid indirect-call targets) embedded in binaries is expected to be <em>ordered</em> from low to high RVAs. I have also realized at this point that one of the referrer of my block was this CFG table, that would get fixed-up with the RVA of wherever the new block was placed by the binary rewriting framework. And of course, in some cases this RVA would end up being greater than the RVA right after in the table&hellip; upsetting the loader.</p>

<p><img class="center" src="/images/binary_rewriting_with_syzygy/security_cookie_GuardCFFunctionTable.png"></p>

<p>All of this to say that even though the framework is robust, binary rewriting can be hard when instrumenting unknown target that may make assumptions on the way their functions look, or how some part of the code / data is laid out, etc. So keep that in mind while playing :).</p>

<h1>Last words</h1>

<p>In this post I have introduced the syzygy framework, presented some of its strengths as well as limitations, and illustrated what can you do with it on two simple examples. I am hoping to be able to write a second post where I can talk a bit more of two other transforms I have designed to built the <a href="https://github.com/ivanfratric/winafl#statically-instrument-a-binary-via-syzygy">static instrumentation</a> mode of <a href="https://github.com/ivanfratric/winafl">WinAFL</a> and how every pieces work together. I would also like to try to see if I can&rsquo;t cook some obfuscation or something of the sort.</p>

<p>As usual you can find the codes on my github here: <a href="https://github.com/0vercl0k/stuffz/blob/master/syzygy/binary_rewriting_with_syzygy_pt._i.diff">stuffz/syzygy</a>.</p>

<p>If you can&rsquo;t wait for the next post, you can have already a look at <a href="https://github.com/google/syzygy/blob/master/syzygy/instrument/transforms/add_implicit_tls_transform.cc">add_implicit_tls_transform.cc</a> and <a href="https://github.com/google/syzygy/blob/master/syzygy/instrument/transforms/afl_transform.cc">afl_transform.cc</a>.</p>

<p>Last but not least, special shout-outs to my proofreader <a href="https://twitter.com/yrp604">yrp</a>.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Axel "0vercl0k" Souchet</span></span>

      








  


<time datetime="2017-08-05T16:08:00-07:00" pubdate data-updated="true">Aug 5<span>th</span>, 2017</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/binary-rewriting/'>binary rewriting</a>, <a class='category' href='/blog/categories/program-analysis/'>program analysis</a>, <a class='category' href='/blog/categories/syzygy/'>syzygy</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2016/12/21/happy-unikernels/" title="Previous Post: happy unikernels">&laquo; happy unikernels</a>
      
      
        <a class="basic-alignment right" href="/blog/2017/12/01/debugger-data-model/" title="Next Post: Debugger data model, Javascript & x64 exception handling">Debugger data model, Javascript & x64 exception handling &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2017/12/01/debugger-data-model/">Debugger data model, Javascript & x64 exception handling</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/08/05/binary-rewriting-with-syzygy/">Binary rewriting with syzygy, Pt. I</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/12/21/happy-unikernels/">happy unikernels</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/11/27/clang-and-passes/">Token capture via an llvm-based analysis pass</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/08/18/keygenning-with-klee/">Keygenning with KLEE</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2018 -  Axel Souchet, Jonathan Salwan, Jérémy Fetiveau <br/>
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a> + <a href="https://github.com/ioveracker/mnml">mnml</a>.
	  
  </span>
</p>

</footer>
  












  <script type="text/javascript">
  jQuery(document).ready(function() {
    // Put a TOC right before the entry content.
    if(jQuery('div[id="tocBlock"]').length == 0)
        generateTOC('.entry-content-toc', null);
  });
  </script>

</body>
</html>
