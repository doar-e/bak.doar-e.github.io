
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Debugger data model, Javascript & x64 exception handling - Diary of a reverse-engineer</title>
  <meta name="author" content="Axel Souchet, Jonathan Salwan, Jérémy Fetiveau">

  
  <meta name="description" content="Introduction The main goal of today&rsquo;s post is to show a bit more of what is now possible with the latest Windbg (currently branded &ldquo; &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://doar-e.github.io/blog/2017/12/01/debugger-data-model">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Diary of a reverse-engineer" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <script src="/javascripts/jquery.tableofcontents.min.js" type="text/javascript"></script>
  <script src="/javascripts/generate-toc.js" type="text/javascript"></script>

  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="https://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-43481215-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>



  <style>
    p { text-align: justify; }
  </style>

</head>
<body   class="collapse-sidebar sidebar-footer" >
  <header role="banner"><img src="/images/sigle-blanc-250px.jpg"></img>

	<div class="header-title"><a href="/">Diary of a reverse-engineer</a></div>


	<br><div class="header-subtitle">Because we like to play with weird things.</div>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:doar-e.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About</a></li>
  <li><a href="/presentations">Presentations</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
  
    
      <h1 class="entry-title">Debugger Data Model, Javascript & X64 Exception Handling</h1>
    
  
    
      <p class="meta">
        








  


<time datetime="2017-12-01T06:59:00-08:00" pubdate data-updated="true">Dec 1<span>st</span>, 2017</time>
        
      </p>
    
  </header>


<div class="entry-content"><h1>Introduction</h1>

<p>The main goal of today&rsquo;s post is to show a bit more of what is now possible with the latest Windbg (currently branded <a href="https://blogs.windows.com/buildingapps/2017/08/28/new-windbg-available-preview/">&ldquo;WinDbg Preview&rdquo;</a> in the Microsoft store) and the time travel debugging tools that Microsoft released a few months ago. When these finally got released, a bit after <a href="https://cppcon2017.sched.com/">cppcon2017</a> this year, I expected a massive pick-up from the security / reverse-engineering industry with a bunch of posts, tools, scripts, etc. To my surprise, this has not happened yet so I have waited patiently for my vacation to write a little something about it myself. So, here goes!</p>

<p>Obviously, one of the most <em>noticeable</em> change in this debugger is the new UI.. but this is not something we will talk about. The <em>second</em> big improvement is .. a decent scripting engine! Until recently, I always had to use <a href="https://pykd.codeplex.com/">pyKD</a> to write automation scripts. This has worked <em>fairly</em> well for years, but I’m glad to move away from it and embrace the new extension model provided by Windbg &amp; Javascript (yes, you read this right). One of the biggest pain point I’ve to deal with with pyKD (aside from the installation process!) is that you had to evaluate many commands and then parse their outputs to extract the bits and pieces you needed. Thankfully, the new <em>debugger data model</em> solves this (or part of this anyway). The third new change is the integration of the time travel debugging (TTD) features discussed in this presentation: <a href="https://cppcon2017.sched.com/event/Bgsj/time-travel-debugging-root-causing-bugs-in-commercial-scale-software">Time Travel Debugging: Root Causing Bugs in Commercial Scale Software
</a>.</p>

<p>The goal of this post is to leverage all the nifty stuff we will learn to enumerate x64 <a href="https://docs.microsoft.com/fr-fr/cpp/cpp/try-except-statement">try/except</a> handlers in Javascript.</p>

<p>So grab yourself a cup of fine coffee and read on :).</p>

<div class='entry-content-toc'></div>




<!--more-->


<h1>The debugger data model</h1>

<h2>Overview</h2>

<p>What is being called the <em>debugger data model</em> is a hierarchy of objects (methods, properties, values) that are accessible both directly from the debugger&rsquo;s command window and through a Javascript API. The debugger exposes a bunch of information that it is responsible: thread related information, register values, stack trace information, etc. As an extension writer, you can go and expose your feature through the node of your choosing in the hierarchy. Once it is plugged in into the model, it is available for consumption by another script, or through the debugger&rsquo;s command window.</p>

<p><img class="center" src="/images/debugger_data_model__javascript___x64_exception_handling/model.png"></p>

<p>One really interesting property of this exposed information is that it becomes <em>queryable</em> via operators that have been highly inspired from C#’s LINQ operators. For those who are unfamiliar with them I would suggest looking at <a href="https://docs.microsoft.com/en-us/dotnet/csharp/programming-guide/concepts/linq/basic-linq-query-operations">Basic LINQ query operations</a>.</p>

<h2>First query</h2>

<p>Say you would like to find what modules the current <code>@rip</code> is pointing into, you can easily express this through a query using LINQ operators and the data model:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>0:001&gt; dx @$curprocess.Modules.Where(p =&gt; @rip &gt;= p.BaseAddress &amp;&amp; @rip &lt; (p.BaseAddress+p.Size))
</span><span class='line'>@$curprocess.Modules.Where(p =&gt; @rip &gt;= p.BaseAddress &amp;&amp; @rip &lt; (p.BaseAddress+p.Size))
</span><span class='line'>    [0x8]            : C:\WINDOWS\SYSTEM32\ntdll.dll
</span></code></pre></td></tr></table></div></figure>


<p>..and you can even check all the information related to this module by clicking on the DML <code>[0x8]</code> link:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>0:001&gt; dx -r1 @$curprocess.Modules.Where(p =&gt; @rip &gt;= p.BaseAddress &amp;&amp; @rip &lt; (p.BaseAddress+p.Size))[8]
</span><span class='line'>@$curprocess.Modules.Where(p =&gt; @rip &gt;= p.BaseAddress &amp;&amp; @rip &lt; (p.BaseAddress+p.Size))[8]                 : C:\WINDOWS\SYSTEM32\ntdll.dll
</span><span class='line'>    BaseAddress      : 0x7ffc985a0000
</span><span class='line'>    Name             : C:\WINDOWS\SYSTEM32\ntdll.dll
</span><span class='line'>    Size             : 0x1db000
</span></code></pre></td></tr></table></div></figure>


<p>In the previous two samples, there are several interesting points to highlight:</p>

<p>1) <code>dx</code> is the operator to access the data model which is not available through the <code>??</code> / <code>?</code> operators</p>

<p>2) <code>@$name</code> is how you access a variable that you have defined during a debugging session. The debugger itself defines several variables right off the bat just to make querying the model easier: <code>@$curprocess</code> is equivalent to <code>host.currentProcess</code> in Javascript, <code>@cursession</code> is <code>host.currentSession</code>, and <code>@$curthread</code> is <code>host.currentThread</code>. You can also define custom variables yourself, for example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>0:001&gt; dx @$doare = &quot;Diary of a reverse-engineer&quot;
</span><span class='line'>@$doare = &quot;Diary of a reverse-engineer&quot; : Diary of a reverse-engineer
</span><span class='line'>    Length           : 0x1b
</span><span class='line'>0:001&gt; dx &quot;Hello, &quot; + @$doare
</span><span class='line'>&quot;Hello, &quot; + @$doare : Hello, Diary of a reverse-engineer
</span><span class='line'>    Length           : 0x22
</span><span class='line'>0:001&gt; ?? @$doare
</span><span class='line'>Bad register error at &#39;@$doare&#39;
</span><span class='line'>0:001&gt; ? @$doare
</span><span class='line'>Bad register error at &#39;@$doare&#39;
</span></code></pre></td></tr></table></div></figure>


<p>3) To query all the nodes in the <code>@$curprocess</code> hierarchy (if you want to wander through the data model you can just use <code>dx Debugger</code> and click through the DML links):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>0:001&gt; dx @$curprocess
</span><span class='line'>@$curprocess                 : cmd.exe [Switch To]
</span><span class='line'>    Name             : cmd.exe
</span><span class='line'>    Id               : 0x874
</span><span class='line'>    Threads
</span><span class='line'>    Modules
</span><span class='line'>    Environment
</span></code></pre></td></tr></table></div></figure>


<p>You can also check <code>Debugger.State.DebuggerVariables</code> where you can see the definitions for the variables we just mentioned:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>0:001&gt; dx Debugger.State.DebuggerVariables
</span><span class='line'>Debugger.State.DebuggerVariables
</span><span class='line'>    cursession       : Live user mode: &lt;Local&gt;
</span><span class='line'>    curprocess       : cmd.exe [Switch To]
</span><span class='line'>    curthread        : ntdll!DbgUiRemoteBreakin (00007ffc`98675320)  [Switch To]
</span><span class='line'>    scripts
</span><span class='line'>    scriptContents   : [object Object]
</span><span class='line'>    vars
</span><span class='line'>    curstack
</span><span class='line'>    curframe         : ntdll!DbgBreakPoint [Switch To]
</span><span class='line'>0:001&gt; dx Debugger.State.DebuggerVariables.vars
</span><span class='line'>Debugger.State.DebuggerVariables.vars
</span><span class='line'>    doare            : Diary of a reverse-engineer
</span></code></pre></td></tr></table></div></figure>


<p>4) Last but not least, most of (all?) the iterable objects can be queried through LINQ-style operators. If you’ve never used these it can be a bit weird at the beginning but at some point it will click and then it is just goodness.</p>

<p>Here is the list of the currently available operators on iterable objects in the data model:</p>

<figure class='code'><figcaption><span>linq operators</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>Aggregate        [Aggregate(AggregateMethod) | Aggregate(InitialSeed, AggregateMethod) | Aggregate(InitialSeed, AggregateMethod, ResultSelectorMethod) - LINQ equivalent method which iterates through the items in the given collection, running the aggregate method on each one and storing the returned result as the current aggregate value. Once the collection has been exhausted, the final accumulated value is returned. An optional result selector method can be specified which transforms the final accumulator value before returning it.]
</span><span class='line'>All              [All(PredicateMethod) - LINQ equivalent method which returns whether all elements in the collection match a given predicate]
</span><span class='line'>AllNonError      [AllNonError(PredicateMethod) - LINQ equivalent method which returns whether all elements in the collection match a given predicate. Errors are ignored if all non-error results match the predicate.]
</span><span class='line'>Any              [Any(PredicateMethod) - LINQ equivalent method which returns whether any element in the collection matches a given predicate]
</span><span class='line'>Average          [Average([ProjectionMethod]) - LINQ equivalent method which finds the average of all values in the enumeration. An optional projection method can be specified that transforms each value before the average is computed.]
</span><span class='line'>Concat           [Concat(InnerCollection) - LINQ equivalent method which returns all elements from both collections, including duplicates.]
</span><span class='line'>Contains         [Contains(Object, [ComparatorMethod]) - LINQ equivalent method which searches for the given element in the sequence using default comparator rules. An optional comparator method can be provided that will be called each time the element is compared against an entry in the sequence.]
</span><span class='line'>Count            [Count() - LINQ equivalent method which returns the number of objects in the collection]
</span><span class='line'>Distinct         [Distinct([ComparatorMethod]) - LINQ equivalent method which returns all distinct objects from the given collection, using default comparison rules. An optional comparator method can be provided to be called each time objects in the collection must be compared.]
</span><span class='line'>Except           [Except(InnerCollection, [ComparatorMethod]) - LINQ equivalent method which returns all distinct objects in the given collection that are NOT found in the inner collection. An optional comparator method can also be specified.]
</span><span class='line'>First            [First([PredicateMethod]) - LINQ equivalent method which returns the first element in the collection or the first which matches an optional predicate]
</span><span class='line'>FirstNonError    [FirstNonError([PredicateMethod]) - LINQ equivalent method which returns the first element in the collection or the first which matches an optional predicate. Any errors encountered are ignored if a valid element is found.]
</span><span class='line'>Flatten          [Flatten([KeyProjectorMethod]) - Method which flattens a tree of collections (or a tree of keys that project to collections via an optional projector method) into a single collection]
</span><span class='line'>GroupBy          [GroupBy(KeyProjectorMethod, [KeyComparatorMethod]) - LINQ equivalent method which groups the collection by unique keys defined via a key projector and optional key comparator]
</span><span class='line'>Intersect        [Intersect(InnerCollection, [ComparatorMethod]) - LINQ equivalent method which returns all distinct objects in the given collection that are also found in the inner collection. An optional comparator method can also be specified.]
</span><span class='line'>Join             [Join(InnerCollection, Outer key selector method, Inner key selector method, Result selector method, [ComparatorMethod]) - LINQ equivalent method which projects a key for each element of the outer collection and each element of the inner collection using the methods provided. If the projected keys from both these elements match, then the result selector method is called with both those values and its output is returned to the user. An optional comparator method can also be specified.]
</span><span class='line'>Last             [Last([PredicateMethod]) - LINQ equivalent method which returns the last element in the collection or the last which matches an optional predicate]
</span><span class='line'>LastNonError     [LastNonError([PredicateMethod]) - LINQ equivalent method which returns the last element in the collection or the last which matches an optional predicate. Any errors are ignored.]
</span><span class='line'>Max              [Max([ProjectionMethod]) - LINQ equivalent method which returns the maximum element using standard comparison rules. An optional projection method can be specified to project the elements of a sequence before comparing them with each other.]
</span><span class='line'>Min              [Min([ProjectionMethod]) - LINQ equivalent method which returns the minimum element using standard comparison rules. An optional projection method can be specified to project the elements of a sequence before comparing them with each other.]
</span><span class='line'>OrderBy          [OrderBy(KeyProjectorMethod, [KeyComparatorMethod]) - LINQ equivalent method which orders the collection via a key projector and optional key comparator in ascending order]
</span><span class='line'>OrderByDescending [OrderByDescending(KeyProjectorMethod, [KeyComparatorMethod]) - LINQ equivalent method which orders the collection via a key projector and optional key comparator in descending order]
</span><span class='line'>Reverse          [Reverse() - LINQ equivalent method which returns the reverse of the supplied enumeration.]
</span><span class='line'>Select           [Select(ProjectionMethod) - LINQ equivalent method which projects the collection to a new collection via calling a projection method on every element]
</span><span class='line'>SequenceEqual    [SequenceEqual(InnerCollection, [ComparatorMethod]) - LINQ equivalent method which goes through the outer and inner collections and makes sure that they are equal (incl. sequence length). An optional comparator can be specified.]
</span><span class='line'>Single           [Single([PredicateMethod]) - LINQ equivalent method which returns the only element in a list, or, if a predicate was specified, the only element that satisfies the predicate. If there are multiple elements that match the criteria, an error is returned.]
</span><span class='line'>Skip             [Skip(Count) - LINQ equivalent method which skips the specified number of elements in the collection and returns all the rest.]
</span><span class='line'>SkipWhile        [SkipWhile(PredicateMethod) - LINQ equivalent method which runs the predicate for each element and skips it as long as it keeps returning true. Once the predicate fails, the rest of the collection is returned.]
</span><span class='line'>Sum              [Sum([ProjectionMethod]) - LINQ equivalent method which sums all the elements in the collection. Can optionally specify a projector method to transform the elements before summation occurs.]
</span><span class='line'>Take             [Take(Count) - LINQ equivalent method which takes the specified number of elements from the collection.]
</span><span class='line'>TakeWhile        [TakeWhile(PredicateMethod) - LINQ equivalent method which runs the predicate for each element and returns it only if the result is successful. Once the predicate fails, no more elements will be taken.]
</span><span class='line'>Union            [Union(InnerCollection, [ComparatorMethod]) - LINQ equivalent method which returns all distinct objects from the given and inner collection. An optional comparator method can also be specified.]
</span><span class='line'>Where            [Where(FilterMethod) - LINQ equivalent method which filters elements in the collection according to when a filter method returns true for a given element]
</span></code></pre></td></tr></table></div></figure>


<p>Now you may be wondering if the model is available with every possible <em>configuration</em> of Windbg? By configuration I mean that you can use the debugger live in user-mode attached to a process, offline looking at a crash-dump of a process, live in kernel-mode, offline looking at a system crash-dump, or off-line looking at a <em>TTD</em> trace.</p>

<p>And yes, the model is accessible with all the previous configurations, and this is awesome. This allows you to, overall, write very generic scripts as long as the information you are mining / exposing is not tied to a specific configuration.</p>

<h1>Scripting the model in Javascript</h1>

<p>As we described a bit earlier, you can now access programmatically everything that is exposed through the model via Javascript. No more <code>eval</code> or string parsing to extract the information you want, just go find the node exposing what you are after. If this node doesn’t exist, add your own to expose the information you want :)</p>

<h2>Javascript integers and Int64</h2>

<p>The first thing you need to be aware with Javascript is the fact that integers are encoded in C doubles.. which means your integers are stored in 53 bits. This is definitely a problem as most of the data we deal with are 64 bit integers. In order to address this problem, Windbg exposes a native type to Javascript that is able to store 64 bit integers. The type is called <code>Int64</code> and most (all?) information available in the data model is through <code>Int64</code> instances. This type exposes various methods to perform arithmetic and binary operations (if you use the native operators, the <code>Int64</code> gets converted back to an integer and throws if data is lost during this conversion; cf <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/javascript-debugger-scripting">Auto-conversion</a>). It takes a bit of time to get used to this, but feels natural pretty quickly. Note that the <a href="https://www.frida.re/">Frida</a> framework exposes a very similar type to address the same issue, which means it will be even easier for you if you have played with Frida in the past!</p>

<p>You can construct an <code>Int64</code> directly using a native Javascript integers (so at most 53 bits long as described above), or you can use the <code>host.parseInt64</code> method that takes a string as input. The other very important method you are going to need is <code>Int64.compareTo</code> which returns <code>1</code> if the instance is bigger than the argument, <code>0</code> if equal and <code>-1</code> if smaller. The below script shows a summary of the points we touched on:</p>

<figure class='code'><figcaption><span>Int64.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="s2">&quot;use strict&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">let</span> <span class="nx">logln</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">host</span><span class="p">.</span><span class="nx">diagnostics</span><span class="p">.</span><span class="nx">debugLog</span><span class="p">(</span><span class="nx">e</span> <span class="o">+</span> <span class="s1">&#39;\n&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">invokeScript</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">let</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">host</span><span class="p">.</span><span class="nx">Int64</span><span class="p">(</span><span class="mi">1337</span><span class="p">);</span>
</span><span class='line'>    <span class="kd">let</span> <span class="nx">aplusone</span> <span class="o">=</span> <span class="nx">a</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="c1">// 53a</span>
</span><span class='line'>    <span class="nx">logln</span><span class="p">(</span><span class="nx">aplusone</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
</span><span class='line'>    <span class="kd">let</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">host</span><span class="p">.</span><span class="nx">parseInt64</span><span class="p">(</span><span class="s1">&#39;0xdeadbeefbaadc0de&#39;</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
</span><span class='line'>    <span class="kd">let</span> <span class="nx">bplusone</span> <span class="o">=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>    <span class="c1">// 0xdeadbeefbaadc0df</span>
</span><span class='line'>    <span class="nx">logln</span><span class="p">(</span><span class="nx">bplusone</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
</span><span class='line'>    <span class="kd">let</span> <span class="nx">bplusonenothrow</span> <span class="o">=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">convertToNumber</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="c1">// 16045690984229355000</span>
</span><span class='line'>    <span class="nx">logln</span><span class="p">(</span><span class="nx">bplusonenothrow</span><span class="p">);</span>
</span><span class='line'>    <span class="k">try</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">let</span> <span class="nx">bplusonethrow</span> <span class="o">=</span> <span class="nx">b</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// Error: 64 bit value loses precision on conversion to number</span>
</span><span class='line'>        <span class="nx">logln</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="c1">// 1</span>
</span><span class='line'>    <span class="nx">logln</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">compareTo</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
</span><span class='line'>    <span class="c1">// 0</span>
</span><span class='line'>    <span class="nx">logln</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">compareTo</span><span class="p">(</span><span class="mi">1337</span><span class="p">));</span>
</span><span class='line'>    <span class="c1">// -1</span>
</span><span class='line'>    <span class="nx">logln</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">compareTo</span><span class="p">(</span><span class="mi">1338</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>For more information I would recommend looking at this page <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/javascript-debugger-scripting#bitvalues">JavaScript Debugger Scripting</a>.</p>

<h2>Accessing CPU registers</h2>

<p>Registers are accessible in the <code>host.currentThread.Registers</code> object. You can access the classical GPRs in the <code>User</code> node, but you can also access the xmm/ymm registers via <code>SIMD</code> and <code>Floating Point</code> nodes. As you may have guessed, the registers are all instances of the <code>Int64</code> object we just talked about.</p>

<h2>Reading memory</h2>

<p>You can read raw memory via the <code>host.memory.readMemoryValues</code> function. It allows you to read memory as an array of items whose size you can specify. You can also use <code>host.memory.readString</code> and <code>host.memory.readWideString</code> for reading (narrow/wide) strings directly from memory.</p>

<figure class='code'><figcaption><span>readmemory.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="s2">&quot;use strict&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">let</span> <span class="nx">logln</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">host</span><span class="p">.</span><span class="nx">diagnostics</span><span class="p">.</span><span class="nx">debugLog</span><span class="p">(</span><span class="nx">e</span> <span class="o">+</span> <span class="s1">&#39;\n&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">read_u64</span><span class="p">(</span><span class="nx">addr</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">host</span><span class="p">.</span><span class="nx">memory</span><span class="p">.</span><span class="nx">readMemoryValues</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">invokeScript</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">let</span> <span class="nx">Regs</span> <span class="o">=</span> <span class="nx">host</span><span class="p">.</span><span class="nx">currentThread</span><span class="p">.</span><span class="nx">Registers</span><span class="p">.</span><span class="nx">User</span><span class="p">;</span>
</span><span class='line'>    <span class="kd">let</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">read_u64</span><span class="p">(</span><span class="nx">Regs</span><span class="p">.</span><span class="nx">rsp</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">logln</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
</span><span class='line'>    <span class="kd">let</span> <span class="nx">WideStr</span> <span class="o">=</span> <span class="nx">host</span><span class="p">.</span><span class="nx">currentProcess</span><span class="p">.</span><span class="nx">Environment</span><span class="p">.</span><span class="nx">EnvironmentBlock</span><span class="p">.</span><span class="nx">ProcessParameters</span><span class="p">.</span><span class="nx">ImagePathName</span><span class="p">.</span><span class="nx">Buffer</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">logln</span><span class="p">(</span><span class="nx">host</span><span class="p">.</span><span class="nx">memory</span><span class="p">.</span><span class="nx">readWideString</span><span class="p">(</span><span class="nx">WideStr</span><span class="p">));</span>
</span><span class='line'>    <span class="kd">let</span> <span class="nx">WideStrAddress</span> <span class="o">=</span> <span class="nx">WideStr</span><span class="p">.</span><span class="nx">address</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">logln</span><span class="p">(</span><span class="nx">host</span><span class="p">.</span><span class="nx">memory</span><span class="p">.</span><span class="nx">readWideString</span><span class="p">(</span><span class="nx">WideStrAddress</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Executing / evaluating commands</h2>

<p>Even though a bunch of data is accessible programmatically via the data model, not everything is exposed today in the model. For example, you cannot access the same amount of information that <code>kp</code> shows you with the <code>Frame</code> model object. Specifically, the addresses of the frames or the saved return addresses are not currently available in the object unfortunately :&ndash;( As a result, being able to evaluate commands can still be important.</p>

<p>The API call <code>ExecuteCommand</code> evaluates a command and returns the output of the command as a string:</p>

<figure class='code'><figcaption><span>eval.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="s2">&quot;use strict&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">let</span> <span class="nx">logln</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">host</span><span class="p">.</span><span class="nx">diagnostics</span><span class="p">.</span><span class="nx">debugLog</span><span class="p">(</span><span class="nx">e</span> <span class="o">+</span> <span class="s1">&#39;\n&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">invokeScript</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">let</span> <span class="nx">Control</span> <span class="o">=</span> <span class="nx">host</span><span class="p">.</span><span class="nx">namespace</span><span class="p">.</span><span class="nx">Debugger</span><span class="p">.</span><span class="nx">Utility</span><span class="p">.</span><span class="nx">Control</span><span class="p">;</span>
</span><span class='line'>    <span class="k">for</span><span class="p">(</span><span class="kd">let</span> <span class="nx">Line</span> <span class="nx">of</span> <span class="nx">Control</span><span class="p">.</span><span class="nx">ExecuteCommand</span><span class="p">(</span><span class="s1">&#39;kp&#39;</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">logln</span><span class="p">(</span><span class="s1">&#39;Line: &#39;</span> <span class="o">+</span> <span class="nx">Line</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>There is at least one pitfall with this function to be aware of: the API executes <em>until</em> it completes. So, if you use <code>ExecuteCommand</code> to execute let&rsquo;s say <code>gc</code> the call will return only when you encounter any sort of break. If you don&rsquo;t encounter any break, the call will never end.</p>

<h2>Setting breakpoints</h2>

<p>Settings breakpoints is basically handled by three different APIs: <code>SetBreakpointAtSourceLocation</code>, <code>SetBreakpointAtOffset</code>, and <code>SetBreakpointForReadWrite</code>. The names are pretty self-explanatory so I will not spend much time describing them. Unfortunately, as far as I can tell there is no easy way to bind a breakpoint to a Javascript function that could handle it when it is hit. The objects returned by these APIs have a <code>Command</code> field you can use to trigger a <em>command</em> when the breakpoint fires, as opposed to a function invocation.  In essence, it is pretty much the same than when you do <code>bp foo "command"</code>.</p>

<p>Hopefully these APIs will become more powerful and more suited for scripting in future versions with the possibility of invoking a Javascript function when triggered, that would pass an object to the function describing why and where the breakpoint triggered, etc.</p>

<p>Here is a simple example:</p>

<figure class='code'><figcaption><span>breakpoint.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="s2">&quot;use strict&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">let</span> <span class="nx">logln</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">host</span><span class="p">.</span><span class="nx">diagnostics</span><span class="p">.</span><span class="nx">debugLog</span><span class="p">(</span><span class="nx">e</span> <span class="o">+</span> <span class="s1">&#39;\n&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">handle_bp</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">let</span> <span class="nx">Regs</span> <span class="o">=</span> <span class="nx">host</span><span class="p">.</span><span class="nx">currentThread</span><span class="p">.</span><span class="nx">Registers</span><span class="p">.</span><span class="nx">User</span><span class="p">;</span>
</span><span class='line'>    <span class="kd">let</span> <span class="nx">Args</span> <span class="o">=</span> <span class="p">[</span> <span class="nx">Regs</span><span class="p">.</span><span class="nx">rcx</span><span class="p">,</span> <span class="nx">Regs</span><span class="p">.</span><span class="nx">rdx</span><span class="p">,</span> <span class="nx">Regs</span><span class="p">.</span><span class="nx">r8</span> <span class="p">];</span>
</span><span class='line'>    <span class="kd">let</span> <span class="nx">ArgsS</span> <span class="o">=</span> <span class="nx">Args</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">c</span> <span class="o">=&gt;</span> <span class="nx">c</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
</span><span class='line'>    <span class="kd">let</span> <span class="nx">HeapHandle</span> <span class="o">=</span> <span class="nx">ArgsS</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span><span class='line'>    <span class="kd">let</span> <span class="nx">Flags</span> <span class="o">=</span> <span class="nx">ArgsS</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span><span class='line'>    <span class="kd">let</span> <span class="nx">Size</span> <span class="o">=</span> <span class="nx">ArgsS</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span><span class='line'>    <span class="nx">logln</span><span class="p">(</span><span class="s1">&#39;RtlAllocateHeap: HeapHandle: &#39;</span> <span class="o">+</span> <span class="nx">HeapHandle</span> <span class="o">+</span> <span class="s1">&#39;, Flags: &#39;</span> <span class="o">+</span> <span class="nx">Flags</span> <span class="o">+</span> <span class="s1">&#39;, Size: &#39;</span> <span class="o">+</span> <span class="nx">Size</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">invokeScript</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">let</span> <span class="nx">Control</span> <span class="o">=</span> <span class="nx">host</span><span class="p">.</span><span class="nx">namespace</span><span class="p">.</span><span class="nx">Debugger</span><span class="p">.</span><span class="nx">Utility</span><span class="p">.</span><span class="nx">Control</span><span class="p">;</span>
</span><span class='line'>    <span class="kd">let</span> <span class="nx">Regs</span> <span class="o">=</span> <span class="nx">host</span><span class="p">.</span><span class="nx">currentThread</span><span class="p">.</span><span class="nx">Registers</span><span class="p">.</span><span class="nx">User</span><span class="p">;</span>
</span><span class='line'>    <span class="kd">let</span> <span class="nx">CurrentProcess</span> <span class="o">=</span> <span class="nx">host</span><span class="p">.</span><span class="nx">currentProcess</span><span class="p">;</span>
</span><span class='line'>    <span class="kd">let</span> <span class="nx">BreakpointAlreadySet</span> <span class="o">=</span> <span class="nx">CurrentProcess</span><span class="p">.</span><span class="nx">Debug</span><span class="p">.</span><span class="nx">Breakpoints</span><span class="p">.</span><span class="nx">Any</span><span class="p">(</span>
</span><span class='line'>        <span class="nx">c</span> <span class="o">=&gt;</span> <span class="nx">c</span><span class="p">.</span><span class="nx">OffsetExpression</span> <span class="o">==</span> <span class="s1">&#39;ntdll!RtlAllocateHeap+0x0&#39;</span>
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="nx">BreakpointAlreadySet</span> <span class="o">==</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">let</span> <span class="nx">Bp</span> <span class="o">=</span> <span class="nx">Control</span><span class="p">.</span><span class="nx">SetBreakpointAtOffset</span><span class="p">(</span><span class="s1">&#39;RtlAllocateHeap&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;ntdll&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">Bp</span><span class="p">.</span><span class="nx">Command</span> <span class="o">=</span> <span class="s1">&#39;.echo doare; dx @$scriptContents.handle_bp(); gc&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">logln</span><span class="p">(</span><span class="s1">&#39;Breakpoint already set.&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="nx">logln</span><span class="p">(</span><span class="s1">&#39;Press &quot;g&quot; to run the target.&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="c1">// let Lines = Control.ExecuteCommand(&#39;gc&#39;);</span>
</span><span class='line'>    <span class="c1">// for(let Line of Lines) {</span>
</span><span class='line'>    <span class="c1">//     logln(&#39;Line: &#39; + Line);</span>
</span><span class='line'>    <span class="c1">// }</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This gives:</p>

<figure class='code'><figcaption><span>breakpoint.js output</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>0:000&gt;
</span><span class='line'>Press &quot;g&quot; to run the target.
</span><span class='line'>0:000&gt; g-
</span><span class='line'>doare
</span><span class='line'>RtlAllocateHeap: HeapHandle: 0x21b5dcd0000, Flags: 0x140000, Size: 0x82
</span><span class='line'>@$scriptContents.handle_bp()
</span><span class='line'>doare
</span><span class='line'>RtlAllocateHeap: HeapHandle: 0x21b5dcd0000, Flags: 0x140000, Size: 0x9a
</span><span class='line'>@$scriptContents.handle_bp()
</span><span class='line'>doare
</span><span class='line'>RtlAllocateHeap: HeapHandle: 0x21b5dcd0000, Flags: 0x140000, Size: 0x40
</span><span class='line'>@$scriptContents.handle_bp()
</span><span class='line'>doare
</span><span class='line'>RtlAllocateHeap: HeapHandle: 0x21b5dcd0000, Flags: 0x140000, Size: 0x38
</span><span class='line'>@$scriptContents.handle_bp()
</span><span class='line'>doare
</span><span class='line'>RtlAllocateHeap: HeapHandle: 0x21b5dcd0000, Flags: 0x0, Size: 0x48
</span><span class='line'>@$scriptContents.handle_bp()
</span><span class='line'>...
</span></code></pre></td></tr></table></div></figure>


<p>Now, I find this interface not well suited for scenarios where you need to have a breakpoint that just dumps stuff and keep going, but hopefully in the future this will improve. Let&rsquo;s say you have a function and you’re interested in dumping its arguments/state every time it gets called. If you attempt to do this with the above code, every time the breakpoint is hit the debugger will execute your callback <em>and</em> stop. At this point you have to tell it to keep executing. (Also, feel free to uncomment the last lines of the script to see what happens if you <code>ExecuteCommand('gc')</code> :&ndash;)).</p>

<p>One way I found around this limitation is to use evaluation and the <code>bp</code> command:</p>

<figure class='code'><figcaption><span>breakpoint2.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="s2">&quot;use strict&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">let</span> <span class="nx">logln</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">host</span><span class="p">.</span><span class="nx">diagnostics</span><span class="p">.</span><span class="nx">debugLog</span><span class="p">(</span><span class="nx">e</span> <span class="o">+</span> <span class="s1">&#39;\n&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">handle_bp</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">let</span> <span class="nx">Regs</span> <span class="o">=</span> <span class="nx">host</span><span class="p">.</span><span class="nx">currentThread</span><span class="p">.</span><span class="nx">Registers</span><span class="p">.</span><span class="nx">User</span><span class="p">;</span>
</span><span class='line'>    <span class="kd">let</span> <span class="nx">Args</span> <span class="o">=</span> <span class="p">[</span><span class="nx">Regs</span><span class="p">.</span><span class="nx">rcx</span><span class="p">,</span> <span class="nx">Regs</span><span class="p">.</span><span class="nx">rdx</span><span class="p">,</span> <span class="nx">Regs</span><span class="p">.</span><span class="nx">r8</span><span class="p">];</span>
</span><span class='line'>    <span class="kd">let</span> <span class="nx">ArgsS</span> <span class="o">=</span> <span class="nx">Args</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">c</span> <span class="o">=&gt;</span> <span class="nx">c</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
</span><span class='line'>    <span class="kd">let</span> <span class="nx">HeapHandle</span> <span class="o">=</span> <span class="nx">ArgsS</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span><span class='line'>    <span class="kd">let</span> <span class="nx">Flags</span> <span class="o">=</span> <span class="nx">ArgsS</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span><span class='line'>    <span class="kd">let</span> <span class="nx">Size</span> <span class="o">=</span> <span class="nx">ArgsS</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span><span class='line'>    <span class="nx">logln</span><span class="p">(</span><span class="s1">&#39;RtlAllocateHeap: HeapHandle: &#39;</span> <span class="o">+</span> <span class="nx">HeapHandle</span> <span class="o">+</span> <span class="s1">&#39;, Flags: &#39;</span> <span class="o">+</span> <span class="nx">Flags</span> <span class="o">+</span> <span class="s1">&#39;, Size: &#39;</span> <span class="o">+</span> <span class="nx">Size</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="nx">Args</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nx">compareTo</span><span class="p">(</span><span class="mh">0x100</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// stop execution if the allocation size is bigger than 0x100</span>
</span><span class='line'>        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="c1">// keep the execution going if it&#39;s a small size</span>
</span><span class='line'>    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">invokeScript</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">let</span> <span class="nx">Control</span> <span class="o">=</span> <span class="nx">host</span><span class="p">.</span><span class="nx">namespace</span><span class="p">.</span><span class="nx">Debugger</span><span class="p">.</span><span class="nx">Utility</span><span class="p">.</span><span class="nx">Control</span><span class="p">;</span>
</span><span class='line'>    <span class="kd">let</span> <span class="nx">Regs</span> <span class="o">=</span> <span class="nx">host</span><span class="p">.</span><span class="nx">currentThread</span><span class="p">.</span><span class="nx">Registers</span><span class="p">.</span><span class="nx">User</span><span class="p">;</span>
</span><span class='line'>    <span class="kd">let</span> <span class="nx">CurrentProcess</span> <span class="o">=</span> <span class="nx">host</span><span class="p">.</span><span class="nx">currentProcess</span><span class="p">;</span>
</span><span class='line'>    <span class="kd">let</span> <span class="nx">HeapAlloc</span> <span class="o">=</span> <span class="nx">host</span><span class="p">.</span><span class="nx">getModuleSymbolAddress</span><span class="p">(</span><span class="s1">&#39;ntdll&#39;</span><span class="p">,</span> <span class="s1">&#39;RtlAllocateHeap&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="kd">let</span> <span class="nx">BreakpointAlreadySet</span> <span class="o">=</span> <span class="nx">CurrentProcess</span><span class="p">.</span><span class="nx">Debug</span><span class="p">.</span><span class="nx">Breakpoints</span><span class="p">.</span><span class="nx">Any</span><span class="p">(</span>
</span><span class='line'>        <span class="nx">c</span> <span class="o">=&gt;</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Address</span> <span class="o">==</span> <span class="nx">HeapAlloc</span>
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="nx">BreakpointAlreadySet</span> <span class="o">==</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">logln</span><span class="p">(</span><span class="s1">&#39;RltAllocateHeap @ &#39;</span> <span class="o">+</span> <span class="nx">HeapAlloc</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
</span><span class='line'>        <span class="nx">Control</span><span class="p">.</span><span class="nx">ExecuteCommand</span><span class="p">(</span><span class="s1">&#39;bp /w &quot;@$scriptContents.handle_bp()&quot; &#39;</span> <span class="o">+</span> <span class="nx">HeapAlloc</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">logln</span><span class="p">(</span><span class="s1">&#39;Breakpoint already set.&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="nx">logln</span><span class="p">(</span><span class="s1">&#39;Press &quot;g&quot; to run the target.&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Which gives this output:</p>

<figure class='code'><figcaption><span>breakpoint2.js output</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>0:000&gt;
</span><span class='line'>RltAllocateHeap @ 0x7fffc07587a0
</span><span class='line'>Press &quot;g&quot; to run the target.
</span><span class='line'>0:000&gt; g
</span><span class='line'>RtlAllocateHeap: HeapHandle: 0x21b5dcd0000, Flags: 0x0, Size: 0x48
</span><span class='line'>RtlAllocateHeap: HeapHandle: 0x21b5dcd0000, Flags: 0x140000, Size: 0x38
</span><span class='line'>...
</span><span class='line'>RtlAllocateHeap: HeapHandle: 0x21b5dcd0000, Flags: 0x140000, Size: 0x34a
</span><span class='line'>Breakpoint 0 hit
</span><span class='line'>Time Travel Position: 2A51:314
</span><span class='line'>ntdll!RtlAllocateHeap:
</span><span class='line'>00007fff`c07587a0 48895c2408      mov     qword ptr [rsp+8],rbx ss:000000b8`7f39e9a0=000000b87f39e9b0
</span></code></pre></td></tr></table></div></figure>


<p>Of course, yet another way of approaching this problem would be to wrap the script invocation into the command of a breakpoint like this:</p>

<figure class='code'><figcaption><span>bp & .scriptrun</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>bp ntdll!RtlAllocateHeap &quot;.scriptrun c:\foo\script.js&quot;
</span></code></pre></td></tr></table></div></figure>


<h2>TTD</h2>

<p>For those who are not familiar with Microsoft’s &ldquo;Time Travel Debugging&rdquo; toolset, in a nutshell it allows you to record the execution of a process. Once the recording is done, you end up with a trace file written to disk that you can load into the debugger to replay what you just recorded &mdash; a bit like a camera / VCR. If you want to learn more about it, I would highly recommend checking out this presentation: <a href="https://cppcon2017.sched.com/event/Bgsj/time-travel-debugging-root-causing-bugs-in-commercial-scale-software">Time Travel Debugging: root causing bugs in commercial scale software</a>.</p>

<p>Even though I won’t cover how recording and replaying a <em>TTD</em> trace in this article, I just wanted to show you in this part how powerful such features can be once coupled with the data model. As you have probably realized by now, the data model is all about extensibility: you can access specific <em>TTD</em> features via the model when you have a trace loaded in the debugger. This section tries to describe them.</p>

<h3>TTD.Calls</h3>

<p>The first feature I wanted to talked about is <code>TTD.Calls</code>. This API goes through an entire execution trace and finds every unique point in the trace where an API has been called.</p>

<figure class='code'><figcaption><span>TTD.Calls description</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>0:000&gt; dx -v @$cursession.TTD
</span><span class='line'>@$cursession.TTD                 : [object Object]
</span><span class='line'>    Calls            [Returns call information from the trace for the specified set of symbols: TTD.Calls(&quot;module!symbol1&quot;, &quot;module!symbol2&quot;, ...)]
</span></code></pre></td></tr></table></div></figure>


<p>For each of those points, you have an object describing the call: time travel position (that you can travel to: see <code>TimeStart</code> and <code>TimeEnd</code> below), parameters (leveraging symbols if you have any to know how many parameters the API expects), return value, the thread id, etc.</p>

<p>Here is what it looks like:</p>

<figure class='code'><figcaption><span>TTD.Calls object</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>0:000&gt; dx -r1 @$cursession.TTD.Calls(&quot;ntdll!RtlAllocateHeap&quot;).Count()
</span><span class='line'>@$cursession.TTD.Calls(&quot;ntdll!RtlAllocateHeap&quot;).Count() : 0x267
</span><span class='line'>0:000&gt; dx @$cursession.TTD.Calls(&quot;ntdll!RtlAllocateHeap&quot;).First()
</span><span class='line'>@$cursession.TTD.Calls(&quot;ntdll!RtlAllocateHeap&quot;).First()
</span><span class='line'>    EventType        : Call
</span><span class='line'>    ThreadId         : 0x1004
</span><span class='line'>    UniqueThreadId   : 0x6
</span><span class='line'>    TimeStart        : 12C1:265 [Time Travel]
</span><span class='line'>    TimeEnd          : 12DE:DC [Time Travel]
</span><span class='line'>    Function         : ntdll!RtlAllocateHeap
</span><span class='line'>    FunctionAddress  : 0x7fffc07587a0
</span><span class='line'>    ReturnAddress    : 0x7fffbdcd9cc1
</span><span class='line'>    ReturnValue      : 0x21b5df71980
</span><span class='line'>    Parameters
</span><span class='line'>0:000&gt; dx -r1 @$cursession.TTD.Calls(&quot;ntdll!RtlAllocateHeap&quot;).First().Parameters
</span><span class='line'>@$cursession.TTD.Calls(&quot;ntdll!RtlAllocateHeap&quot;).First().Parameters
</span><span class='line'>    [0x0]            : 0x21b5df70000
</span><span class='line'>    [0x1]            : 0x8
</span><span class='line'>    [0x2]            : 0x2d8
</span><span class='line'>    [0x3]            : 0x57
</span></code></pre></td></tr></table></div></figure>


<p>Obviously, the collection returned by <code>TTD.Calls</code> can be queried via the same <a href="https://docs.microsoft.com/en-us/dotnet/csharp/linq/query-expression-basics">LINQ</a>-like operators we mentioned earlier which is awesome. As an example, asking the following question has never been easier: &ldquo;How many times did the allocator fail to allocate memory?&rdquo;:</p>

<figure class='code'><figcaption><span>TTD.Calls query</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>0:000&gt; dx @$Calls=@$cursession.TTD.Calls(&quot;ntdll!RtlAllocateHeap&quot;).Where(c =&gt; c.ReturnValue == 0)
</span><span class='line'>@$Calls=@$cursession.TTD.Calls(&quot;ntdll!RtlAllocateHeap&quot;).Where(c =&gt; c.ReturnValue == 0)
</span><span class='line'>0:000&gt; dx @$Calls.Count()
</span><span class='line'>@$Calls.Count()  : 0x0
</span></code></pre></td></tr></table></div></figure>


<p>Note that because the API has been designed in a way that abstracts away ABI-specific details, you can have your query / code working on both x86 &amp; x64 seamlessly. Another important point is that this is much faster than setting a breakpoint manually and running the trace forward to collect this information yourself.</p>

<h3>TTD.Memory</h3>

<p>The other <strong>very</strong> powerful feature that was announced fairly <a href="https://blogs.msdn.microsoft.com/windbg/2017/12/18/windbg-preview-1-1712-15003-release-notes/">recently</a> in version 1.1712.15003 is <code>TTD.Memory</code>. A bit like <code>TTD.Calls</code>, this feature lets you go and find every memory accesses that happened in an execution trace on a specific memory range. And again, it returns to the user a nice object that has all the information you could be potentially interested in (time travel positions, access type, the instruction pointer address, the address of the memory accessed, etc.):</p>

<figure class='code'><figcaption><span>TTD.Memory object</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>0:000&gt; dx @$Accesses[0]
</span><span class='line'>@$Accesses[0]
</span><span class='line'>    EventType        : MemoryAccess
</span><span class='line'>    ThreadId         : 0x15e8
</span><span class='line'>    UniqueThreadId   : 0x3
</span><span class='line'>    TimeStart        : F44:2 [Time Travel]
</span><span class='line'>    TimeEnd          : F44:2 [Time Travel]
</span><span class='line'>    AccessType       : Write
</span><span class='line'>    IP               : 0x7fffc07649bf
</span><span class='line'>    Address          : 0xb87f67fa70
</span><span class='line'>    Size             : 0x4
</span><span class='line'>    Value            : 0x0
</span></code></pre></td></tr></table></div></figure>


<p>Here is how you would go and ask it to find out every piece of code that write-accessed (read and execute are also other valid type of access you can query for and combine) the TEB region of the current thread:</p>

<figure class='code'><figcaption><span>TTD.Memory write-access TEB</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>0:001&gt; ? @$teb
</span><span class='line'>Evaluate expression: 792409825280 = 000000b8`7f4e6000
</span><span class='line'>0:001&gt; ?? sizeof(_TEB)
</span><span class='line'>unsigned int64 0x1838
</span><span class='line'>0:001&gt; dx @$Accesses=@$cursession.TTD.Memory(0x000000b8`7f4e6000, 0x000000b8`7f4e6000+0x1838, &quot;w&quot;)
</span><span class='line'>@$Accesses=@$cursession.TTD.Memory(0x000000b8`7f4e6000, 0x000000b8`7f4e6000+0x1838, &quot;w&quot;)
</span><span class='line'>0:001&gt; dx @$Accesses[0]
</span><span class='line'>@$Accesses[0]
</span><span class='line'>    EventType        : MemoryAccess
</span><span class='line'>    ThreadId         : 0x15e8
</span><span class='line'>    UniqueThreadId   : 0x3
</span><span class='line'>    TimeStart        : F79:1B [Time Travel]
</span><span class='line'>    TimeEnd          : F79:1B [Time Travel]
</span><span class='line'>    AccessType       : Write
</span><span class='line'>    IP               : 0x7fffc0761bd0
</span><span class='line'>    Address          : 0xb87f4e7710
</span><span class='line'>    Size             : 0x10
</span><span class='line'>    Value            : 0x0
</span></code></pre></td></tr></table></div></figure>


<p>The other beauty of it is that you can travel to the position ID and find out what happened:</p>

<figure class='code'><figcaption><span>time traveling!</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>0:001&gt; !tt F79:1B
</span><span class='line'>Setting position: F79:1B
</span><span class='line'>(1cfc.15e8): Break instruction exception - code 80000003 (first/second chance not available)
</span><span class='line'>Time Travel Position: F79:1B
</span><span class='line'>ntdll!TppWorkCallbackPrologRelease+0x100:
</span><span class='line'>00007fff`c0761bd0 f30f7f8010170000 movdqu  xmmword ptr [rax+1710h],xmm0 ds:000000b8`7f4e7710=00000000000000000000000000000000
</span><span class='line'>
</span><span class='line'>0:001&gt; dt _TEB ActivityId
</span><span class='line'>ntdll!_TEB
</span><span class='line'>   +0x1710 ActivityId : _GUID
</span></code></pre></td></tr></table></div></figure>


<p>In the above example, you can see that the <code>TppWorkCallbackPrologRelease</code> function is zeroing the <code>ActivityId</code> GUID of the current TEB &ndash; magical.</p>

<h3>TTD.Utility.GetHeapAddress</h3>

<p>The two previous features were mostly building blocks; this utility consumes the <code>TTD.Calls</code> API in order to show the lifetime of a heap chunk in a trace session. What does that mean exactly? Well, the utility looks for every heap related operation that happened on a chunk (start address, size) and show them to you.</p>

<p>This is extremely useful when debugging or root-causing issues, and here is what it looks like on a dummy trace:</p>

<figure class='code'><figcaption><span>GetHeapAddress demo</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>0:000&gt; dx -g @$cursession.TTD.Utility.GetHeapAddress(0x21b5dce40a0)
</span><span class='line'>========================================================================================================================================
</span><span class='line'>=                           = Action   = Heap             = Address          = Size    = Flags  = (+) TimeStart = (+) TimeEnd = Result =
</span><span class='line'>========================================================================================================================================
</span><span class='line'>= [0x59] : [object Object]  - Alloc    - 0x21b5dcd0000    - 0x21b5dce4030    - 0xaa    - 0x8    - ED:7D7        - EF:7D       -        =
</span><span class='line'>= [0x6b] : [object Object]  - Alloc    - 0x21b5dcd0000    - 0x21b5dce40a0    - 0xaa    - 0x8    - 105:D9        - 107:7D      -        =
</span><span class='line'>= [0x6c] : [object Object]  - Free     - 0x21b5dcd0000    - 0x21b5dce40a0    -         - 0x0    - 107:8D        - 109:1D      - 0x1    =
</span><span class='line'>= [0x276] : [object Object] - Alloc    - 0x21b5dcd0000    - 0x21b5dce4030    - 0x98    - 0x0    - E59:3A7       - E5A:8E      -        =
</span><span class='line'>========================================================================================================================================
</span></code></pre></td></tr></table></div></figure>


<p>The attentive reader has probably noticed something maybe unexpected with entries 0x59 and entries 0x276 where we are seeing two different allocations of the same chunk without any free in between. The answer to this question lies in the way the <code>GetHeapAddress</code> function is implemented (check out the <em>TTD\Analyzers\HeapAnalysis.js</em> file) &ndash; it basically looks for every heap related operation and only shows you the ones where <code>address + size</code> is a range containing the argument you passed. In this example we gave the function the address <code>0x21b5dce40a0</code>, 0x59 is an allocation and <code>0x21b5dce40a0</code> is in the range <code>0x21b5dce4030 + 0xAA</code> so we display it. Now, a free does not know the size of the chunk, the only thing it knows is the base pointer. In this case if we have a free of <code>0x21b5dce4030</code> the utility function would just not display it to us which explains how we can have two heap chunks allocated without a free in the following time frame: <code>ED:7D7, E59:3A7</code>.</p>

<p>We can even go ahead and prove this by finding the free by running the below command:</p>

<figure class='code'><figcaption><span>GetHeapAddress finding the free of 0x21b5dce4030</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>0:000&gt; dx -g @$cursession.TTD.Utility.GetHeapAddress(0x21b5dce4030).Where(p =&gt; p.Address == 0x21b5dce4030)
</span><span class='line'>========================================================================================================================================
</span><span class='line'>=                           = Action   = Heap             = Address          = Size    = Flags  = (+) TimeStart = (+) TimeEnd = Result =
</span><span class='line'>========================================================================================================================================
</span><span class='line'>= [0x61] : [object Object]  - Alloc    - 0x21b5dcd0000    - 0x21b5dce4030    - 0xaa    - 0x8    - ED:7D7        - EF:7D       -        =
</span><span class='line'>= [0x64] : [object Object]  - Free     - 0x21b5dcd0000    - 0x21b5dce4030    -         - 0x0    - EF:247        - F1:1D       - 0x1    =
</span><span class='line'>= [0x276] : [object Object] - Alloc    - 0x21b5dcd0000    - 0x21b5dce4030    - 0x98    - 0x0    - E59:3A7       - E5A:8E      -        =
</span><span class='line'>========================================================================================================================================
</span></code></pre></td></tr></table></div></figure>


<p>As expected, the entry 0x64 is our free operation and it also happens in between the two allocation operations we were seeing earlier &ndash; solved.</p>

<p>Pretty neat uh?</p>

<p>It is nice enough to ask the utility for a specific heap address, but it would also be super nice if we had access to the whole heap activity that has happened during the session and that is what <code>TTD.Data.Heap</code> gives you:</p>

<figure class='code'><figcaption><span>TTD.Data.Heap demo</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>0:000&gt; dx @$HeapOps=@$cursession.TTD.Data.Heap()
</span><span class='line'>...
</span><span class='line'>0:000&gt; dx @$HeapOps.Count()
</span><span class='line'>@$HeapOps.Count() : 0x414
</span><span class='line'>0:000&gt; dx @$HeapOps[137]
</span><span class='line'>@$HeapOps[137]                 : [object Object]
</span><span class='line'>    Action           : Free
</span><span class='line'>    Heap             : 0x21b5dcd0000
</span><span class='line'>    Address          : 0x21b5dcee790
</span><span class='line'>    Flags            : 0x0
</span><span class='line'>    Result           : 0x1
</span><span class='line'>    TimeStart        : 13A1:184 [Time Travel]
</span><span class='line'>    TimeEnd          : 13A2:27 [Time Travel]
</span></code></pre></td></tr></table></div></figure>


<p>And of course do not forget that all these collections are queryable. We can easily find out what are all the other heap operations that are not <code>alloc</code> or <code>free</code> with the below query:</p>

<figure class='code'><figcaption><span>TTD.Data.Heap() & query</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>0:000&gt; dx @$NoFreeAlloc=@$HeapOps.Where(c =&gt; c.Action != &quot;Free&quot; &amp;&amp; c.Action != &quot;Alloc&quot;)
</span><span class='line'>...
</span><span class='line'>0:000&gt; dx -g @$NoFreeAlloc
</span><span class='line'>============================================================================================================
</span><span class='line'>=                           = Action    = Heap             = Result          = (+) TimeStart = (+) TimeEnd =
</span><span class='line'>============================================================================================================
</span><span class='line'>= [0x382] : [object Object] - Lock      - 0x21b5dcd0000    - 0xb87f4e3001    - 1ADE:602      - 1ADF:14     =
</span><span class='line'>= [0x386] : [object Object] - Unlock    - 0x21b5dcd0000    - 0xb87f4e3001    - 1AE0:64       - 1AE1:13     =
</span><span class='line'>= [0x38d] : [object Object] - Lock      - 0x21b5dcd0000    - 0xb87f4e3001    - 1B38:661      - 1B39:14     =
</span><span class='line'>= [0x391] : [object Object] - Unlock    - 0x21b5dcd0000    - 0xb87f4e3001    - 1B3A:64       - 1B3B:13     =
</span><span class='line'>= [0x397] : [object Object] - Lock      - 0x21b5dcd0000    - 0xb87f4e3001    - 1BF0:5F4      - 1BF1:14     =
</span><span class='line'>= [0x399] : [object Object] - Unlock    - 0x21b5dcd0000    - 0xb87f4e3001    - 1BF1:335      - 1C1E:13     =
</span><span class='line'>...
</span></code></pre></td></tr></table></div></figure>


<h2>Extend the data model</h2>

<p>After consuming all the various features available in the data model, I am sure you guys are wondering how you can go and add your own node and extend it. In order to do this, you can use the API <code>host.namedModelParent</code>.</p>

<figure class='code'><figcaption><span>host.namedModelParent</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>class host.namedModelParent
</span><span class='line'>
</span><span class='line'>An object representing a modification of the object model of the debugger.
</span><span class='line'>This links together a JavaScript class (or prototype) with a data model.
</span><span class='line'>The JavaScript class (or prototype) becomes a parent data model (e.g.: similar to a prototype)
</span><span class='line'>to the data model registered under the supplied name.
</span><span class='line'>
</span><span class='line'>An instance of this object can be returned in the array of records returned from
</span><span class='line'>the initializeScript method.
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s say we would like to add a node that is associated with a <code>Process</code> called <code>DiaryOfAReverseEngineer</code> which has the following properties:</p>

<ul>
<li>DiaryOfAReverseEngineer

<ul>
<li>Foo &ndash; string</li>
<li>Bar &ndash; string</li>
<li>Add &ndash; function</li>
<li>Sub

<ul>
<li>SubBar &ndash; string</li>
<li>SubFoo &ndash; string</li>
</ul>
</li>
</ul>
</li>
</ul>


<h3>Step 1: Attach a node to the <code>Process</code> model</h3>

<p>Using <code>host.namedModelParent</code> you get the opportunity to link a Javascript class to the model of your choice. The other thing to understand is that this feature is made to be used by <em>extension</em> (as opposed to imperative) scripts.</p>

<p>Extension and imperative scripts are basically the same but they have different entry points: extensions use <code>initializeScript</code> (the command <code>.scriptload</code> invokes this entry point) and imperative scripts use <code>invokeScript</code> (the command <code>.scriptrun</code> invokes both the <code>initializeScript</code> and <code>invokeScript</code>). The small difference is that in an extension script you are expected to return an array of <em>registration</em> objects if you want to modify the data model, which is exactly what we want to do.</p>

<p>Anyway, let&rsquo;s attach a node called <code>DiaryOfAReverseEngineer</code> to the <code>Process</code> model:</p>

<figure class='code'><figcaption><span>extendmodel_1.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="s2">&quot;use strict&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kr">class</span> <span class="nx">ProcessModelParent</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">get</span> <span class="nx">DiaryOfAReverseEngineer</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="s1">&#39;hello from &#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">Name</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">initializeScript</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">[</span><span class="k">new</span> <span class="nx">host</span><span class="p">.</span><span class="nx">namedModelParent</span><span class="p">(</span>
</span><span class='line'>        <span class="nx">ProcessModelParent</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;Debugger.Models.Process&#39;</span>
</span><span class='line'>    <span class="p">)];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Once loaded you can go ahead and check that the node has been added:</p>

<figure class='code'><figcaption><span>hello new node</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>0:000&gt; dx @$curprocess
</span><span class='line'>@$curprocess                 : PING.EXE [Switch To]
</span><span class='line'>    Name             : PING.EXE
</span><span class='line'>    Id               : 0x1cfc
</span><span class='line'>    Threads
</span><span class='line'>    Modules
</span><span class='line'>    Environment
</span><span class='line'>    TTD
</span><span class='line'>    DiaryOfAReverseEngineer : hello from PING.EXE
</span></code></pre></td></tr></table></div></figure>


<p>One important thing to be aware of in the previous example is that the <code>this</code> pointer is effectively an instance of the data model you attached to. In our case it is an instance of the <code>Process</code> model and as a result you can access every property available on this node, like its <code>Name</code> for example.</p>

<h3>Step 2: Add the first level to the node</h3>

<p>What we want to do now is to have our top node exposing two string properties and one function (we’ll deal with <code>Sub</code> later). This is done by creating a new Javascript class that represents this level, and we can return an instance of this said class in the <code>DiaryOfReverseEngineer</code> property. Simple enough uh?</p>

<figure class='code'><figcaption><span>extendmodel_2.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="s2">&quot;use strict&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kr">class</span> <span class="nx">DiaryOfAReverseEngineer</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">constructor</span><span class="p">(</span><span class="nx">Process</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="nx">process</span> <span class="o">=</span> <span class="nx">Process</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">get</span> <span class="nx">Foo</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="s1">&#39;Foo from &#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">process</span><span class="p">.</span><span class="nx">Name</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">get</span> <span class="nx">Bar</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="s1">&#39;Bar from &#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">process</span><span class="p">.</span><span class="nx">Name</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">Add</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">a</span> <span class="o">+</span> <span class="nx">b</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kr">class</span> <span class="nx">ProcessModelParent</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">get</span> <span class="nx">DiaryOfAReverseEngineer</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="nx">DiaryOfAReverseEngineer</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">initializeScript</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">[</span><span class="k">new</span> <span class="nx">host</span><span class="p">.</span><span class="nx">namedModelParent</span><span class="p">(</span>
</span><span class='line'>        <span class="nx">ProcessModelParent</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;Debugger.Models.Process&#39;</span>
</span><span class='line'>    <span class="p">)];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Which gives:</p>

<figure class='code'><figcaption><span>DiaryOfAReverseEngineer is now a node with properties</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>0:000&gt; dx @$curprocess
</span><span class='line'>@$curprocess                 : PING.EXE [Switch To]
</span><span class='line'>    Name             : PING.EXE
</span><span class='line'>    Id               : 0x1cfc
</span><span class='line'>    Threads
</span><span class='line'>    Modules
</span><span class='line'>    Environment
</span><span class='line'>    TTD
</span><span class='line'>    DiaryOfAReverseEngineer : [object Object]
</span><span class='line'>0:000&gt; dx @$curprocess.DiaryOfAReverseEngineer
</span><span class='line'>@$curprocess.DiaryOfAReverseEngineer                 : [object Object]
</span><span class='line'>    process          : PING.EXE [Switch To]
</span><span class='line'>    Foo              : Foo from PING.EXE
</span><span class='line'>    Bar              : Bar from PING.EXE
</span></code></pre></td></tr></table></div></figure>


<p>From the previous dumps there are at least two things we can do better:</p>

<p>1) The <code>DiaryOfAReverseEngineer</code> node has a string representation of <code>[object Object]</code> which is not great. In order to fix that we can just define our own <code>toString</code> method and return what we want.</p>

<p>2) When displaying the <code>DiaryOfAReverseEngineer</code> node, it displays the instance properties <code>process</code> where we keep a copy of the <code>Process</code> model we attached to. Now, this might be something you want to hide to the user as it has nothing to do with whatever this node is supposed to be about. To solve that, we just have to prefix the field with <code>__</code>.</p>

<p>(If you are wondering why we do not see the method <code>Add</code> you can force <code>dx</code> to display it with the <code>-v</code> flag.)</p>

<p>After fixing the two above points, here is what we have:</p>

<figure class='code'><figcaption><span>extendmodel_2_1.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="s2">&quot;use strict&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kr">class</span> <span class="nx">DiaryOfAReverseEngineer</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">constructor</span><span class="p">(</span><span class="nx">Process</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="nx">__process</span> <span class="o">=</span> <span class="nx">process</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">get</span> <span class="nx">Foo</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="s1">&#39;Foo from &#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">__process</span><span class="p">.</span><span class="nx">Name</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">get</span> <span class="nx">Bar</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="s1">&#39;Bar from &#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">__process</span><span class="p">.</span><span class="nx">Name</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">Add</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">a</span> <span class="o">+</span> <span class="nx">b</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">toString</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="s1">&#39;Diary of a reverse-engineer&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kr">class</span> <span class="nx">ProcessModelParent</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">get</span> <span class="nx">DiaryOfAReverseEngineer</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="nx">DiaryOfAReverseEngineer</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">initializeScript</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">[</span><span class="k">new</span> <span class="nx">host</span><span class="p">.</span><span class="nx">namedModelParent</span><span class="p">(</span>
</span><span class='line'>        <span class="nx">ProcessModelParent</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;Debugger.Models.Process&#39;</span>
</span><span class='line'>    <span class="p">)];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And now if we display the <code>Process</code> model:</p>

<figure class='code'><figcaption><span>Hiding process & adding a toString</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>0:000&gt; dx @$curprocess
</span><span class='line'>@$curprocess                 : PING.EXE [Switch To]
</span><span class='line'>    Name             : PING.EXE
</span><span class='line'>    Id               : 0x1cfc
</span><span class='line'>    Threads
</span><span class='line'>    Modules
</span><span class='line'>    Environment
</span><span class='line'>    TTD
</span><span class='line'>    DiaryOfAReverseEngineer : Diary of a reverse-engineer
</span><span class='line'>0:000&gt; dx @$curprocess.DiaryOfAReverseEngineer
</span><span class='line'>@$curprocess.DiaryOfAReverseEngineer                 : Diary of a reverse-engineer
</span><span class='line'>    Foo              : Foo from PING.EXE
</span><span class='line'>    Bar              : Bar from PING.EXE
</span><span class='line'>0:000&gt; dx @$curprocess.DiaryOfAReverseEngineer.Add(1, 2)
</span><span class='line'>@$curprocess.DiaryOfAReverseEngineer.Add(1, 2) : 0x3
</span></code></pre></td></tr></table></div></figure>


<h3>Step 3: Adding another level and an iterable class</h3>

<p>At this stage, I am pretty sure that you guys are starting to get the hang of it. In order to add a new level, you can just define yet another class, define a property in the <code>DiaryOfAReverseEngineer</code> class and return an instance of it. And that&rsquo;s basically it.</p>

<p>The last concept I wanted to touch on before moving on is how to add the <code>iterable</code> property on one of your data model classes. Let&rsquo;s say you have a class called <code>Attribute</code> that stores a key and a value, and let&rsquo;s also say you have another class called <code>Attributes</code> that is an <code>Attribute</code> store. The thing is, you might have noticed that one class instance usually corresponds to a node with its own properties in the data model view. This is not great for our <code>Attributes</code> class as it is basically an array of <code>Attribute</code> objects, meaning that we will have two copies of everything..</p>

<p>If you want to have the debugger be able to iterate on your instance you can define a <code>*[Symbol.iterator]()</code> method like this:</p>

<figure class='code'><figcaption><span>Attributes iterable</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kr">class</span> <span class="nx">Attribute</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">constructor</span><span class="p">(</span><span class="nx">Process</span><span class="p">,</span> <span class="nx">Name</span><span class="p">,</span> <span class="nx">Value</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="nx">__process</span> <span class="o">=</span> <span class="nx">Process</span><span class="p">;</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="nx">Name</span> <span class="o">=</span> <span class="nx">Name</span><span class="p">;</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="nx">Value</span> <span class="o">=</span> <span class="nx">Value</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">toString</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">let</span> <span class="nx">S</span> <span class="o">=</span> <span class="s1">&#39;Process: &#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">__process</span><span class="p">.</span><span class="nx">Name</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="p">;</span>
</span><span class='line'>        <span class="nx">S</span> <span class="o">+=</span> <span class="s1">&#39;Name: &#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">Name</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="p">;</span>
</span><span class='line'>        <span class="nx">S</span> <span class="o">+=</span> <span class="s1">&#39;Value: &#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">Value</span><span class="p">;</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">S</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kr">class</span> <span class="nx">Attributes</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">constructor</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="nx">__attrs</span> <span class="o">=</span> <span class="p">[];</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">push</span><span class="p">(</span><span class="nx">Attr</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="nx">__attrs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">Attr</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="o">*</span><span class="p">[</span><span class="nx">Symbol</span><span class="p">.</span><span class="nx">iterator</span><span class="p">]()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">Attr</span> <span class="nx">of</span> <span class="k">this</span><span class="p">.</span><span class="nx">__attrs</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">yield</span> <span class="nx">Attr</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">toString</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="s1">&#39;Attributes&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now if we put it all together we have:</p>

<figure class='code'><figcaption><span>extendmodel.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="s2">&quot;use strict&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kr">class</span> <span class="nx">Attribute</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">constructor</span><span class="p">(</span><span class="nx">Process</span><span class="p">,</span> <span class="nx">Name</span><span class="p">,</span> <span class="nx">Value</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="nx">__process</span> <span class="o">=</span> <span class="nx">Process</span><span class="p">;</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="nx">Name</span> <span class="o">=</span> <span class="nx">Name</span><span class="p">;</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="nx">Value</span> <span class="o">=</span> <span class="nx">Value</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">toString</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">let</span> <span class="nx">S</span> <span class="o">=</span> <span class="s1">&#39;Process: &#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">__process</span><span class="p">.</span><span class="nx">Name</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="p">;</span>
</span><span class='line'>        <span class="nx">S</span> <span class="o">+=</span> <span class="s1">&#39;Name: &#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">Name</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="p">;</span>
</span><span class='line'>        <span class="nx">S</span> <span class="o">+=</span> <span class="s1">&#39;Value: &#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">Value</span><span class="p">;</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">S</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kr">class</span> <span class="nx">Attributes</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">constructor</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="nx">__attrs</span> <span class="o">=</span> <span class="p">[];</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">push</span><span class="p">(</span><span class="nx">Attr</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="nx">__attrs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">Attr</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="o">*</span><span class="p">[</span><span class="nx">Symbol</span><span class="p">.</span><span class="nx">iterator</span><span class="p">]()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">Attr</span> <span class="nx">of</span> <span class="k">this</span><span class="p">.</span><span class="nx">__attrs</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">yield</span> <span class="nx">Attr</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">toString</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="s1">&#39;Attributes&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kr">class</span> <span class="nx">Sub</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">constructor</span><span class="p">(</span><span class="nx">Process</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="nx">__process</span> <span class="o">=</span> <span class="nx">Process</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">get</span> <span class="nx">SubFoo</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="s1">&#39;SubFoo from &#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">__process</span><span class="p">.</span><span class="nx">Name</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">get</span> <span class="nx">SubBar</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="s1">&#39;SubBar from &#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">__process</span><span class="p">.</span><span class="nx">Name</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">get</span> <span class="nx">Attributes</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">let</span> <span class="nx">Attrs</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Attributes</span><span class="p">();</span>
</span><span class='line'>        <span class="nx">Attrs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nx">Attribute</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">__process</span><span class="p">,</span> <span class="s1">&#39;attr0&#39;</span><span class="p">,</span> <span class="s1">&#39;value0&#39;</span><span class="p">));</span>
</span><span class='line'>        <span class="nx">Attrs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nx">Attribute</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">__process</span><span class="p">,</span> <span class="s1">&#39;attr1&#39;</span><span class="p">,</span> <span class="s1">&#39;value0&#39;</span><span class="p">));</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">Attrs</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">toString</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="s1">&#39;Sub module&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kr">class</span> <span class="nx">DiaryOfAReverseEngineer</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">constructor</span><span class="p">(</span><span class="nx">Process</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="nx">__process</span> <span class="o">=</span> <span class="nx">Process</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">get</span> <span class="nx">Foo</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="s1">&#39;Foo from &#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">__process</span><span class="p">.</span><span class="nx">Name</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">get</span> <span class="nx">Bar</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="s1">&#39;Bar from &#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">__process</span><span class="p">.</span><span class="nx">Name</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">Add</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">a</span> <span class="o">+</span> <span class="nx">b</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">get</span> <span class="nx">Sub</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="nx">Sub</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">__process</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">toString</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="s1">&#39;Diary of a reverse-engineer&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kr">class</span> <span class="nx">ProcessModelParent</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">get</span> <span class="nx">DiaryOfAReverseEngineer</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="nx">DiaryOfAReverseEngineer</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">initializeScript</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">[</span><span class="k">new</span> <span class="nx">host</span><span class="p">.</span><span class="nx">namedModelParent</span><span class="p">(</span>
</span><span class='line'>        <span class="nx">ProcessModelParent</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;Debugger.Models.Process&#39;</span>
</span><span class='line'>    <span class="p">)];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And we can play with the node in the model:</p>

<figure class='code'><figcaption><span>node is ready!</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>0:000&gt; dx @$curprocess
</span><span class='line'>@$curprocess                 : PING.EXE [Switch To]
</span><span class='line'>    Name             : PING.EXE
</span><span class='line'>    Id               : 0x1cfc
</span><span class='line'>    Threads
</span><span class='line'>    Modules
</span><span class='line'>    Environment
</span><span class='line'>    TTD
</span><span class='line'>    DiaryOfAReverseEngineer : Diary of a reverse-engineer
</span><span class='line'>0:000&gt; dx @$curprocess.DiaryOfAReverseEngineer
</span><span class='line'>@$curprocess.DiaryOfAReverseEngineer                 : Diary of a reverse-engineer
</span><span class='line'>    Foo              : Foo from PING.EXE
</span><span class='line'>    Bar              : Bar from PING.EXE
</span><span class='line'>    Sub              : Sub module
</span><span class='line'>0:000&gt; dx @$curprocess.DiaryOfAReverseEngineer.Sub
</span><span class='line'>@$curprocess.DiaryOfAReverseEngineer.Sub                 : Sub module
</span><span class='line'>    SubFoo           : SubFoo from PING.EXE
</span><span class='line'>    SubBar           : SubBar from PING.EXE
</span><span class='line'>    Attributes       : Attributes
</span><span class='line'>0:000&gt; dx @$curprocess.DiaryOfAReverseEngineer.Sub.Attributes
</span><span class='line'>@$curprocess.DiaryOfAReverseEngineer.Sub.Attributes                 : Attributes
</span><span class='line'>    [0x0]            : Process: PING.EXE, Name: attr0, Value: value0
</span><span class='line'>    [0x1]            : Process: PING.EXE, Name: attr1, Value: value0
</span><span class='line'>0:000&gt; dx @$curprocess.DiaryOfAReverseEngineer.Sub.Attributes[0]
</span><span class='line'>@$curprocess.DiaryOfAReverseEngineer.Sub.Attributes[0]                 : Process: PING.EXE, Name: attr0, Value: value0
</span><span class='line'>    Name             : attr0
</span><span class='line'>    Value            : value0
</span></code></pre></td></tr></table></div></figure>


<p>Another simpler example is available in <a href="https://blogs.msdn.microsoft.com/windbg/2017/04/13/determining-process-architecture-with-javascript-and-linq/">Determining process architecture with JavaScript and LINQ</a> where the author adds a node to the <code>Process</code> node that tells you with which bitness the process is running on, either 64 or 32 bits.</p>

<p>If you want to extend the data model with best practices you should also have a look at <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/native-objects-in-javascript-extensions#design-considerations">Debugger Data Model Design Considerations</a> which sort of lays down various guidelines.</p>

<h2>Misc</h2>

<p>In this section I will try to answer a bunch of other questions and share various tricks that have been useful for me &ndash; you might learn a thing or two!</p>

<h3>Try and play with <code>host.*</code> API from the command window</h3>

<p>One of the things I quickly was bothered with at first is not being able to run my Javascript from the command window. Let&rsquo;s say that you want to play with a <code>host.*</code> API: these are not really directly accessible.</p>

<p>A way to work around that is to load a script and to use the <code>@$scriptContents</code> variable from where you can access the <code>host</code> object.</p>

<figure class='code'><figcaption><span>access host object from command window</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>0:000&gt; dx -v @$scriptContents.host
</span><span class='line'>@$scriptContents.host                 : [object Object]
</span><span class='line'>    currentApiVersionSupported : [object Object]
</span><span class='line'>    currentApiVersionInitialized : [object Object]
</span><span class='line'>    diagnostics      : [object Object]
</span><span class='line'>    metadata         : [object Object]
</span><span class='line'>    typeSignatureRegistration
</span><span class='line'>    typeSignatureExtension
</span><span class='line'>    namedModelRegistration
</span><span class='line'>    namedModelParent
</span><span class='line'>    functionAlias
</span><span class='line'>    namespacePropertyParent
</span><span class='line'>    optionalRecord
</span><span class='line'>    apiVersionSupport
</span><span class='line'>    Int64
</span><span class='line'>    parseInt64
</span><span class='line'>    namespace
</span><span class='line'>    evaluateExpression
</span><span class='line'>    evaluateExpressionInContext
</span><span class='line'>    getModuleSymbol
</span><span class='line'>    getModuleSymbolAddress
</span><span class='line'>    setModuleSymbol
</span><span class='line'>    getModuleType
</span><span class='line'>    createPointerObject
</span><span class='line'>    createTypedObject
</span><span class='line'>    indexedValue
</span><span class='line'>    getNamedModel
</span><span class='line'>    registerNamedModel
</span><span class='line'>    unregisterNamedModel
</span><span class='line'>    registerPrototypeForTypeSignature
</span><span class='line'>    registerExtensionForTypeSignature
</span><span class='line'>    unregisterPrototypeForTypeSignature
</span><span class='line'>    unregisterExtensionForTypeSignature
</span><span class='line'>    currentSession   : Time Travel Debugging Mode
</span><span class='line'>    currentProcess   : PING.EXE [Switch To]
</span><span class='line'>    currentThread    [Switch To]
</span><span class='line'>    memory           : [object Object]
</span><span class='line'>    typeSystem       : [object Object]
</span><span class='line'>    ToDisplayString  [ToDisplayString([FormatSpecifier]) - Method which converts the object to its display string representation according to an optional format specifier]
</span></code></pre></td></tr></table></div></figure>


<p>Note that this is also super useful if you want to wander around and get a feel for the various features / APIs that have not been documented yet (or you were just not aware of).</p>

<h3>How to load an extension script</h3>

<p>The <code>.scriptload</code> command is available in both <em>Windbg Preview</em> and the <em>Windbg</em> from the SDK.</p>

<h3>How to run an imperative script</h3>

<p>Similar to above, you can use the <code>.scriptrun</code> command for that.</p>

<h3>Is the Javascript engine only available in Windbg Preview?</h3>

<p>Nope it is not! You can load your Javascript scripts from the latest SDK&rsquo;s Windbg. You can use the <code>.scriptproviders</code> command to know what the various script providers currently loaded are, and if you do not see the Javascript provider you can just run <code>.load jsprovider.dll</code> to load it.</p>

<figure class='code'><figcaption><span>loading the js provider</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>0:003&gt; .scriptproviders
</span><span class='line'>Available Script Providers:
</span><span class='line'>    NatVis (extension &#39;.NatVis&#39;)
</span><span class='line'>0:003&gt; .load jsprovider.dll
</span><span class='line'>0:003&gt; .scriptproviders
</span><span class='line'>Available Script Providers:
</span><span class='line'>    NatVis (extension &#39;.NatVis&#39;)
</span><span class='line'>    JavaScript (extension &#39;.js&#39;)
</span></code></pre></td></tr></table></div></figure>


<h3>How to debug a script?</h3>

<p>One thing I have not experimented with yet is the <code>.scriptdebug</code> command that lets you debug a script. This is a very important feature as without it it can be a bit of a pain to figure out what is going wrong and where. If you want to know more about this, please refer to <a href="https://blogs.msdn.microsoft.com/windbg/2017/06/30/script-debugging-walkthrough/">Script Debugging Walkthrough</a> from <a href="https://twitter.com/aluhrs13">Andy Luhrs</a>.</p>

<h3>How to do Nat-Vis style <em>visualizer</em> in Javascript?</h3>

<p>I did not cover how to write custom visualizer in Javascript but you should look at <code>host.typeSignatureRegistration</code> to register a class that is responsible for visualizing a type (every property of the class will be used as the main visualizers for the type).</p>

<h3>Get a value out of a typed object</h3>

<p>Sometimes you are accessing a Javascript object that behaves like a structure instance &mdash; you can access its various fields seamlessly (e.g. you want to access the TEB through the <code>EnvironmentBlock</code> object). This is great. However, for various reasons you might need to get the raw value of a field (e.g. for doing arithmetic) and for that you can use the <code>address</code> property:</p>

<figure class='code'><figcaption><span>address property</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="s2">&quot;use strict&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">let</span> <span class="nx">logln</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">host</span><span class="p">.</span><span class="nx">diagnostics</span><span class="p">.</span><span class="nx">debugLog</span><span class="p">(</span><span class="nx">e</span> <span class="o">+</span> <span class="s1">&#39;\n&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">invokeScript</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">let</span> <span class="nx">CurrentThread</span> <span class="o">=</span> <span class="nx">host</span><span class="p">.</span><span class="nx">currentThread</span><span class="p">;</span>
</span><span class='line'>    <span class="kd">let</span> <span class="nx">TEB</span> <span class="o">=</span> <span class="nx">CurrentThread</span><span class="p">.</span><span class="nx">Environment</span><span class="p">.</span><span class="nx">EnvironmentBlock</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">logln</span><span class="p">(</span><span class="nx">TEB</span><span class="p">.</span><span class="nx">FlsData</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">logln</span><span class="p">(</span><span class="nx">TEB</span><span class="p">.</span><span class="nx">FlsData</span><span class="p">.</span><span class="nx">address</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Which gives:</p>

<figure class='code'><figcaption><span>address property</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>0:000&gt;
</span><span class='line'>[object Object]
</span><span class='line'>2316561115408
</span><span class='line'>0:000&gt; dx @$curthread.Environment.EnvironmentBlock.FlsData
</span><span class='line'>@$curthread.Environment.EnvironmentBlock.FlsData : 0x21b5dcd6910 [Type: void *]
</span></code></pre></td></tr></table></div></figure>


<h3>Evaluate expressions</h3>

<p>Another interesting function I wanted to mention is <code>host.evaluateExpression</code>. As the name suggests, it allows you to evaluate an expression; it is similar to when you use the <code>dx</code> operator but you can only use the language syntax (this means no ‘!’). Any expression you can evaluate through <code>dx</code>, you can evaluate through <code>host.evaluateExpression</code>. The neat thing about this, is that the resulting expression keeps the type information and as a result the Javascript object behaves like the type of the expression.</p>

<p>Here is a small example showing what I am trying to explain:</p>

<figure class='code'><figcaption><span>host.evaluateExpression</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="s2">&quot;use strict&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">let</span> <span class="nx">logln</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">host</span><span class="p">.</span><span class="nx">diagnostics</span><span class="p">.</span><span class="nx">debugLog</span><span class="p">(</span><span class="nx">e</span> <span class="o">+</span> <span class="s1">&#39;\n&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">invokeScript</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">logln</span><span class="p">(</span><span class="nx">host</span><span class="p">.</span><span class="nx">evaluateExpression</span><span class="p">(</span><span class="s1">&#39;(unsigned __int64)0&#39;</span><span class="p">));</span>
</span><span class='line'>    <span class="nx">logln</span><span class="p">(</span><span class="nx">host</span><span class="p">.</span><span class="nx">evaluateExpression</span><span class="p">(</span><span class="s1">&#39;(unsigned __int64*)0&#39;</span><span class="p">));</span>
</span><span class='line'>    <span class="nx">logln</span><span class="p">(</span><span class="nx">host</span><span class="p">.</span><span class="nx">evaluateExpression</span><span class="p">(</span><span class="s1">&#39;(_TEB*)0xb87f4e4000&#39;</span><span class="p">).</span><span class="nx">FlsData</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">logln</span><span class="p">(</span><span class="nx">host</span><span class="p">.</span><span class="nx">evaluateExpression</span><span class="p">(</span><span class="s1">&#39;(_TEB*)0xb87f4e4000&#39;</span><span class="p">).</span><span class="nx">FlsData</span><span class="p">.</span><span class="nx">address</span><span class="p">);</span>
</span><span class='line'>    <span class="k">try</span><span class="p">{</span>
</span><span class='line'>        <span class="nx">logln</span><span class="p">(</span><span class="nx">host</span><span class="p">.</span><span class="nx">evaluateExpression</span><span class="p">(</span><span class="s1">&#39;(unsigned __int64*)0&#39;</span><span class="p">).</span><span class="nx">dereference</span><span class="p">());</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">logln</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="c1">// not valid: @$ is not part of the language - logln(host.evaluateExpression(&#39;@$teb&#39;));</span>
</span><span class='line'>    <span class="c1">// not valid: @rsp is not part of the language - logln(host.evaluateExpression(&#39;(unsigned __int64)@rsp&#39;));</span>
</span><span class='line'>    <span class="c1">// not valid: &#39;!&#39; is not part of the language - logln(host.evaluateExpression(&#39;((ntdll!_TEB*)0)&#39;))</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Resulting in:</p>

<figure class='code'><figcaption><span>host.evaluateExpression examples</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>0:000&gt;
</span><span class='line'>0
</span><span class='line'>[object Object]
</span><span class='line'>[object Object]
</span><span class='line'>2316561115408
</span><span class='line'>Error: Unable to read memory at Address 0x0
</span></code></pre></td></tr></table></div></figure>


<h3>How to access global from modules</h3>

<p>If you need to get access to a global in a specific module, you can use the function <code>host.getModuleSymbol</code> which returns one of those magic Javascript object behaving like a structure. You can check out an example in the following article: <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/native-objects-in-javascript-extensions">Implementation logic for the COM global interface table</a>.</p>

<h1>x64 exception handling vs Javascript</h1>

<p>Phew, you made it to the last part! This one is more about trying to do something useful with all the small little things we have learned throughout this article.</p>

<p>I am sure you guys all already know all of this but Windows revisited how exception handling and frame unwinding work on its 64 bit operating systems. Once upon a time the exception handlers could be found directly onto the stack and they formed some sort of linked list. Today, the compiler encodes every static exception handler at compile / link time into various tables embedded into the final binary image.</p>

<p>Anyway, you might know about Windbg&rsquo;s <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/-exchain">!exchains</a> command that displays the current exception handler chain. This is what the output looks like:</p>

<figure class='code'><figcaption><span>!exchains</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>(9a0.14d4): Access violation - code c0000005 (first chance)
</span><span class='line'>First chance exceptions are reported before any exception handling.
</span><span class='line'>This exception may be expected and handled.
</span><span class='line'>except!Fault+0x3d:
</span><span class='line'>00007ff7`a900179d 48c70001000000  mov     qword ptr [rax],1 ds:00000000`00000001=????????????????
</span><span class='line'>0:000&gt; !exchain
</span><span class='line'>8 stack frames, scanning for handlers...
</span><span class='line'>Frame 0x01: except!main+0x59 (00007ff7`a9001949)
</span><span class='line'>  ehandler except!ILT+900(__GSHandlerCheck_SEH) (00007ff7`a9001389)
</span><span class='line'>Frame 0x03: except!__scrt_common_main_seh+0x127 (00007ff7`a9002327)
</span><span class='line'>  ehandler except!ILT+840(__C_specific_handler) (00007ff7`a900134d)
</span><span class='line'>Frame 0x07: ntdll!RtlUserThreadStart+0x21 (00007ff8`3802efb1)
</span><span class='line'>  ehandler ntdll!_C_specific_handler (00007ff8`38050ef0)
</span></code></pre></td></tr></table></div></figure>


<p>And here is the associated C code:</p>

<figure class='code'><figcaption><span>except.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kr">__declspec</span><span class="p">(</span><span class="n">noinline</span><span class="p">)</span> <span class="kt">void</span> <span class="n">Fault</span><span class="p">(</span><span class="kt">uintptr_t</span> <span class="o">*</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;I&#39;m about to fault!&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="o">*</span><span class="p">(</span><span class="kt">uintptr_t</span><span class="o">*</span><span class="p">)</span><span class="n">x</span><span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kr">__try</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Yo!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="n">Fault</span><span class="p">((</span><span class="kt">uintptr_t</span><span class="o">*</span><span class="p">)</span><span class="n">argc</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="kr">__except</span> <span class="p">(</span><span class="n">Filter</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Exception!&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see, it is not obvious from the dump above to identify the <code>Filter</code> function and the <code>__except</code> code block.</p>

<p>I figured it would be a good exercise to parse those tables (at least partially) from Javascript, expose the information inside the data model, and write a command similar to <code>!exchain</code> &ndash; so let&rsquo;s do it.</p>

<h2>A few words about ImageRuntimeFunctionEntries, UnwindInfos, SehScopeTables and CSpecificHandlerDatas</h2>

<p>Before giving you the script, I would just like to spend a bit of time to give you a brief overview of how this information is encoded and embedded inside a PE32+ binary. Note that I am only interested by x64 binaries coded in C; in other words I am focusing on SEH (<code>__try</code> / <code>__except</code>) as opposed to C++ EH (<code>try</code> / <code>catch</code>).</p>

<p>The first table we need to look at is the <code>ENTRY_EXCEPTION</code> table that resides in the <code>DataDirectory</code> of the <code>OptionalHeader</code>. This directory is an array of <a href="https://docs.microsoft.com/en-us/cpp/build/struct-runtime-function">IMAGE_RUNTIME_FUNCTION_ENTRY</a> that describes the boundary of functions (handy for IDA!) and their unwinding information which is stored at the end of this structure.</p>

<p>The unwinding information is mainly described by the <a href="https://docs.microsoft.com/en-us/cpp/build/struct-unwind-info">UNWIND_INFO</a> structure in which the frame unwinder can find what is necessary to unwind a stack-frame associated to this function. The array of <a href="https://docs.microsoft.com/en-us/cpp/build/struct-unwind-code">UNWIND_CODE</a> structures basically tells you how to do an epilogue.</p>

<p>What follows this array is variable though (documented <a href="https://docs.microsoft.com/en-us/cpp/build/struct-unwind-info">here</a>): if the <code>Flags</code> field of <code>UNWIND_INFO</code> specifies the <code>EHHANDLER</code> flag then we have what I call a <code>UNWIND_INFO_END</code> structure defined like this:</p>

<figure class='code'><figcaption><span>UNWIND_INFO_END</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>0:000&gt; dt UNWIND_INFO_END
</span><span class='line'>   +0x000 ExceptionHandler : Uint4B
</span><span class='line'>   +0x004 ExceptionData    : Uint4B
</span></code></pre></td></tr></table></div></figure>


<p>This is basically where <code>!exchains</code> stops &mdash; the <code>ehhandler</code> address in the output is the <code>ExceptionHandler</code> field. This is basically an RVA to a function that encapsulates the exception handling for this function. This is not to be confused with either your <code>Filter</code> function or your <code>__except</code> block, this is a generic entry-point that the compiler generates and can be used for other functions too. This function is invoked by the exception dispatching / handling code with an argument that is the value of <code>ExceptionData</code>. <code>ExceptionData</code> is basically an RVA to a blob of memory that the <code>ExceptionHandler</code> function knows how to read and takes actions on. This is where the information we are after is stored.</p>

<p>This is also where it was a bit of a surprise to me, as you basically cannot really tell for sure what type of structure is referenced by <code>ExceptionData</code>. For that, you would have to analyze the <code>ExceptionHandler</code> function to understand what and how this data is used. That is also most likely, why the <code>!exchains</code> command stops here and does not bother trying to parse the exception data blob.</p>

<p>Obviously we can easily make an assumption and assume that the <code>ExceptionData</code> is the structure we would like it to be, and verify that it looks right. In addition, the fact that the code you are most likely looking at has been emitted by a well behaved compiler and that the binary has not been tampered with combined have given me good enough results. But keep in mind that in theory, you could place your own function and have your own <code>ExceptionData</code> format in which case reverse-engineering the handler would be mandatory &ndash; in practice this is an unlikely scenario if you are dealing with <em>normal</em> binaries.</p>

<p>The type of <code>ExceptionData</code> that we are interested in is what I call a <code>SEH_SCOPE_TABLE</code> which is an array of <code>SCOPE_RECORD</code>s that are defined like this:</p>

<figure class='code'><figcaption><span>SEH_SCOPE_TABLE</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>0:000&gt; dt SEH_SCOPE_TABLE
</span><span class='line'>  +0x000 Count            : Uint4B
</span><span class='line'>  +0x004 ScopeRecord      : [1] SCOPE_RECORD
</span><span class='line'>0:000&gt; dt SCOPE_RECORD
</span><span class='line'>  +0x000 BeginAddress     : Uint4B
</span><span class='line'>  +0x004 EndAddress       : Uint4B
</span><span class='line'>  +0x008 HandlerAddress   : Uint4B
</span><span class='line'>  +0x00c JumpTarget       : Uint4B
</span></code></pre></td></tr></table></div></figure>


<p><code>BeginAddress</code> and <code>EndAddress</code> give you the <code>__try</code> block RVA, <code>HandlerAddress</code> encodes either the <code>Filter</code> function or the start of the <code>__finally</code> block. The <code>JumpTarget</code> field tells you if you are looking at either a <code>__try / __except</code> or a <code>__try / __finally</code>. Also, the current heuristic I use to know if the <code>SCOPE_RECORD</code> looks legit or not is to ensure that the <code>__try</code> block resides in between the boundaries of the function the handler is defined in. This has been working well so far &ndash; at least on the binaries I have tried it on, but I would not be that surprised if there exists some edge cases to this; if you know any feel free to hit me up!</p>

<h2>Putting it all together</h2>

<p>All right, so now that we sort of know how to dig out the information we are interested in, you can check the script I came up with: <a href="https://github.com/0vercl0k/stuffz/blob/master/windbg-scripts/parse_eh_win64.js">parse_eh_win64.js</a>.</p>

<p>This extends both the <code>Process</code> and the <code>Module</code> models. In both of those models it adds a <code>Functions</code> node as well as a <code>ExceptionHandlers</code> node. Each node under <code>Functions</code> has an <code>ExceptionHandlers</code> node too.</p>

<p>This basically means that you can now:</p>

<ul>
<li>Get every exception handler registered in the process regardless of which module it is coming from (using <code>Process.ExceptionHandlers</code>)</li>
<li>Get every exception handler registered by a specific module (using <code>Module.ExceptionHandlers</code>)</li>
<li>Get every function in the process address space (using <code>Process.Functions</code>)</li>
<li>Get every function in a specific module (using <code>Module.Functions</code>)</li>
<li>Get every exception handler defined by a specific function (using either <code>Module.Functions[x].ExceptionHandlers</code> or <code>Process.Functions[x].ExceptionHandlers</code>)</li>
</ul>


<p>With the same source of information we can easily filter and shape the way we want it displayed through the data model. There is no need to display every exception handler from the <code>Module</code> node as it would not be information related to a <code>Module</code> &mdash; this is why we choose to filter it out and display only the ones concerning this <code>Module</code>. Same thing reasoning applies to <code>Functions</code> as well. The model is something you should explore step by step, it is not something where you have all the available information displayed at once &ndash; it is meant to be scoped and not overwhelming.</p>

<p>And just in case you forgot about it, all this information is now accessible from the command window for query purposes. You can ask things like <em>Which function defines the most exception handlers?</em> very easily:</p>

<figure class='code'><figcaption><span>Which function defines the most exception handlers?</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>0:000&gt; dx @$curprocess.Functions.OrderByDescending(c =&gt; c.ExceptionHandlers.Count()).First()
</span><span class='line'>@$curprocess.Functions.OrderByDescending(c =&gt; c.ExceptionHandlers.Count()).First()                 : RVA:0x7ff83563e170 -&gt; RVA:0x7ff83563e5a2, 12 exception handlers
</span><span class='line'>    EHHandlerRVA     : 0x221d6
</span><span class='line'>    EHHandler        : 0x7ff8356021d6
</span><span class='line'>    BeginRVA         : 0x5e170
</span><span class='line'>    EndRVA           : 0x5e5a2
</span><span class='line'>    Begin            : 0x7ff83563e170
</span><span class='line'>    End              : 0x7ff83563e5a2
</span><span class='line'>    ExceptionHandlers :   __try {0x7ff83563e1d2 -&gt; 0x7ff83563e37a} __finally {0x7ff83563e5a2}...
</span><span class='line'>0:000&gt; u 0x7ff83563e170 l1
</span><span class='line'>KERNEL32!LoadModule:
</span><span class='line'>00007ff8`3563e170 4053            push    rbx
</span></code></pre></td></tr></table></div></figure>


<p>In this example, the function <code>KERNEL32!LoadModule</code> seems to be the function that has registered the largest number of exception handlers (12 of them).</p>

<p>Now that we have this new source of information, we can also push it a bit further and implement a command that does a very similar job than <code>!exchain</code> by just mining information from the nodes we just added to the data model:</p>

<figure class='code'><figcaption><span>!ehhandlers VS !exchain</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>0:000&gt; !ehhandlers
</span><span class='line'>9 stack frames, scanning for handlers...
</span><span class='line'>Frame 0x1: EHHandler: 0x7ff7a9001389: except!ILT+900(__GSHandlerCheck_SEH):
</span><span class='line'>              Except: 0x7ff7a900194b: except!main+0x5b [c:\users\over\documents\blog\except\except\except.c @ 28]:
</span><span class='line'>              Filter: 0x7ff7a9007e60: except!main$filt$0 [c:\users\over\documents\blog\except\except\except.c @ 27]:
</span><span class='line'>Frame 0x3: EHHandler: 0x7ff7a900134d: except!ILT+840(__C_specific_handler):
</span><span class='line'>              Except: 0x7ff7a900235d: except!__scrt_common_main_seh+0x15d [f:\dd\vctools\crt\vcstartup\src\startup\exe_common.inl @ 299]:
</span><span class='line'>              Filter: 0x7ff7a9007ef0: except!`__scrt_common_main_seh&#39;::`1&#39;::filt$0 [f:\dd\vctools\crt\vcstartup\src\startup\exe_common.inl @ 299]:
</span><span class='line'>Frame 0x7: EHHandler: 0x7ff838050ef0: ntdll!_C_specific_handler:
</span><span class='line'>              Except: 0x7ff83802efc7: ntdll!RtlUserThreadStart+0x37:
</span><span class='line'>              Filter: 0x7ff8380684d0: ntdll!RtlUserThreadStart$filt$0:
</span><span class='line'>@$ehhandlers()
</span><span class='line'>
</span><span class='line'>0:000&gt; !exchain
</span><span class='line'>8 stack frames, scanning for handlers...
</span><span class='line'>Frame 0x01: except!main+0x59 (00007ff7`a9001949)
</span><span class='line'>  ehandler except!ILT+900(__GSHandlerCheck_SEH) (00007ff7`a9001389)
</span><span class='line'>Frame 0x03: except!__scrt_common_main_seh+0x127 (00007ff7`a9002327)
</span><span class='line'>  ehandler except!ILT+840(__C_specific_handler) (00007ff7`a900134d)
</span><span class='line'>Frame 0x07: ntdll!RtlUserThreadStart+0x21 (00007ff8`3802efb1)
</span><span class='line'>  ehandler ntdll!_C_specific_handler (00007ff8`38050ef0)
</span></code></pre></td></tr></table></div></figure>


<p>We could even push it a bit more and have our command returns structured data instead of displaying text on the output so that other commands and extensions could build on top of it.</p>

<h1>EOF</h1>

<p>Wow, sounds like you made it to the end :&ndash;) I hope you enjoyed the post and ideally it will allow you to start scripting Windbg with Javascript pretty quickly. I hope to see more people coming up with new scripts and/or tools based on the various technologies I touched on today.
As usual, big thanks to my buddy <a href="https://twitter.com/yrp604">yrp604</a> for proofreading and edits.</p>

<p>If you are still thirsty for more information, here is a collection of links you should probably check out:</p>

<ul>
<li><a href="https://channel9.msdn.com/Shows/Defrag-Tools/Defrag-Tools-170-Debugger-JavaScript-Scripting">Defrag Tools #170 &ndash; Debugger &ndash; JavaScript Scripting</a></li>
<li><a href="https://channel9.msdn.com/Shows/Defrag-Tools/Defrag-Tools-182-WinDbg-Preview-Part-1">Defrag Tools #182 &ndash; WinDbg Preview Part 1</a></li>
<li><a href="https://channel9.msdn.com/Shows/Defrag-Tools/Defrag-Tools-183-WinDbg-Preview-Part-2">Defrag Tools #183 &ndash; WinDbg Preview Part 2</a></li>
<li><a href="https://channel9.msdn.com/Shows/Defrag-Tools/Defrag-Tools-184-JavaScript-in-WinDbg-Preview">Defrag Tools #184 &ndash; JavaScript in WinDbg Preview</a></li>
<li><a href="https://channel9.msdn.com/Shows/Defrag-Tools/Defrag-Tools-185-Time-Travel-Debugging-Introduction">Defrag Tools #185 &ndash; Time Travel Debugging &ndash; Introduction</a></li>
<li><a href="https://channel9.msdn.com/Shows/Defrag-Tools/Defrag-Tools-186-Time-Travel-Debugging-Advanced">Defrag Tools #186 &ndash; Time Travel Debugging &ndash; Advanced</a></li>
<li><a href="http://www.uninformed.org/?v=4&amp;a=1&amp;t=sumry">Improving automated analysis of windows x64 binaries</a></li>
<li><a href="http://www.nynaeve.net/?p=113">Programming against the x64 exception handling support series</a></li>
<li><a href="http://blog.talosintelligence.com/2014/06/exceptional-behavior-windows-81-x64-seh.html">Exceptional behavior: the Windows 8.1 X64 SEH Implementation</a></li>
</ul>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Axel "0vercl0k" Souchet</span></span>

      








  


<time datetime="2017-12-01T06:59:00-08:00" pubdate data-updated="true">Dec 1<span>st</span>, 2017</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/debugging/'>debugging</a>, <a class='category' href='/blog/categories/exception-handling/'>exception handling</a>, <a class='category' href='/blog/categories/javascript/'>javascript</a>, <a class='category' href='/blog/categories/seh/'>seh</a>, <a class='category' href='/blog/categories/time-travel-debugging/'>time-travel debugging</a>, <a class='category' href='/blog/categories/ttd/'>ttd</a>, <a class='category' href='/blog/categories/windbg/'>windbg</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2017/08/05/binary-rewriting-with-syzygy/" title="Previous Post: Binary rewriting with syzygy, Pt. I">&laquo; Binary rewriting with syzygy, Pt. I</a>
      
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2017/12/01/debugger-data-model/">Debugger data model, Javascript & x64 exception handling</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/08/05/binary-rewriting-with-syzygy/">Binary rewriting with syzygy, Pt. I</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/12/21/happy-unikernels/">happy unikernels</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/11/27/clang-and-passes/">Token capture via an llvm-based analysis pass</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/08/18/keygenning-with-klee/">Keygenning with KLEE</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2018 -  Axel Souchet, Jonathan Salwan, Jérémy Fetiveau <br/>
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a> + <a href="https://github.com/ioveracker/mnml">mnml</a>.
	  
  </span>
</p>

</footer>
  












  <script type="text/javascript">
  jQuery(document).ready(function() {
    // Put a TOC right before the entry content.
    if(jQuery('div[id="tocBlock"]').length == 0)
        generateTOC('.entry-content-toc', null);
  });
  </script>

</body>
</html>
